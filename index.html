<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-P2BFCJMQ3Y"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-P2BFCJMQ3Y');
</script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disciplin</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4F46E5">
    <!-- Version for cache busting - UPDATE THIS WHEN MAKING CHANGES -->
    <meta name="app-version" content="3.2.9">
    <link rel="icon" type="image/png" sizes="192x192" href="https://miseducatemen.wordpress.com/wp-content/uploads/2025/07/dp_512x512_1_192x192.jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            /* Light mode colors */
            --bg-primary: #f8f9fa;
            --bg-secondary: white;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --header-bg: linear-gradient(135deg, #6b7280, #4b5563); /* Gray gradient */
            --text-primary: #333;
            --text-secondary: #666;
            --text-muted: #999;
            --border-color: #e9ecef;
            --border-hover: #d1d5db;
            --card-bg: #f8f9fa;
            --input-bg: white;
            --shadow: rgba(0,0,0,0.1);
            --shadow-hover: rgba(0,0,0,0.15);
            --accent-bg: rgba(255,255,255,0.2);
            --accent-hover: rgba(255,255,255,0.3);
            --success-bg: #dcfce7;
            --success-text: #16a34a;
            --error-bg: #fef2f2;
            --error-text: #dc2626;
            --modal-overlay: rgba(0,0,0,0.5);
            --achievement-earned: linear-gradient(135deg, #10b981, #059669);
        }

        [data-theme="dark"] {
            /* Dark mode colors */
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-gradient: linear-gradient(135deg, #4c1d95 0%, #581c87 100%);
            --header-bg: linear-gradient(135deg, #111827, #1f2937); /* Dark gradient */
            --text-primary: #e5e5e5;
            --text-secondary: #b3b3b3;
            --text-muted: #888;
            --border-color: #404040;
            --border-hover: #555;
            --card-bg: #2d2d2d;
            --input-bg: #3a3a3a;
            --shadow: rgba(0,0,0,0.3);
            --shadow-hover: rgba(0,0,0,0.4);
            --accent-bg: rgba(255,255,255,0.1);
            --accent-hover: rgba(255,255,255,0.2);
            --success-bg: #064e3b;
            --success-text: #10b981;
            --error-bg: #7f1d1d;
            --error-text: #f87171;
            --modal-overlay: rgba(0,0,0,0.7);
            --achievement-earned: linear-gradient(135deg, #059669, #047857);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: var(--bg-secondary);
            min-height: 100vh;
            box-shadow: 0 0 20px var(--shadow);
            position: relative;
            transition: all 0.3s ease;
            padding-bottom: 60px;
        }

        .header {
    background: var(--header-bg);
    color: white;
    padding: 20px;
    text-align: center;
    position: relative;
    transition: background 0.3s ease;
}

        .header h1 {
            font-size: 28px;
            font-weight: 600;
        }

        .header-buttons {
            position: absolute;
            top: 10px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .header-buttons.left {
            left: 8px;
        }

        .header-buttons.right {
            right: 8px;
        }

        .header-btn {
            background: var(--accent-bg);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .header-btn:hover {
            background: var(--accent-hover);
        }

        .header-btn i {
    margin-right: 4px;
}

        .header-btn.enabled {
            background: rgba(16, 185, 129, 0.8);
        }

        .dark-mode-toggle {
            background: var(--accent-bg);
            border: none;
            color: white;
            padding: 8px;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .dark-mode-toggle i {
    font-size: 16px;
}

        .dark-mode-toggle:hover {
            background: var(--accent-hover);
            transform: scale(1.1);
        }

        .tabs {
    display: flex;
    background: var(--bg-primary);
    border-top: 1px solid var(--border-color);
    border-bottom: none;
    transition: all 0.3s ease;
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    max-width: 400px;
    width: 100%;
    z-index: 100;
    box-shadow: 0 -2px 10px var(--shadow);
}
      .tab {
    flex: 1;
    padding: 10px 4px;
    text-align: center;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 10px;
    font-weight: 500;
    color: var(--text-secondary);
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
}

.tab-icon {
    font-size: 20px;
    font-weight: 300;
    color: inherit;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
}

.tab.active {
    color: #4F46E5;
}

.tab.active .tab-icon {
    font-weight: 600;
    transform: scale(1.1);
}

.tab br {
    display: none;
}

/* Special styling for question mark */
.tab[data-tab="howto"] .tab-icon {
    border: 2px solid currentColor;
    border-radius: 50%;
    font-size: 14px;
    font-weight: bold;
}

        .tab.active {
            background: var(--bg-secondary);
            color: #4F46E5;
            border-bottom: 2px solid #4F46E5;
        }

        .tab-content {
            display: none;
            padding: 20px;
            background: var(--bg-secondary);
            transition: all 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .motivational-text {
            text-align: center;
            margin: 20px 0;
            font-style: italic;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 500;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.3s ease;
        }

        /* Achievement Badges */
        .achievements-section {
            margin-bottom: 30px;
        }

        .achievements-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .achievement-badge {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .achievement-badge.earned {
            background: var(--achievement-earned);
            border-color: #10b981;
            color: white;
        }

        .achievement-badge.earned:hover {
            transform: scale(1.05);
        }

        .achievement-badge:not(.earned) .achievement-icon {
    color: #666;
    opacity: 0.5;
}

[data-theme="dark"] .achievement-badge:not(.earned) .achievement-icon {
    color: #999;
}

      .achievement-icon {
    font-size: 24px;
    margin-bottom: 5px;
    color: var(--text-secondary);
    transition: color 0.3s ease;
}

        .achievement-text {
            font-size: 10px;
            font-weight: 500;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .achievement-badge.earned .achievement-icon {
    color: white;
}


        /* Analytics Section */
        .analytics-section {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .analytics-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
            text-align: center;
            transition: color 0.3s ease;
        }

        .analytics-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .analytics-card {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .analytics-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .analytics-label {
            font-size: 12px;
            opacity: 0.9;
        }

        /* Weekly Insights */
        .weekly-insights {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .insights-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
            text-align: center;
            transition: color 0.3s ease;
        }

        .insight-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            transition: border-color 0.3s ease;
        }

        .insight-item:last-child {
            border-bottom: none;
        }

        .insight-label {
            font-weight: 500;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }

        .insight-value {
            font-weight: 600;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        /* Backup section */
        .backup-section {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .backup-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
            text-align: center;
            transition: color 0.3s ease;
        }

        .backup-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .backup-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .backup-btn.export {
            background: #10b981;
            color: white;
        }

        .backup-btn.import {
            background: #3b82f6;
            color: white;
        }

        .backup-btn:hover {
            transform: translateY(-1px);
        }

        .file-input {
            width: 100%;
            padding: 10px;
            border: 2px dashed var(--border-hover);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            background: var(--input-bg);
        }

        .file-input:hover {
            border-color: #4F46E5;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-option input[type="radio"] {
            width: 18px;
            height: 18px;
        }

        .radio-option label {
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 10px;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: var(--card-bg);
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .checkbox-option:hover {
            background: var(--border-color);
        }

        .checkbox-option.selected {
            border-color: #4F46E5;
            background: var(--border-color);
        }

        .checkbox-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .checkbox-option label {
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .conditional-question {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 10px;
            border-left: 4px solid #4F46E5;
            transition: all 0.3s ease;
        }

        .conditional-question.show {
            display: block;
        }

        .emoji-selector {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }

        .emoji-btn {
            background: var(--card-bg);
            border: 2px solid transparent;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .emoji-btn:hover, .emoji-btn.selected {
            border-color: #4F46E5;
            background: var(--border-color);
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .form-control:focus {
            outline: none;
            border-color: #4F46E5;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: #4F46E5;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #3730a3;
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .btn.offline {
    background: #9ca3af !important;
    cursor: not-allowed !important;
    opacity: 0.6;
}

.btn.offline:hover {
    background: #9ca3af !important;
    transform: none !important;
}
        
        .streak-notification {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .history-item {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .history-item.selected {
            border-color: #4F46E5;
            background: var(--border-color);
        }

        .history-item-checkbox {
            margin-right: 15px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .history-item-content {
            flex: 1;
        }

        .history-date {
            font-weight: 600;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .history-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-success {
            background: var(--success-bg);
            color: var(--success-text);
        }

        .status-relapse {
            background: var(--error-bg);
            color: var(--error-text);
        }

        .delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        /* History Controls */
        .history-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .history-controls-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .history-controls-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .select-all-btn, .delete-selected-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .select-all-btn {
            background: #4F46E5;
            color: white;
        }

        .select-all-btn:hover {
            background: #3730a3;
        }

        .delete-selected-btn {
            background: #ef4444;
            color: white;
        }

        .delete-selected-btn:hover {
            background: #dc2626;
        }

        .delete-selected-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .selected-count {
            font-size: 14px;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px 0;
        }

        .pagination-info {
            font-size: 14px;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            border-color: #4F46E5;
            color: #4F46E5;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-current {
            font-weight: 600;
            color: #4F46E5;
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-overlay);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 15px;
            max-width: 350px;
            width: 90%;
            text-align: center;
            transition: all 0.3s ease;
        }

        .modal-content h2 {
            margin-bottom: 15px;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .modal-content p {
            margin-bottom: 20px;
            color: var(--text-secondary);
            line-height: 1.5;
            transition: color 0.3s ease;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-btn.primary {
            background: #4F46E5;
            color: white;
        }

        .modal-btn.secondary {
            background: var(--border-color);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ef4444;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .required {
            color: #ef4444;
        }

        .form-hint {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 10px;
            text-align: center;
            transition: color 0.3s ease;
        }

        #fileInput {
            display: none;
        }

        .update-notification {
            background: #3b82f6;
            color: white;
            padding: 15px;
            text-align: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1002;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .update-notification.show {
            transform: translateY(0);
        }

        .update-btn {
            background: white;
            color: #3b82f6;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            margin-left: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        .backup-reminder {
            background: #f59e0b;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            text-align: center;
            font-size: 12px;
        }
    
        .status-container {
            margin-top: 10px;
            font-size: 12px;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }

        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            margin-right: 5px;
            border-radius: 50%;
            background: gray;
            animation: pulse 1.5s infinite;
            vertical-align: middle;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.6; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dark mode specific adjustments */
        [data-theme="dark"] .status-badge.status-success {
            background: var(--success-bg);
            color: var(--success-text);
        }

        [data-theme="dark"] .status-badge.status-relapse {
            background: var(--error-bg);
            color: var(--error-text);
        }

        [data-theme="dark"] .form-control::placeholder {
            color: var(--text-muted);
        }

        [data-theme="dark"] .file-input {
            color: var(--text-secondary);
        }

        /* Responsive adjustments for small screens */
        @media (max-width: 380px) {
            .history-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .history-controls-left,
            .history-controls-right {
                justify-content: center;
                width: 100%;
            }

            .pagination {
                flex-direction: column;
                gap: 10px;
            }

            .pagination-controls {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div id="updateNotification" class="update-notification">
        <div class="backup-reminder">⚠️ Please backup your data before updating!</div>
        <span>New version available!</span>
        <button class="update-btn" onclick="updateApp()">Update Now</button>
        <button class="update-btn" onclick="hideUpdateNotification()" style="background: rgba(255,255,255,0.2); color: white;">Later</button>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-buttons left">
                <button class="header-btn" id="notificationBtn" onclick="toggleNotifications()">🔔 Notify</button>
            </div>
            
            <h1>Disciplin</h1>
            
            <div class="header-buttons right">
                <button class="dark-mode-toggle" id="darkModeToggle" onclick="toggleDarkMode()" title="Toggle Dark Mode">
                    🌙
                </button>
                <button class="header-btn" id="installBtn" style="display: none;">Install App</button>
            </div>

            <div id="connectionStatus" class="status-container">
                <span id="statusIcon" class="status-dot"></span>
                <span id="statusText">Checking...</span>
            </div>
        </div>

        <div class="tabs">
    <button class="tab active" data-tab="home"><span class="tab-icon">●</span><br>Home</button>
    <button class="tab" data-tab="howto"><span class="tab-icon">?</span><br>Guide</button>
    <button class="tab" data-tab="insights"><span class="tab-icon">▲</span><br>Stats</button>
    <button class="tab" data-tab="log"><span class="tab-icon">+</span><br>Log</button>
    <button class="tab" data-tab="history"><span class="tab-icon">≡</span><br>History</button>
    <button class="tab" data-tab="backup"><span class="tab-icon">↕</span><br>Backup</button>
</div>

        <div id="home" class="tab-content active">
            <!-- Analytics Section -->
            <div class="analytics-section">
                <div class="analytics-title">Total Stats</div>
                <div class="analytics-stats">
                    <div class="analytics-card">
                        <div class="analytics-number" id="globalEntries">---</div>
                        <div class="analytics-label">Total Entries</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-number" id="activeUsers">---</div>
                        <div class="analytics-label">Active Users</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 10px; font-size: 12px; color: var(--text-muted); transition: color 0.3s ease;">
                    Real-time data from all Disciplin users
                </div>
            </div>

            <!-- ADD THIS STANDALONE BUTTON HERE -->
            <div style="text-align: center; margin: 20px 0;">
                <button onclick="switchTab('howto')" style="
                    background: #4F46E5;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                " onmouseover="this.style.background='#3730a3'" onmouseout="this.style.background='#4F46E5'">
                    How to use this App
                </button>
            </div>
            <div style="text-align: center; margin: 20px 0;">
                <button onclick="switchTab('resources')" style="
                    background: #ef4444;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                " onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
                    Anti Relapse Button
                </button>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="currentStreak">0</div>
                    <div class="stat-label">Current Streak</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="longestStreak">0</div>
                    <div class="stat-label">Longest Streak</div>
                </div>
            </div>
            <div id="streakNotification" class="streak-notification" style="display: none;"></div>
            <div class="achievements-section">
                <div class="achievements-title"> Achievements</div>
                <div class="achievements-grid" id="achievementsGrid"></div>
            </div>

            <div class="motivational-text" id="motivationalText">
                Everyday is a new day, to achieve something new
            </div>
        </div>

        <div id="howto" class="tab-content">
   <div style="background: var(--card-bg); border-radius: 15px; padding: 20px; margin-bottom: 20px; transition: all 0.3s ease;">
       <h2 style="text-align: center; margin-bottom: 10px; color: #4F46E5; font-size: 22px;">How to Use Disciplin</h2>
       <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary); font-size: 14px; transition: color 0.3s ease;">Version 3.5</p>
       
       <div style="line-height: 1.6; color: var(--text-primary); font-size: 14px; transition: color 0.3s ease;">
           <p style="margin-bottom: 15px;">Disciplin is an offline and online installable web app designed to track masturbation patterns, relapses and streaks depending on what the user logs, it is important to Install the app on your first visit, by clicking on "install app" on the top right corner of the web app.</p>

           <p style="margin-bottom: 15px;">With Disciplin, you can log "entries", these entries contain how your PREVIOUS day went and not your current day, you can only log one entry per day, if you need to log an entry again, you will have to delete the current entry for that day.</p>

           <p style="margin-bottom: 15px;">You can view the history of the entries you have submitted, you can delete each or in bulk depending on your preference.</p>

           <p style="margin-bottom: 15px;">You can view your personal stats, weekly or monthly, this shows you common patterns and with such information, you can adjust your strategy.</p>

           <p style="margin-bottom: 15px;">You can also earn continuous streaks(clean days) if you don't relapse after logging your first entry, there are also achievements to be conquered on your way to personal freedom.</p>

           <p style="margin-bottom: 20px;">You can back up your data whenever you want so as not to lose them incase of app failure or an update.</p>

           <h3 style="color: #4F46E5; font-weight: 600; margin-top: 20px; margin-bottom: 10px;">Features</h3>
           <ul style="margin-left: 20px; margin-bottom: 20px;">
               <li>• Ability to log entries when online only</li>
               <li>• View Entries in History Tab</li>
               <li>• Delete Entries</li>
               <li>• Back up Entries in Back Up Tab</li>
               <li>• View Personal Stats in Stats Tab</li>
               <li>• Streak System</li>
               <li>• Achievements Badges on Home Tab based on clean days, highest being 365 clean days</li>
               <li>• Anti Relapse Button to put you back on track</li>
               <li>• Dark and Light Mode</li>
               <li>• All data is stored on user device, no server is used</li>
           </ul>

           <h3 style="color: #4F46E5; font-weight: 600; margin-top: 20px; margin-bottom: 10px;">Privacy</h3>
           <p style="margin-bottom: 15px;">Since this app deals with personal information, it is important you know how your data is being handle(entries). Disciplin is a client-side("as is") based web app, this means no data is sent to any external servers apart from "entries" total count and "users online" that displays on the home tab, which is anonymous, neither disciplin team or anyone know your actual details in the entries.</p>

           <p style="margin-bottom: 20px;">All data you enter here are saved on your device, this means you will lose your progress if you switch to another device without backing up your data.</p>

           <h3 style="color: #4F46E5; font-weight: 600; margin-top: 20px; margin-bottom: 10px;">Terms of Service</h3>
           <p style="margin-bottom: 20px;">"Disciplin" is a free to use app and can also be used offline as well, however to submit an entry, the user will have to be online, every other feature can be used when offline.</p>

           <h3 style="color: #4F46E5; font-weight: 600; margin-top: 20px; margin-bottom: 10px;">Contact</h3>
           <p style="margin-bottom: 20px;">If you would like to contact us for any partnership, suggestions or complaints(bug reports), please send a mail to <a href="mailto:ifexxy9@gmail.com" style="color: #4F46E5; text-decoration: underline;">ifexxy9@gmail.com</a></p>

           <p style="font-size: 12px; font-style: italic; color: var(--text-muted); margin-top: 20px; text-align: center; transition: color 0.3s ease;">This doc was last updated Wednesday 6th August, 2025</p>
       </div>
   </div>
   
   <div class="motivational-text" id="howtoMotivationalText">
       Everyday is a new day, to achieve something new
   </div>
</div>

        <div id="insights" class="tab-content">
            <div class="weekly-insights">
                <div class="insights-title"> Stats Dashboard</div>
                <div id="weeklyInsights"></div>
            </div>
            

            <div class="motivational-text" id="insightsMotivationalText">
                Everyday is a new day, to achieve something new
            </div>
        </div>

        <div id="log" class="tab-content">
            <div class="motivational-text" id="logMotivationalText">
                Everyday is a new day, to achieve something new
            </div>
            <form id="logForm">
                <div class="form-group">
                    <label>Did you masturbate yesterday? <span class="required">*</span></label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="no" name="masturbated" value="no" required>
                            <label for="no">No</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="yes" name="masturbated" value="yes" required>
                            <label for="yes">Yes</label>
                        </div>
                    </div>

                    <div id="timeQuestion" class="conditional-question">
                        <label>What time of day did you masturbate? (Multiple answers allowed)</label>
                        <div class="checkbox-group">
                            <div class="checkbox-option">
                                <input type="checkbox" id="morning" name="timeOfDay" value="morning">
                                <label for="morning">Morning</label>
                            </div>
                            <div class="checkbox-option">
                                <input type="checkbox" id="afternoon" name="timeOfDay" value="afternoon">
                                <label for="afternoon">Afternoon</label>
                            </div>
                            <div class="checkbox-option">
                                <input type="checkbox" id="evening" name="timeOfDay" value="evening">
                                <label for="evening">Evening</label>
                            </div>
                            <div class="checkbox-option">
                                <input type="checkbox" id="nighttime" name="timeOfDay" value="nighttime">
                                <label for="nighttime">Nighttime</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>How is your energy level today? <span class="required">*</span></label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="low" name="energyLevel" value="Low" required>
                            <label for="low">Low</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="medium" name="energyLevel" value="Medium" required>
                            <label for="medium">Medium</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="high" name="energyLevel" value="High" required>
                            <label for="high">High</label>
                        </div>
                    </div>
                </div><br>
                <div class="form-group">
                    <label>What time did you sleep last night? <span class="required">*</span></label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="before8pm" name="sleepTime" value="Before 8pm" required>
                            <label for="before8pm">Before 8pm</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="8pm11pm" name="sleepTime" value="8pm - 11pm" required>
                            <label for="8pm11pm">8pm - 11pm</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="after12am" name="sleepTime" value="After 12am" required>
                            <label for="after12am">After 12am</label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>How are you feeling today?</label>
                    <div class="emoji-selector">
                        <button type="button" class="emoji-btn" data-mood="😊">😊</button>
                        <button type="button" class="emoji-btn" data-mood="😔">😔</button>
                        <button type="button" class="emoji-btn" data-mood="😤">😤</button>
                        <button type="button" class="emoji-btn" data-mood="💪">💪</button>
                        <button type="button" class="emoji-btn" data-mood="😌">😌</button>
                    </div>
                </div>

                <div class="form-group">
                    <p class="form-hint">If you masturbated, what caused it? (write on the optional notes if any)</p>
                    <label>Optional Notes</label>
                    <textarea class="form-control" id="notes" rows="4" placeholder="Any additional thoughts or triggers..."></textarea>
                </div>

                <button type="submit" class="btn" id="logSubmitBtn">Log Entry</button>
            </form>
        </div>

        <div id="history" class="tab-content">
            <!-- History Controls -->
            <div class="history-controls">
                <div class="history-controls-left">
                    <button class="select-all-btn" id="selectAllBtn" onclick="toggleSelectAll()">
                        Select All
                    </button>
                    <span class="selected-count" id="selectedCount">0 selected</span>
                </div>
                <div class="history-controls-right">
                    <button class="delete-selected-btn" id="deleteSelectedBtn" onclick="deleteSelectedEntries()" disabled>
                        Delete Selected
                    </button>
                </div>
            </div>

            <!-- History List -->
            <div id="historyList"></div>

            <!-- Pagination -->
            <div class="pagination" id="historyPagination">
                <div class="pagination-info" id="paginationInfo">
                    Showing 0 of 0 entries
                </div>
                <div class="pagination-controls">
                    <button class="pagination-btn" id="prevBtn" onclick="previousPage()" disabled>
                        Previous
                    </button>
                    <span class="pagination-current" id="currentPage">1</span>
                    <button class="pagination-btn" id="nextBtn" onclick="nextPage()" disabled>
                        Next
                    </button>
                </div>
            </div>
        </div>

        <div id="backup" class="tab-content">
            <div class="backup-section">
                <div class="backup-title"> Backup & Import</div>
                <p style="margin-bottom: 15px; color: var(--text-secondary); text-align: center; font-size: 14px; transition: color 0.3s ease;">
                    Export your data to keep it safe, or import from a previous backup.
                </p>
                
                <div class="backup-buttons">
                    <button class="backup-btn export" onclick="exportData()"> Export Data</button>
                    <button class="backup-btn import" onclick="document.getElementById('fileInput').click()"> Import Data</button>
                </div>

                <input type="file" id="fileInput" accept=".json" onchange="importData(event)">
                
                <div class="file-input" onclick="document.getElementById('fileInput').click()">
                    Click here or use the Import button to select your backup file
                </div>
            </div>

            <div class="motivational-text">
                Keep your progress safe with regular backups
            </div>
        </div>

        <div id="resources" class="tab-content">
            <div style="background: var(--card-bg); border-radius: 15px; padding: 20px; margin-bottom: 20px; transition: all 0.3s ease;">
                <h2 style="text-align: center; margin-bottom: 20px; color: #4F46E5; font-size: 22px;">Welcome to Resources Docs</h2>
                <div style="line-height: 1.6; color: var(--text-primary); font-size: 14px; transition: color 0.3s ease;">
                    <p style="margin-bottom: 20px;">If you feel the urge to relapse when you have committed to this app, please turn off your internet connection, open this app and read this docs.</p>

                    <h3 style="color: #4F46E5; font-weight: 600; margin-top: 20px; margin-bottom: 10px;">Does Masturbation have an effect on you?</h3>
                    <p style="margin-bottom: 15px;">Science have always stated that masturbation is healthy but we that masturbate know it has alot of negative effects on us—prior to when we didn't masturbate, we were active, being productive, higher levels of energy and so on.</p>
                    <p style="margin-bottom: 15px;">But when we started the act, a shift happened, it was noticeable but we bluff it off, we started being inactive, lazy, procrastinating little things, having bad memories, brain rot and objectifying people.</p>
                    <p style="margin-bottom: 20px;">You don't need a prophet to tell you that you have a problem, and since you're here—it is because you want a change, a change that will better your lifestyle, your communication skills and your relationship, whatever it may be. This is why this resource docs is helpful especially in the time of wanting to "jerk" off.</p>

                    <h3 style="color: #4F46E5; font-weight: 600; margin-top: 20px; margin-bottom: 10px;">Dangers of Masturbation</h3>
                    <p style="margin-bottom: 15px;">As someone who masturbates, it's self explanatory what the dangers are, writing it here again will make no difference, so rather what you should know is the benefits of not masturbating, which includes but not limited to;</p>
                    <ul style="margin-left: 20px; margin-bottom: 15px;">
                        <li>• Higher Energy levels</li>
                        <li>• Good Mood</li>
                        <li>• Less Objectification</li>
                        <li>• Relaxed Sleep</li>
                        <li>• Productive</li>
                        <li>• Open Mind</li>
                    </ul>
                    <p style="margin-bottom: 15px;">There are many more developments you would see when you start abstaining from masturbation, never follow those who tell you masturbation has nothing to do with your laziness, your bad grades, your unproductive lifestyle, as long as you're a chronic jerker, you have a problem.</p>
                    <p style="margin-bottom: 20px;">Now that you're done reading, if you still have the urge, then keep down your phone and find something else to do, better still go out and take a walk, or if it's at night, sleep.</p>
                </div>
            </div>
            
            <div class="motivational-text" id="resourcesMotivationalText">
                Everyday is a new day, to achieve something new
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="welcomeModal" class="modal">
        <div class="modal-content">
            <h2>Welcome to Disciplin</h2>
            <p>First time? Please install the app by clicking on "Install App" to enjoy full offline capabilities. Disciplin ia an app for tracking compulsive sexual behavior, such as masturbation and porn addiction, you can track your patterns, keep records and earn streaks, please click "How to use this app" to learn more.</p>
            <button class="modal-btn primary" onclick="closeWelcomeModal()">Continue</button>
        </div>
    </div>

    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h2>Delete Entry</h2>
            <p>Are you sure you want to delete this entry? This action cannot be undone.</p>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="modal-btn primary" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <div id="deleteSelectedModal" class="modal">
        <div class="modal-content">
            <h2>Delete Selected Entries</h2>
            <p id="deleteSelectedText">Are you sure you want to delete the selected entries? This action cannot be undone.</p>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeDeleteSelectedModal()">Cancel</button>
                <button class="modal-btn primary" onclick="confirmDeleteSelected()">Delete All</button>
            </div>
        </div>
    </div>

    <div id="notificationModal" class="modal">
        <div class="modal-content">
            <h2>Enable Notifications</h2>
            <p>Get reminded to check in with your progress if you haven't opened the app in 6 hours. This helps maintain consistency in your journey.</p>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeNotificationModal()">Cancel</button>
                <button class="modal-btn primary" onclick="enableNotifications()">Enable</button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <!-- Analytics Integration Script -->
    <script>
        // Analytics integration for Disciplin app
        class DisciplinAnalytics {
            constructor() {
                // Configuration
                this.config = {
                    backendUrl: 'https://disciplinback-production.up.railway.app', // Your Railway backend URL
                    enabled: true, // Set to false to disable analytics
                    heartbeatInterval: 5 * 60 * 1000, // 5 minutes
                    retryAttempts: 3,
                    retryDelay: 1000,
                    fetchInterval: 30 * 1000 // 30 seconds for fetching global stats
                };
                
                // State
                this.userId = null;
                this.sessionId = null;
                this.heartbeatTimer = null;
                this.fetchTimer = null;
                this.isOnline = navigator.onLine;
                this.pendingRequests = [];
                
                this.init();
            }
            
            async init() {
                if (!this.config.enabled) return;
                
                try {
                    // Get or create user ID from localStorage
                    this.userId = localStorage.getItem('disciplin_user_id');
                    
                    await this.initSession();
                    this.startHeartbeat();
                    this.startFetchingStats();
                    this.setupEventListeners();
                    
                    console.log('📊 Disciplin Analytics initialized');
                } catch (error) {
                    console.warn('Analytics initialization failed:', error);
                }
            }
            
            async initSession() {
                try {
                    const response = await this.makeRequest('/api/init-session', {
                        method: 'POST',
                        body: JSON.stringify({
                            userId: this.userId
                        })
                    });
                    
                    if (response.success) {
                        this.userId = response.userId;
                        this.sessionId = response.sessionId;
                        
                        // Store user ID for future sessions
                        localStorage.setItem('disciplin_user_id', this.userId);
                        
                        console.log('📊 Session initialized:', this.sessionId);
                    }
                } catch (error) {
                    console.warn('Failed to initialize session:', error);
                }
            }
            
            async trackEntry(entryCount = 1, entryType = 'log', metadata = {}) {
                if (!this.config.enabled || !this.userId) return;
                
                try {
                    const response = await this.makeRequest('/api/track-entry', {
                        method: 'POST',
                        body: JSON.stringify({
                            userId: this.userId,
                            sessionId: this.sessionId,
                            entryCount,
                            entryType,
                            metadata: {
                                ...metadata,
                                timestamp: new Date().toISOString(),
                                userAgent: navigator.userAgent,
                                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                            }
                        })
                    });
                    
                    if (response.success) {
                        console.log('📊 Entry tracked:', entryCount, entryType);
                        // Immediately fetch updated stats
                        this.fetchGlobalStats();
                    }
                } catch (error) {
                    console.warn('Failed to track entry:', error);
                    // Queue for retry when online
                    this.queueRequest('trackEntry', arguments);
                }
            }
            
            async sendHeartbeat() {
                if (!this.config.enabled || !this.userId) return;
                
                try {
                    const response = await this.makeRequest('/api/heartbeat', {
                        method: 'POST',
                        body: JSON.stringify({
                            userId: this.userId,
                            sessionId: this.sessionId
                        })
                    });
                    
                    if (response.success) {
                        console.log('💓 Heartbeat sent');
                    }
                } catch (error) {
                    console.warn('Heartbeat failed:', error);
                }
            }
            
            async fetchGlobalStats() {
                if (!this.config.enabled) return;
                
                try {
                    const response = await this.makeRequest('/api/analytics', {
                        method: 'GET'
                    });
                    
                    if (response.success && response.data) {
                        this.updateGlobalStatsUI(response.data);
                        console.log('📊 Global stats updated');
                    }
                } catch (error) {
                    console.warn('Failed to fetch global stats:', error);
                }
            }
            
            updateGlobalStatsUI(data) {
                const globalEntriesEl = document.getElementById('globalEntries');
                const activeUsersEl = document.getElementById('activeUsers');
                
                if (globalEntriesEl && data.totalEntries !== undefined) {
                    // Animate number change
                    this.animateNumber(globalEntriesEl, parseInt(globalEntriesEl.textContent) || 0, data.totalEntries);
                }
                
                if (activeUsersEl && data.activeUsers !== undefined) {
                    this.animateNumber(activeUsersEl, parseInt(activeUsersEl.textContent) || 0, data.activeUsers);
                }
            }
            
            animateNumber(element, from, to) {
                const duration = 1000; // 1 second
                const steps = 30;
                const stepValue = (to - from) / steps;
                let current = from;
                let step = 0;
                
                const timer = setInterval(() => {
                    step++;
                    current += stepValue;
                    
                    if (step >= steps) {
                        current = to;
                        clearInterval(timer);
                    }
                    
                    element.textContent = Math.round(current);
                }, duration / steps);
            }
            
            async makeRequest(endpoint, options = {}) {
                const url = `${this.config.backendUrl}${endpoint}`;
                
                const defaultOptions = {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    timeout: 10000
                };
                
                for (let attempt = 0; attempt < this.config.retryAttempts; attempt++) {
                    try {
                        const response = await fetch(url, { ...defaultOptions, ...options });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        return await response.json();
                    } catch (error) {
                        console.warn(`Request attempt ${attempt + 1} failed:`, error);
                        
                        if (attempt < this.config.retryAttempts - 1) {
                            await this.delay(this.config.retryDelay * Math.pow(2, attempt));
                        } else {
                            throw error;
                        }
                    }
                }
            }
            
            startHeartbeat() {
                if (this.heartbeatTimer) {
                    clearInterval(this.heartbeatTimer);
                }
                
                this.heartbeatTimer = setInterval(() => {
                    this.sendHeartbeat();
                }, this.config.heartbeatInterval);
                
                // Send initial heartbeat
                this.sendHeartbeat();
            }
            
            startFetchingStats() {
                if (this.fetchTimer) {
                    clearInterval(this.fetchTimer);
                }
                
                // Fetch stats immediately
                this.fetchGlobalStats();
                
                // Then fetch every 30 seconds
                this.fetchTimer = setInterval(() => {
                    this.fetchGlobalStats();
                }, this.config.fetchInterval);
            }
            
            stopHeartbeat() {
                if (this.heartbeatTimer) {
                    clearInterval(this.heartbeatTimer);
                    this.heartbeatTimer = null;
                }
            }
            
            stopFetchingStats() {
                if (this.fetchTimer) {
                    clearInterval(this.fetchTimer);
                    this.fetchTimer = null;
                }
            }
            
            setupEventListeners() {
                // Track online/offline status
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    console.log('📊 Back online - processing queued requests');
                    this.processPendingRequests();
                    this.startHeartbeat();
                    this.startFetchingStats();
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    console.log('📊 Offline - queuing requests');
                    this.stopHeartbeat();
                    this.stopFetchingStats();
                });
                
                // Track page visibility changes
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.stopHeartbeat();
                        this.stopFetchingStats();
                    } else {
                        this.startHeartbeat();
                        this.startFetchingStats();
                    }
                });
                
                // Track app being closed
                window.addEventListener('beforeunload', () => {
                    this.stopHeartbeat();
                    this.stopFetchingStats();
                });
            }
            
            queueRequest(method, args) {
                this.pendingRequests.push({ method, args, timestamp: Date.now() });
                
                // Limit queue size
                if (this.pendingRequests.length > 50) {
                    this.pendingRequests = this.pendingRequests.slice(-25);
                }
            }
            
            async processPendingRequests() {
                if (!this.isOnline || this.pendingRequests.length === 0) return;
                
                const requests = [...this.pendingRequests];
                this.pendingRequests = [];
                
                for (const request of requests) {
                    try {
                        // Skip old requests (older than 1 hour)
                        if (Date.now() - request.timestamp > 60 * 60 * 1000) {
                            continue;
                        }
                        
                        if (request.method === 'trackEntry') {
                            await this.trackEntry(...request.args);
                        }
                        
                        // Small delay between requests
                        await this.delay(100);
                    } catch (error) {
                        console.warn('Failed to process pending request:', error);
                    }
                }
            }
            
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            // Public methods for integration
            disable() {
                this.config.enabled = false;
                this.stopHeartbeat();
                this.stopFetchingStats();
                console.log('📊 Analytics disabled');
            }
            
            enable() {
                this.config.enabled = true;
                this.init();
                console.log('📊 Analytics enabled');
            }
        }

        // Initialize analytics globally
        let disciplinAnalytics = null;
        
        function initAnalytics() {
            if (!disciplinAnalytics) {
                disciplinAnalytics = new DisciplinAnalytics();
            }
        }

        // Integration functions for existing app
        function trackFormSubmission(entry) {
            if (disciplinAnalytics) {
                disciplinAnalytics.trackEntry(1, 'log_entry', {
                    masturbated: entry.masturbated,
                    hasNotes: !!entry.notes,
                    timeOfDay: entry.timeOfDay,
                    energy: entry.energy,
                    mood: entry.mood
                });
            }
        }

        function trackDataExport() {
            if (disciplinAnalytics) {
                disciplinAnalytics.trackEntry(0, 'data_export', {
                    action: 'export'
                });
            }
        }

        function trackDataImport() {
            if (disciplinAnalytics) {
                disciplinAnalytics.trackEntry(0, 'data_import', {
                    action: 'import'
                });
            }
        }

        function trackTabSwitch(tabName) {
            if (disciplinAnalytics) {
                disciplinAnalytics.trackEntry(1, 'tab_switch', {
                    tab: tabName
                });
            }
        }
    </script>

    <script>
        // App version for cache busting - IMPORTANT: UPDATE THIS WHEN MAKING CHANGES
        const APP_VERSION = '3.2.21';
        
        // History pagination variables
        let currentHistoryPage = 1;
        let entriesPerPage = 10;
        let selectedEntries = new Set();
        let allEntries = [];
        
        // Dark Mode functionality
        function initializeDarkMode() {
            const savedTheme = localStorage.getItem('disciplin_theme') || 'light';
            const darkModeToggle = document.getElementById('darkModeToggle');
            
            // Apply saved theme
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateDarkModeToggle(savedTheme);
            
            // Also update the theme-color meta tag
            updateThemeColor(savedTheme);
        }

        function toggleDarkMode() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('disciplin_theme', newTheme);
            updateDarkModeToggle(newTheme);
            updateThemeColor(newTheme);
            
            // Track this as user activity
            trackActivity();
            
            // Show a subtle notification
            showNotification(`Switched to ${newTheme} mode`, 'success');
        }

        function updateDarkModeToggle(theme) {
    const darkModeToggle = document.getElementById('darkModeToggle');
    if (darkModeToggle) {
        if (theme === 'dark') {
            darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            darkModeToggle.title = 'Switch to Light Mode';
        } else {
            darkModeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            darkModeToggle.title = 'Switch to Dark Mode';
        }
    }
}

        function updateThemeColor(theme) {
            const themeColorMeta = document.querySelector('meta[name="theme-color"]');
            if (themeColorMeta) {
                themeColorMeta.content = theme === 'dark' ? '#2d2d2d' : '#4F46E5';
            }
        }

        // Hybrid Service Worker Registration - tries external file first, falls back to inline
        if ('serviceWorker' in navigator) {
            // Try to register external service worker first
            navigator.serviceWorker.register('service-worker.js')
                .then(registration => {
                    console.log('External Service Worker registered successfully');
                    setupServiceWorkerHandlers(registration);
                })
                .catch(error => {
                    console.log('Inline Service Worker registration failed:', error);
                });
        }

        // Hybrid Manifest approach - try external first, fallback to inline
        function setupManifest() {
            // Check if external manifest.json exists
            fetch('manifest.json')
                .then(response => {
                    if (response.ok) {
                        console.log('Using external manifest.json');
                        // External manifest exists, use it (already linked in HTML)
                    } else {
                        throw new Error('External manifest not found');
                    }
                })
                .catch(() => {
                    console.log('External manifest not found, using inline version');
                    // Create inline manifest as fallback
                    const manifest = {
                        "name": "Disciplin",
                        "short_name": "Disciplin", 
                        "description": "Personal habit tracking app with notifications",
                        "start_url": "./",
                        "display": "standalone",
                        "background_color": "#4F46E5",
                        "theme_color": "#4F46E5",
                        "orientation": "portrait",
                        "scope": "./",
                        "icons": [
                            {
                                "src": "https://miseducatemen.wordpress.com/wp-content/uploads/2025/07/dp_512x512_1_192x192.jpg",
                                "sizes": "192x192",
                                "type": "image/png",
                                "purpose": "any maskable"
                            },
                            {
                                "src": "https://miseducatemen.wordpress.com/wp-content/uploads/2025/07/dp_512x512.jpg",
                                "sizes": "512x512", 
                                "type": "image/png",
                                "purpose": "any maskable"
                            }
                        ],
                        "categories": ["productivity", "health", "lifestyle"],
                        "lang": "en-US",
                        "dir": "ltr"
                    };

                    const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
                    const manifestURL = URL.createObjectURL(manifestBlob);
                    
                    // Update the manifest link to use inline version
                    const manifestLink = document.querySelector('link[rel="manifest"]');
                    if (manifestLink) {
                        manifestLink.href = manifestURL;
                    }
                });
        }

        // Initialize manifest setup
        setupManifest();

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js').then(reg => {
                reg.onupdatefound = () => {
                    const installingWorker = reg.installing;
                    installingWorker.onstatechange = () => {
                        if (installingWorker.state === 'installed') {
                            if (navigator.serviceWorker.controller) {
                                // New content is available
                                const userConfirmed = confirm("A new update is available. Please backup your entries and refresh to update.");
                                if (userConfirmed) {
                                    reg.waiting.postMessage({ type: 'SKIP_WAITING' });
                                    window.location.reload();
                                }
                            }
                        }
                    };
                };
            }).catch(err => {
                console.log('External Service Worker registration failed, inline version will be used:', err);
            });
        }

        // App State
        let currentMood = '';
        let deleteEntryId = null;
        let selectedEntriesToDelete = [];
        let deferredPrompt = null;
        let notificationPermission = false;
        let inactivityTimer = null;

        // Achievement definitions
        const achievements = [
    { id: 'first_day', icon: '<i class="fas fa-seedling"></i>', text: 'First Day', condition: (streak) => streak >= 1 },
    { id: 'three_days', icon: '<i class="fas fa-fire"></i>', text: '3 Days Strong', condition: (streak) => streak >= 3 },
    { id: 'week_warrior', icon: '<i class="fas fa-bolt"></i>', text: 'Week Warrior', condition: (streak) => streak >= 7 },
    { id: 'two_weeks', icon: '<i class="fas fa-rocket"></i>', text: 'Two Weeks', condition: (streak) => streak >= 14 },
    { id: 'month_master', icon: '<i class="fas fa-medal"></i>', text: 'Month Master', condition: (streak) => streak >= 30 },
    { id: 'quarter_champion', icon: '<i class="fas fa-gem"></i>', text: 'Quarter Champion', condition: (streak) => streak >= 90 },
    { id: 'six_months', icon: '<i class="fas fa-crown"></i>', text: 'Half Year King', condition: (streak) => streak >= 180 },
    { id: 'year_legend', icon: '<i class="fas fa-trophy"></i>', text: 'Year Legend', condition: (streak) => streak >= 365 }
];

        // Motivational texts
        const motivationalTexts = [
            "Everyday is a new day, to achieve something new",
            "Every urge resisted is a win",
            "Progress is Progress no matter how small"
        ];

        // Notification messages
        const notificationMessages = [
            "Time to check in with your progress! 💪",
            "Remember your goals - how are you doing today? 🎯",
            "Your streak is waiting for you to log today's progress! 🔥",
            "Stay consistent - check in with Disciplin now! 📈",
            "Don't break the chain - log your daily progress! ⛓️"
        ];

        // History pagination functions
        function loadHistory() {
            allEntries = getEntries().sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            selectedEntries.clear();
            updateSelectedCount();
            currentHistoryPage = 1;
            renderHistoryPage();
        }

        function renderHistoryPage() {
            const historyList = document.getElementById('historyList');
            const totalEntries = allEntries.length;

            if (totalEntries === 0) {
                historyList.innerHTML = `
                    <div class="empty-state">
                        <h3>No entries yet</h3>
                        <p>Start logging your daily activities to see your history here.</p>
                    </div>
                `;
                updatePaginationInfo(0, 0, 0);
                return;
            }

            const startIndex = (currentHistoryPage - 1) * entriesPerPage;
            const endIndex = Math.min(startIndex + entriesPerPage, totalEntries);
            const entriesForPage = allEntries.slice(startIndex, endIndex);

            historyList.innerHTML = entriesForPage.map(entry => `
                <div class="history-item ${selectedEntries.has(entry.id) ? 'selected' : ''}">
                    <input type="checkbox" 
                           class="history-item-checkbox" 
                           ${selectedEntries.has(entry.id) ? 'checked' : ''}
                           onchange="toggleEntrySelection(${entry.id}, this.checked)">
                    <div class="history-item-content">
                        <div class="history-date">${new Date(entry.timestamp).toLocaleDateString()}</div>
                        <div class="history-status">
                            <span class="status-badge ${entry.masturbated ? 'status-relapse' : 'status-success'}">
                                ${entry.masturbated ? 'Relapsed' : 'Clean Day'}
                            </span>
                            ${entry.mood ? entry.mood : ''}
                        </div>
                        ${entry.energy ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 3px; transition: color 0.3s ease;">Energy: ${entry.energy}</div>` : ''}
                        ${entry.timeOfDay && entry.timeOfDay.length > 0 ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 3px; transition: color 0.3s ease;">Time: ${entry.timeOfDay.join(', ')}</div>` : ''}
                        ${entry.sleepTime ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 3px; transition: color 0.3s ease;">Sleep: ${entry.sleepTime}</div>` : ''}
                        ${entry.notes ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px; transition: color 0.3s ease;">${entry.notes}</div>` : ''}
                    </div>
                    <button class="delete-btn" onclick="showDeleteModal(${entry.id})">Delete</button>
                </div>
            `).join('');

            updatePaginationInfo(startIndex + 1, endIndex, totalEntries);
            updatePaginationButtons();
        }

        function updatePaginationInfo(start, end, total) {
            const paginationInfo = document.getElementById('paginationInfo');
            if (total === 0) {
                paginationInfo.textContent = 'No entries found';
            } else {
                paginationInfo.textContent = `Showing ${start}-${end} of ${total} entries`;
            }
        }

        function updatePaginationButtons() {
            const totalPages = Math.ceil(allEntries.length / entriesPerPage);
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const currentPageSpan = document.getElementById('currentPage');

            prevBtn.disabled = currentHistoryPage <= 1;
            nextBtn.disabled = currentHistoryPage >= totalPages;
            currentPageSpan.textContent = `${currentHistoryPage} of ${totalPages}`;
        }

        function previousPage() {
            if (currentHistoryPage > 1) {
                currentHistoryPage--;
                renderHistoryPage();
                trackActivity();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(allEntries.length / entriesPerPage);
            if (currentHistoryPage < totalPages) {
                currentHistoryPage++;
                renderHistoryPage();
                trackActivity();
            }
        }

        // Multiple selection functions
        function toggleEntrySelection(entryId, isSelected) {
            const historyItem = event.target.closest('.history-item');
            
            if (isSelected) {
                selectedEntries.add(entryId);
                historyItem.classList.add('selected');
            } else {
                selectedEntries.delete(entryId);
                historyItem.classList.remove('selected');
            }
            
            updateSelectedCount();
            updateSelectAllButton();
            trackActivity();
        }

        function toggleSelectAll() {
            const startIndex = (currentHistoryPage - 1) * entriesPerPage;
            const endIndex = Math.min(startIndex + entriesPerPage, allEntries.length);
            const entriesForPage = allEntries.slice(startIndex, endIndex);
            
            const allPageEntriesSelected = entriesForPage.every(entry => selectedEntries.has(entry.id));
            
            entriesForPage.forEach(entry => {
                if (allPageEntriesSelected) {
                    selectedEntries.delete(entry.id);
                } else {
                    selectedEntries.add(entry.id);
                }
            });
            
            renderHistoryPage();
            updateSelectedCount();
            updateSelectAllButton();
            trackActivity();
        }

        function updateSelectedCount() {
            const selectedCount = document.getElementById('selectedCount');
            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            
            selectedCount.textContent = `${selectedEntries.size} selected`;
            deleteSelectedBtn.disabled = selectedEntries.size === 0;
        }

        function updateSelectAllButton() {
            const selectAllBtn = document.getElementById('selectAllBtn');
            const startIndex = (currentHistoryPage - 1) * entriesPerPage;
            const endIndex = Math.min(startIndex + entriesPerPage, allEntries.length);
            const entriesForPage = allEntries.slice(startIndex, endIndex);
            
            const allPageEntriesSelected = entriesForPage.length > 0 && 
                                         entriesForPage.every(entry => selectedEntries.has(entry.id));
            
            selectAllBtn.textContent = allPageEntriesSelected ? 'Deselect All' : 'Select All';
        }

        function deleteSelectedEntries() {
            if (selectedEntries.size === 0) return;
            
            selectedEntriesToDelete = Array.from(selectedEntries);
            const deleteText = document.getElementById('deleteSelectedText');
            deleteText.textContent = `Are you sure you want to delete ${selectedEntriesToDelete.length} selected entries? This action cannot be undone.`;
            
            document.getElementById('deleteSelectedModal').classList.add('show');
        }

        function closeDeleteSelectedModal() {
            document.getElementById('deleteSelectedModal').classList.remove('show');
            selectedEntriesToDelete = [];
        }

        function confirmDeleteSelected() {
            if (selectedEntriesToDelete.length === 0) return;
            
            const entries = getEntries().filter(entry => !selectedEntriesToDelete.includes(entry.id));
            localStorage.setItem('disciplin_entries', JSON.stringify(entries));
            
            selectedEntries.clear();
            selectedEntriesToDelete = [];
            closeDeleteSelectedModal();
            
            // Refresh all views
            loadHistory();
            updateStats();
            updateAchievements();
            updateWeeklyInsights();
            updateStreakNotification();
            
            trackActivity();
            showNotification(`${selectedEntriesToDelete.length || 'Selected'} entries deleted successfully!`, 'success');
            alert(`✅ ${selectedEntriesToDelete.length || 'Selected'} entries deleted successfully!`);
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeDarkMode(); // Initialize dark mode first
            initAnalytics(); // Initialize analytics
            checkForUpdates();
            initializeApp();
            setupEventListeners();
            updateStats();
            loadHistory();
            updateAchievements();
            updateWeeklyInsights();
            showWelcomeModal();
            rotateMotiationTexts();
            initializeNotifications();
            setupInactivityTimer();
        });

        // Fixed version checking function
        function checkForUpdates() {
            const storedVersion = localStorage.getItem('disciplin_version');
            console.log('Stored version:', storedVersion, 'Current version:', APP_VERSION);
            
            // Only show update notification if there's a stored version and it's different
            if (storedVersion && storedVersion !== APP_VERSION) {
                console.log('New version detected, showing update notification');
                // Show update notification after a short delay
                setTimeout(() => {
                    showUpdateNotification();
                }, 1000);
            } else if (!storedVersion) {
                // First time user, set the version
                localStorage.setItem('disciplin_version', APP_VERSION);
            }
        }

        function showUpdateNotification() {
            const updateNotification = document.getElementById('updateNotification');
            updateNotification.classList.add('show');
        }

        function hideUpdateNotification() {
            const updateNotification = document.getElementById('updateNotification');
            updateNotification.classList.remove('show');
        }

        function updateApp() {
            // Show confirmation with backup reminder
            const hasEntries = getEntries().length > 0;
            let confirmMessage = 'This will update the app and may clear your cache. ';
            
            if (hasEntries) {
                confirmMessage += 'IMPORTANT: Make sure you have backed up your data from the Backup tab before proceeding. Continue with update?';
            } else {
                confirmMessage += 'Continue with update?';
            }
            
            if (confirm(confirmMessage)) {
                // Clear all caches
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => {
                            caches.delete(name);
                        });
                    });
                }
                
                // Update the stored version
                localStorage.setItem('disciplin_version', APP_VERSION);
                
                // Hide update notification
                hideUpdateNotification();
                
                // Force reload with cache bypass
                window.location.reload(true);
            }
        }

        function initializeNotifications() {
            // Check notification permission status
            if ('Notification' in window) {
                const permission = Notification.permission;
                const isEnabled = localStorage.getItem('disciplin_notifications') === 'true';
                
                if (permission === 'granted' && isEnabled) {
                    notificationPermission = true;
                    updateNotificationButton(true);
                } else {
                    updateNotificationButton(false);
                }
            }
        }

        function updateNotificationButton(enabled) {
    const btn = document.getElementById('notificationBtn');
    if (enabled) {
        btn.classList.add('enabled');
        btn.innerHTML = '<i class="fas fa-bell"></i> Enabled';
    } else {
        btn.classList.remove('enabled');
        btn.innerHTML = '<i class="far fa-bell-slash"></i> Enable Alerts';
    }
}

        function toggleNotifications() {
            if (notificationPermission) {
                // Disable notifications
                notificationPermission = false;
                localStorage.setItem('disciplin_notifications', 'false');
                updateNotificationButton(false);
                clearInactivityTimer();
                showNotification('Notifications disabled', 'success');
            } else {
                // Show notification modal
                document.getElementById('notificationModal').classList.add('show');
            }
        }

        function closeNotificationModal() {
            document.getElementById('notificationModal').classList.remove('show');
        }

        function enableNotifications() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        notificationPermission = true;
                        localStorage.setItem('disciplin_notifications', 'true');
                        updateNotificationButton(true);
                        setupInactivityTimer();
                        closeNotificationModal();
                        showNotification('Notifications enabled!', 'success');
                        
                        // Show a test notification
                        setTimeout(() => {
                            showPushNotification('Notifications are now active! 🎉');
                        }, 1000);
                    } else {
                        showNotification('Notification permission denied');
                        closeNotificationModal();
                    }
                });
            } else {
                showNotification('Notifications not supported in this browser');
                closeNotificationModal();
            }
        }

        function showPushNotification(message = null) {
            if (!notificationPermission || !('Notification' in window)) return;
            
            const randomMessage = message || notificationMessages[Math.floor(Math.random() * notificationMessages.length)];
            
            const notification = new Notification('Disciplin', {
                body: randomMessage,
                icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiM0RjQ2RTUiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiPgo8cGF0aCBkPSJtOSAxMiAyIDIgNC00Ii8+CjxwYXRoIGQ9Im0yMSAyMS0xLTFhNy43NCA3Ljc0IDAgMCAwIDAtMTBsMS0xYTEgMSAwIDAgMCAwLTEuNDFsLTUtNWExIDEgMCAwIDAtMS40MSAwbC0xIDFhNy43NCA3Ljc0IDAgMCAwLTEwIDBsLTEtMWExIDEgMCAwIDAtMS40MSAwbC01IDVhMSAxIDAgMCAwIDAgMS40MWwxIDFhNy43NCA3Ljc0IDAgMCAwIDAgMTBsLTEgMWExIDEgMCAwIDAgMCAxLjQxbDUgNWExIDEgMCAwIDAgMS40MSAwbDEtMWE3Ljc0IDcuNzQgMCAwIDAgMTAgMGwxIDFhMSAxIDAgMCAwIDEuNDEgMGw1LTVhMSAxIDAgMCAwIDAtMS40MVoiLz4KPC9zdmc+Cjwvc3ZnPg==',
                badge: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzIiIGhlaWdodD0iNzIiIHZpZXdCb3g9IjAgMCA3MiA3MiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjcyIiBoZWlnaHQ9IjcyIiByeD0iMTIiIGZpbGw9IiM0RjQ2RTUiLz4KPHN2ZyB4PSIxOCIgeT0iMTgiIHdpZHRoPSIzNiIgaGVpZ2h0PSIzNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiPgo8cGF0aCBkPSJtOSAxMiAyIDIgNC00Ii8+CjxwYXRoIGQ9Im0yMSAyMS0xLTFhNy43NCA3Ljc0IDAgMCAwIDAtMTBsMS0xYTEgMSAwIDAgMCAwLTEuNDFsLTUtNWExIDEgMCAwIDAtMS40MSAwbC0xIDFhNy43NCA3Ljc0IDAgMCAwLTEwIDBsLTEtMWExIDEgMCAwIDAtMS40MSAwbC01IDVhMSAxIDAgMCAwIDAgMS40MWwxIDFhNy43NCA3Ljc0IDAgMCAwIDAgMTBsLTEgMWExIDEgMCAwIDAgMCAxLjQxbDUgNWExIDEgMCAwIDAgMS40MSAwbDEtMWE3Ljc0IDcuNzQgMCAwIDAgMTAgMGwxIDFhMSAxIDAgMCAwIDEuNDEgMGw1LTVhMSAxIDAgMCAwIDAtMS40MVoiLz4KPC9zdmc+Cjwvc3ZnPg==',
                tag: 'disciplin-reminder',
                requireInteraction: false,
                silent: false
            });

            notification.onclick = function() {
                window.focus();
                notification.close();
            };

            // Auto close after 10 seconds
            setTimeout(() => {
                notification.close();
            }, 10000);
        }

        function setupInactivityTimer() {
            if (!notificationPermission) return;
            
            // Clear existing timer
            clearInactivityTimer();
            
            // Set timer for 6 hours (21600000 ms)
            inactivityTimer = setTimeout(() => {
                showPushNotification();
                // Set up recurring notifications every 2 hours after the first one
                setupRecurringNotifications();
            }, 21600000); // 6 hours
            
            // Update last activity timestamp
            localStorage.setItem('disciplin_last_activity', Date.now().toString());
        }

        function setupRecurringNotifications() {
            if (!notificationPermission) return;
            
            // Send notification every 2 hours after initial 6-hour period
            const recurringTimer = setInterval(() => {
                const lastActivity = parseInt(localStorage.getItem('disciplin_last_activity') || '0');
                const timeSinceActivity = Date.now() - lastActivity;
                
                // If user has been inactive for more than 6 hours, send notification
                if (timeSinceActivity > 21600000) { // 6 hours
                    showPushNotification();
                } else {
                    // User has been active, clear the recurring timer and reset
                    clearInterval(recurringTimer);
                    setupInactivityTimer();
                }
            }, 7200000); // 2 hours
        }

        function clearInactivityTimer() {
            if (inactivityTimer) {
                clearTimeout(inactivityTimer);
                inactivityTimer = null;
            }
        }

        function resetInactivityTimer() {
            if (notificationPermission) {
                setupInactivityTimer();
            }
        }

        // Track user activity
        function trackActivity() {
            localStorage.setItem('disciplin_last_activity', Date.now().toString());
            resetInactivityTimer();
        }

        // Add activity tracking to various user interactions
        document.addEventListener('click', trackActivity);
        document.addEventListener('scroll', trackActivity);
        document.addEventListener('keypress', trackActivity);
        document.addEventListener('touchstart', trackActivity);

        function initializeApp() {
            // Check if user has already logged today
            const today = new Date().toDateString();
            const todayEntry = getEntryForDate(today);
            
            if (todayEntry) {
                updateStreakNotification();
            }

            // Initialize submit button state
            updateSubmitButtonState();
            
            // Track app opening
            trackActivity();
        }

        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                    trackActivity();
                    
                });
            });

            // Radio button change listener for masturbation question
            document.querySelectorAll('input[name="masturbated"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const timeQuestion = document.getElementById('timeQuestion');
                    if (this.value === 'yes') {
                        timeQuestion.classList.add('show');
                    } else {
                        timeQuestion.classList.remove('show');
                        // Clear all time checkboxes when hiding
                        document.querySelectorAll('input[name="timeOfDay"]').forEach(checkbox => {
                            checkbox.checked = false;
                            checkbox.closest('.checkbox-option').classList.remove('selected');
                        });
                    }
                });
            });

            // Checkbox styling for time of day
            document.querySelectorAll('input[name="timeOfDay"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const option = this.closest('.checkbox-option');
                    if (this.checked) {
                        option.classList.add('selected');
                    } else {
                        option.classList.remove('selected');
                    }
                });
            });

            // Emoji selection
            document.querySelectorAll('.emoji-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    currentMood = this.dataset.mood;
                });
            });

            // Form submission - Fix event listener
            const logForm = document.getElementById('logForm');
            if (logForm) {
                logForm.addEventListener('submit', handleFormSubmit);
            }

            // Also add click event listener to the submit button as backup
            const submitBtn = logForm.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    handleFormSubmit(e);
                });
            }

            // Install prompt - Fix visibility
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                const installBtn = document.getElementById('installBtn');
                if (installBtn) {
                    installBtn.style.display = 'block';
                }
            });

            document.getElementById('installBtn').addEventListener('click', () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted the install prompt');
                            // 🔥 Google Analytics install event
                            gtag('event', 'pwa_install', {
                                event_category: 'engagement',
                                event_label: 'User Installed PWA'
                            });
                        } else {
                            console.log('User dismissed the install prompt');
                        }

                        deferredPrompt = null;
                        const installBtn = document.getElementById('installBtn');
                        if (installBtn) {
                            installBtn.style.display = 'none';
                        }
                    });
                }
            });

            // Show install button on supported browsers
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                const installBtn = document.getElementById('installBtn');
                if (installBtn && !window.matchMedia('(display-mode: standalone)').matches) {
                    // Show install button if not already installed
                    setTimeout(() => {
                        installBtn.style.display = 'block';
                    }, 3000);
                }
            }

            // Hide update notification when clicking outside
            document.addEventListener('click', function(e) {
                const updateNotification = document.getElementById('updateNotification');
                if (!updateNotification.contains(e.target) && updateNotification.classList.contains('show')) {
                    // Don't auto-hide, let user decide
                }
            });
        }

       function switchTab(tabName) {
    // Scroll to top of the page
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // Update tab buttons (only for main tabs)
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Only highlight main tab if it exists
    const mainTab = document.querySelector(`[data-tab="${tabName}"]`);
    if (mainTab) {
        mainTab.classList.add('active');
    }

    // Update tab content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(tabName).classList.add('active');

    // Update submit button state when switching to log tab
    if (tabName === 'log') {
        updateSubmitButtonState();
    }

    // Refresh data when switching to relevant tabs
    if (tabName === 'home') {
        updateStats();
        updateStreakNotification();
        updateAchievements();
    } else if (tabName === 'history') {
        loadHistory();
    } else if (tabName === 'insights') {
        updateWeeklyInsights();
    }
}

        function handleFormSubmit(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Form submission triggered'); // Debug log

            // Check if user is online first
    if (!navigator.onLine) {
        showNotification('You must be online to log entries. Please check your internet connection.');
        alert('No Internet Connection, You need to be online to log entries as they are counted in our global statistics. Please check your internet connection and try again.');
        return; // Stop execution if offline
    }
            
            const today = new Date().toDateString();
            const existingEntry = getEntryForDate(today);
            
            if (existingEntry) {
                showNotification('You can only log one entry per day!');
                alert('You can only log one entry per day!');
                return;
            }

            // Get form data directly from elements
            const masturbatedYes = document.getElementById('yes').checked;
            const masturbatedNo = document.getElementById('no').checked;
            const notes = document.getElementById('notes').value;

            const energyLevel = document.querySelector('input[name="energyLevel"]:checked');
            if (!energyLevel) {
                showNotification('Please select your energy level');
                alert('Please select your energy level');
                return;
            }
            const sleepTime = document.querySelector('input[name="sleepTime"]:checked');
            if (!sleepTime) {
                showNotification('Please select your sleep time');
                alert('Please select your sleep time');
                return;
            }

            if (!masturbatedYes && !masturbatedNo) {
                showNotification('Please answer if you masturbated yesterday');
                alert('Please answer if you masturbated yesterday');
                return;
            }

            const masturbated = masturbatedYes;

            // Get selected times of day
            const timeOfDay = [];
            document.querySelectorAll('input[name="timeOfDay"]:checked').forEach(checkbox => {
                timeOfDay.push(checkbox.value);
            });

            const entry = {
                id: Date.now(),
                date: today,
                masturbated: masturbated,
                timeOfDay: timeOfDay,
                mood: currentMood,
                notes: notes,
                energy: energyLevel.value,
                sleepTime: sleepTime.value,
                timestamp: new Date().toISOString()
            };

            console.log('Entry to save:', entry); // Debug log

            try {
                saveEntry(entry);
               
                updateStats();
                updateStreakNotification();
                updateAchievements();
                updateWeeklyInsights();
                resetForm();
                trackActivity(); // Track this as user activity
                
                // Track form submission with analytics
                trackFormSubmission(entry);
                
                // Show success notification and alert
                showNotification('Entry logged successfully!', 'success');
                alert('✅ Entry saved successfully!');
                
                // Switch to home tab after a brief delay
                setTimeout(() => {
                    switchTab('home');
                }, 500);
            } catch (error) {
                console.error('Error saving entry:', error); // Debug log
                showNotification('Error saving entry. Please try again.');
                alert('❌ Error saving entry. Please try again.');
            }
        }

        function saveEntry(entry) {
            const entries = getEntries();
            entries.push(entry);
            localStorage.setItem('disciplin_entries', JSON.stringify(entries));
        }

        function getEntries() {
            const entries = localStorage.getItem('disciplin_entries');
            return entries ? JSON.parse(entries) : [];
        }

        function getEntryForDate(dateString) {
            const entries = getEntries();
            return entries.find(entry => entry.date === dateString);
        }

        function updateStats() {
            const entries = getEntries().sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            let currentStreak = 0;
            let longestStreak = 0;
            let tempStreak = 0;

            // Calculate streaks
            for (let i = 0; i < entries.length; i++) {
                if (!entries[i].masturbated) {
                    tempStreak++;
                    longestStreak = Math.max(longestStreak, tempStreak);
                } else {
                    tempStreak = 0;
                }
            }

            // Calculate current streak (from most recent entries)
            for (let i = entries.length - 1; i >= 0; i--) {
                if (!entries[i].masturbated) {
                    currentStreak++;
                } else {
                    break;
                }
            }

            document.getElementById('currentStreak').textContent = currentStreak;
            document.getElementById('longestStreak').textContent = longestStreak;
        }

        function updateAchievements() {
            const entries = getEntries().sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            let longestStreak = 0;
            let tempStreak = 0;

            // Calculate longest streak
            for (let i = 0; i < entries.length; i++) {
                if (!entries[i].masturbated) {
                    tempStreak++;
                    longestStreak = Math.max(longestStreak, tempStreak);
                } else {
                    tempStreak = 0;
                }
            }

            const achievementsGrid = document.getElementById('achievementsGrid');
            achievementsGrid.innerHTML = achievements.map(achievement => {
                const earned = achievement.condition(longestStreak);
                return `
                    <div class="achievement-badge ${earned ? 'earned' : ''}">
                        <div class="achievement-emoji">${achievement.icon}</div>
                        <div class="achievement-text">${achievement.text}</div>
                    </div>
                `;
            }).join('');
        }

        // Updated function to show both weekly and monthly insights
        function updateWeeklyInsights() {
            const entries = getEntries();
            if (entries.length === 0) {
                document.getElementById('weeklyInsights').innerHTML = `
                    <div class="empty-state">
                        <h3>No data yet</h3>
                        <p>Start logging entries to see your insights.</p>
                    </div>
                `;
                return;
            }

            // Get entries from the last 7 days (weekly)
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            const weeklyEntries = entries.filter(entry => 
                new Date(entry.timestamp) > oneWeekAgo
            );

            // Get entries from the last 30 days (monthly)
            const oneMonthAgo = new Date();
            oneMonthAgo.setDate(oneMonthAgo.getDate() - 30);
            
            const monthlyEntries = entries.filter(entry => 
                new Date(entry.timestamp) > oneMonthAgo
            );

            // Calculate weekly stats
            const weeklyStats = calculateInsightStats(weeklyEntries);
            
            // Calculate monthly stats
            const monthlyStats = calculateInsightStats(monthlyEntries);

            document.getElementById('weeklyInsights').innerHTML = `
                <!-- Weekly Insights Section -->
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #4F46E5; font-weight: 600; margin-bottom: 15px; text-align: center;"> Weekly Stats (7 Days)</h3>
                    <div style="background: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                        ${generateInsightHTML(weeklyStats, 7)}
                    </div>
                </div>

                <!-- Monthly Insights Section -->
                <div>
                    <h3 style="color: #4F46E5; font-weight: 600; margin-bottom: 15px; text-align: center;">Monthly Stats (30 Days)</h3>
                    <div style="background: var(--card-bg); border-radius: 10px; padding: 15px;">
                        ${generateInsightHTML(monthlyStats, 30)}
                    </div>
                </div>
            `;
        }

        // Helper function to calculate stats for any given period
        function calculateInsightStats(entries) {
            const totalEntries = entries.length;
            const cleanDays = entries.filter(entry => !entry.masturbated).length;
            const relapseDays = entries.filter(entry => entry.masturbated).length;
            const successRate = totalEntries > 0 ? Math.round((cleanDays / totalEntries) * 100) : 0;

            // Most common time of day for relapses
            const timeData = {};
            entries.forEach(entry => {
                if (entry.masturbated && entry.timeOfDay) {
                    entry.timeOfDay.forEach(time => {
                        timeData[time] = (timeData[time] || 0) + 1;
                    });
                }
            });

            const mostCommonTime = Object.keys(timeData).length > 0 
                ? Object.keys(timeData).reduce((a, b) => timeData[a] > timeData[b] ? a : b)
                : 'None';

            // Most common energy level
            const energyData = {};
            entries.forEach(entry => {
                if (entry.energy) {
                    energyData[entry.energy] = (energyData[entry.energy] || 0) + 1;
                }
            });
            const mostCommonEnergy = Object.keys(energyData).length > 0 
                ? Object.keys(energyData).reduce((a, b) => energyData[a] > energyData[b] ? a : b)
                : 'Not tracked';
            
            // Most common sleep time
            const sleepData = {};
            entries.forEach(entry => {
                if (entry.sleepTime) {
                    sleepData[entry.sleepTime] = (sleepData[entry.sleepTime] || 0) + 1;
                }
            });
            const mostCommonSleepTime = Object.keys(sleepData).length > 0 
                ? Object.keys(sleepData).reduce((a, b) => sleepData[a] > sleepData[b] ? a : b)
                : 'Not tracked';
            
            // Most common mood
            const moodData = {};
            entries.forEach(entry => {
                if (entry.mood) {
                    moodData[entry.mood] = (moodData[entry.mood] || 0) + 1;
                }
            });

            const mostCommonMood = Object.keys(moodData).length > 0 
                ? Object.keys(moodData).reduce((a, b) => moodData[a] > moodData[b] ? a : b)
                : 'Not tracked';

            return {
                totalEntries,
                cleanDays,
                relapseDays,
                successRate,
                mostCommonTime,
                mostCommonEnergy,
                mostCommonSleepTime,
                mostCommonMood
            };
        }

        // Helper function to generate HTML for insights
        function generateInsightHTML(stats, days) {
            return `
                <div class="insight-item">
                    <div class="insight-label">Total Entries (${days} days)</div>
                    <div class="insight-value">${stats.totalEntries}</div>
                </div>
                <div class="insight-item">
                    <div class="insight-label">Clean Days</div>
                    <div class="insight-value">${stats.cleanDays}</div>
                </div>
                <div class="insight-item">
                    <div class="insight-label">Relapse Days</div>       
                    <div class="insight-value">${stats.relapseDays}</div>
                </div>
                <div class="insight-item">
                    <div class="insight-label">Success Rate</div>
                    <div class="insight-value">${stats.successRate}%</div>
                </div>
                <div class="insight-item">
                    <div class="insight-label">Most Common Relapse Time</div>
                    <div class="insight-value">${stats.mostCommonTime}</div>
                </div>
                <div class="insight-item">
                    <div class="insight-label">Most Common Sleep Time</div>
                    <div class="insight-value">${stats.mostCommonSleepTime}</div>
                </div>
                <div class="insight-item">
                    <div class="insight-label">Most Common Energy Level</div>
                    <div class="insight-value">${stats.mostCommonEnergy}</div>
                </div>
                <div class="insight-item">
                    <div class="insight-label">Most Common Mood</div>
                    <div class="insight-value">${stats.mostCommonMood}</div>
                </div>
            `;
        }

        function exportData() {
            const entries = getEntries();
            const data = {
                entries: entries,
                exportDate: new Date().toISOString(),
                version: APP_VERSION
            };

            try {
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `disciplin_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                // Track data export
                trackDataExport();
                
                showNotification('Data exported successfully!', 'success');
                alert('✅ Data exported successfully!');
            } catch (error) {
                showNotification('Error exporting data');
                alert('❌ Error exporting data');
            }
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validate the data structure
                    if (!data.entries || !Array.isArray(data.entries)) {
                        throw new Error('Invalid backup file format');
                    }

                    // Ask for confirmation before importing
                    if (confirm('This will replace all your current data. Are you sure you want to import?')) {
                        localStorage.setItem('disciplin_entries', JSON.stringify(data.entries));
                        
                        // Refresh all views
                        updateStats();
                        updateAchievements();
                        updateWeeklyInsights();
                        loadHistory();
                        updateStreakNotification();
                        trackActivity(); // Track this as user activity
                        
                        // Track data import
                        trackDataImport();
                        
                        showNotification('Data imported successfully!', 'success');
                        alert('✅ Data imported successfully!');
                    }
                } catch (error) {
                    showNotification('Error importing data: Invalid file format');
                    alert('❌ Error importing data: Invalid file format');
                }
            };
            
            reader.readAsText(file);
            // Reset the file input
            event.target.value = '';
        }

        function updateStreakNotification() {
            const entries = getEntries().sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            let currentStreak = 0;

            // Calculate current streak
            for (let i = entries.length - 1; i >= 0; i--) {
                if (!entries[i].masturbated) {
                    currentStreak++;
                } else {
                    break;
                }
            }

            const notification = document.getElementById('streakNotification');
            if (currentStreak > 0) {
                notification.style.display = 'block';
                notification.textContent = `You've gone ${currentStreak} day${currentStreak !== 1 ? 's' : ''} without relapsing`;
            } else {
                notification.style.display = 'none';
            }
        }

        function showDeleteModal(entryId) {
            deleteEntryId = entryId;
            document.getElementById('deleteModal').classList.add('show');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
            deleteEntryId = null;
        }

        function confirmDelete() {
            if (deleteEntryId) {
                const entries = getEntries().filter(entry => entry.id !== deleteEntryId);
                localStorage.setItem('disciplin_entries', JSON.stringify(entries));
                loadHistory();
                updateStats();
                updateAchievements();
                updateWeeklyInsights();
                updateStreakNotification();
                closeDeleteModal();
                trackActivity(); // Track this as user activity
                showNotification('Entry deleted successfully!', 'success');
                alert('✅ Entry deleted successfully!');
            }
        }

        function showWelcomeModal() {
            const hasVisited = localStorage.getItem('disciplin_visited');
            if (!hasVisited) {
                document.getElementById('welcomeModal').classList.add('show');
            }
        }

        function closeWelcomeModal() {
            document.getElementById('welcomeModal').classList.remove('show');
            localStorage.setItem('disciplin_visited', 'true');
            trackActivity();
        }

        function resetForm() {
            document.getElementById('logForm').reset();
            document.querySelectorAll('.emoji-btn').forEach(btn => btn.classList.remove('selected'));
            document.querySelectorAll('.checkbox-option').forEach(option => option.classList.remove('selected'));
            document.getElementById('timeQuestion').classList.remove('show');
            currentMood = '';
        }

        function showNotification(message, type = 'error') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.background = type === 'success' ? '#10b981' : '#ef4444';
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function rotateMotiationTexts() {
            let currentIndex = 0;
            
            function updateText() {
                document.getElementById('motivationalText').textContent = motivationalTexts[currentIndex];
                document.getElementById('logMotivationalText').textContent = motivationalTexts[currentIndex];
                document.getElementById('insightsMotivationalText').textContent = motivationalTexts[currentIndex];
                document.getElementById('howtoMotivationalText').textContent = motivationalTexts[currentIndex];
                
                // Add this line for resources tab
                const resourcesText = document.getElementById('resourcesMotivationalText');
                if (resourcesText) {
                    resourcesText.textContent = motivationalTexts[currentIndex];
                }
                
                currentIndex = (currentIndex + 1) % motivationalTexts.length;
            }
            
            updateText();
            setInterval(updateText, 5000);
        }

        // Check if user returns to app and reset activity timer
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                trackActivity();
            }
        });

        // Check for missed check-ins on app start
        window.addEventListener('load', function() {
            const lastActivity = parseInt(localStorage.getItem('disciplin_last_activity') || '0');
            const timeSinceActivity = Date.now() - lastActivity;
            
            // If it's been more than 24 hours since last activity, show a gentle reminder
            if (timeSinceActivity > 86400000 && notificationPermission) { // 24 hours
                setTimeout(() => {
                    showNotification('Welcome back! Don\'t forget to log your daily progress.', 'success');
                }, 2000);
            }
        });

        // Back button handler with custom confirmation modal
        let popstateHandler;

        // Define the popstate handler function
        popstateHandler = function(e) {
            // Push current state back to prevent immediate navigation
            history.pushState(null, null, window.location.pathname);
            
            // Show custom modal
            showExitConfirmationModal();
        };

        // Add the event listener
        window.addEventListener('popstate', popstateHandler);

        // Initialize history state on page load
        window.addEventListener('load', function() {
            // Push initial state to enable popstate handling
            history.pushState(null, null, window.location.pathname);
        });

        // Handle browser refresh/close attempts
        window.addEventListener('beforeunload', function(e) {
            const confirmationMessage = 'Are you sure you want to leave Disciplin? Your progress is saved locally.';
            e.returnValue = confirmationMessage;
            return confirmationMessage;
        });

        // Custom exit confirmation modal functions
        function showExitConfirmationModal() {
            // Create modal HTML that matches your app's styling
            const modalHTML = `
                <div id="exitModal" class="modal show" style="z-index: 9999;">
                    <div class="modal-content">
                        <h2>Leave Disciplin?</h2>
                        <p>Are you sure you want to leave the app? Your progress is saved locally and will be here when you return.</p>
                        <div class="modal-buttons">
                            <button class="modal-btn secondary" onclick="cancelExit()">Stay in App</button>
                            <button class="modal-btn primary" onclick="confirmExit()">Leave App</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Track this interaction
            trackActivity();
        }

        function cancelExit() {
            const exitModal = document.getElementById('exitModal');
            if (exitModal) {
                exitModal.remove();
            }
            // Track that user chose to stay
            trackActivity();
        }

        function confirmExit() {
            const exitModal = document.getElementById('exitModal');
            if (exitModal) {
                exitModal.remove();
            }
            
            // IMPORTANT: Remove the popstate listener to allow navigation
            window.removeEventListener('popstate', popstateHandler);
            
            // Try multiple methods to exit the app
            
            // Method 1: For PWA (installed app)
            if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
                try {
                    window.close();
                } catch (e) {
                    // Android PWA - try to go to home screen
                    if (navigator.userAgent.toLowerCase().indexOf('android') > -1) {
                        window.location.href = 'intent:///#Intent;action=android.intent.action.MAIN;category=android.intent.category.HOME;end';
                    }
                }
            } else {
                // Method 2: For browser - try to close tab
                try {
                    window.close();
                } catch (e) {
                    // Method 3: Navigate back in history
                    history.go(-2);
                }
            }
            
            // Method 4: Final fallback - show goodbye page after a delay
            setTimeout(() => {
                document.body.innerHTML = `
                    <div style="
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                        height: 100vh;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        text-align: center;
                        padding: 20px;
                    ">
                        <h1 style="font-size: 2rem; margin-bottom: 1rem;">Thanks for using Disciplin!</h1>
                        <p style="font-size: 1.2rem; margin-bottom: 2rem;">Your progress is saved locally. Come back anytime!</p>
                        <p style="font-size: 1rem; margin-bottom: 2rem; opacity: 0.8;">You can now close this app by tapping on the back button </p>
                        <button onclick="location.reload()" style="
                            background: rgba(255,255,255,0.2);
                            color: white;
                            border: 2px solid white;
                            padding: 12px 24px;
                            border-radius: 8px;
                            font-size: 16px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='white'; this.style.color='#4F46E5'" 
                           onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.color='white'">
                            Return to Disciplin
                        </button>
                    </div>
                `;
            }, 500);
        }

        // Optional: Handle Android hardware back button for PWA
        document.addEventListener('backbutton', function(e) {
            e.preventDefault();
            showExitConfirmationModal();
        }, false);

        // Connection status functions
        function updateConnectionStatusAnimated() {
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');

            if (navigator.onLine) {
                statusIcon.style.background = 'limegreen';
                statusText.textContent = 'Online';
            } else {
                statusIcon.style.background = 'red';
                statusText.textContent = 'Offline';
            }

            const statusContainer = document.getElementById('connectionStatus');
            statusContainer.classList.remove('status-container');
            void statusContainer.offsetWidth;
            statusContainer.classList.add('status-container');
        }

        window.addEventListener('online', updateConnectionStatusAnimated);
        window.addEventListener('offline', updateConnectionStatusAnimated);
        document.addEventListener('DOMContentLoaded', updateConnectionStatusAnimated);

        // Connection status functions
function updateConnectionStatusAnimated() {
    const statusIcon = document.getElementById('statusIcon');
    const statusText = document.getElementById('statusText');

    if (navigator.onLine) {
        statusIcon.style.background = 'limegreen';
        statusText.textContent = 'Online';
    } else {
        statusIcon.style.background = 'red';
        statusText.textContent = 'Offline';
    }

    const statusContainer = document.getElementById('connectionStatus');
    statusContainer.classList.remove('status-container');
    void statusContainer.offsetWidth;
    statusContainer.classList.add('status-container');
}

window.addEventListener('online', updateConnectionStatusAnimated);
window.addEventListener('offline', updateConnectionStatusAnimated);
document.addEventListener('DOMContentLoaded', updateConnectionStatusAnimated);

// ADD THE NEW FUNCTION HERE:
function updateSubmitButtonState() {
    const submitBtn = document.getElementById('logSubmitBtn');
    if (!submitBtn) return;
    
    if (navigator.onLine) {
        submitBtn.classList.remove('offline');
        submitBtn.textContent = 'Log Entry';
        submitBtn.disabled = false;
    } else {
        submitBtn.classList.add('offline');
        submitBtn.textContent = 'Offline - Cannot Log Entry';
        submitBtn.disabled = true;
    }
}

// Update the existing event listeners to also call the new function
window.addEventListener('online', function() {
    updateConnectionStatusAnimated();
    updateSubmitButtonState();
});

window.addEventListener('offline', function() {
    updateConnectionStatusAnimated();
    updateSubmitButtonState();
});
    </script>

    <!-- Service Worker Script (inline) -->
    <script>
        // Service Worker code as a string to be registered
        const serviceWorkerCode = `
            const CACHE_NAME = 'disciplin-v${APP_VERSION}';
            const urlsToCache = [
                './',
                './index.html'
            ];

            self.addEventListener('install', function(event) {
                event.waitUntil(
                    caches.open(CACHE_NAME)
                        .then(function(cache) {
                            return cache.addAll(urlsToCache);
                        })
                );
                // Force the waiting service worker to become active
                self.skipWaiting();
            });

            self.addEventListener('activate', function(event) {
                event.waitUntil(
                    caches.keys().then(function(cacheNames) {
                        return Promise.all(
                            cacheNames.map(function(cacheName) {
                                if (cacheName !== CACHE_NAME) {
                                    return caches.delete(cacheName);
                                }
                            })
                        );
                    })
                );
                // Claim control of all clients
                return self.clients.claim();
            });

            self.addEventListener('fetch', function(event) {
                event.respondWith(
                    caches.match(event.request)
                        .then(function(response) {
                            // Return cached version or fetch from network
                            return response || fetch(event.request);
                        }
                    )
                );
            });

            // Background sync for notifications (if supported)
            self.addEventListener('sync', function(event) {
                if (event.tag === 'disciplin-reminder') {
                    event.waitUntil(sendReminderNotification());
                }
            });

            function sendReminderNotification() {
                const notificationOptions = {
                    body: 'Time to check in with your progress! 💪',
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiM0RjQ2RTUiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiPgo8cGF0aCBkPSJtOSAxMiAyIDIgNC00Ii8+CjxwYXRoIGQ9Im0yMSAyMS0xLTFhNy43NCA3Ljc0IDAgMCAwIDAtMTBsMS0xYTEgMSAwIDAgMCAwLTEuNDFsLTUtNWExIDEgMCAwIDAtMS40MSAwbC0xIDFhNy43NCA3Ljc0IDAgMCAwLTEwIDBsLTEtMWExIDEgMCAwIDAtMS40MSAwbC01IDVhMSAxIDAgMCAwIDAgMS40MWwxIDFhNy43NCA3Ljc0IDAgMCAwIDAgMTBsLTEgMWExIDEgMCAwIDAgMCAxLjQxbDUgNWExIDEgMCAwIDAgMS40MSAwbDEtMWE3Ljc0IDcuNzQgMCAwIDAgMTAgMGwxIDFhMSAxIDAgMCAwIDEuNDEgMGw1LTVhMSAxIDAgMCAwIDAtMS40MVoiLz4KPC9zdmc+Cjwvc3ZnPg==',
                    badge: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzIiIGhlaWdodD0iNzIiIHZpZXdCb3g9IjAgMCA3MiA3MiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjcyIiBoZWlnaHQ9IjcyIiByeD0iMTIiIGZpbGw9IiM0RjQ2RTUiLz4KPHN2ZyB4PSIxOCIgeT0iMTgiIHdpZHRoPSIzNiIgaGVpZ2h0PSIzNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiPgo8cGF0aCBkPSJtOSAxMiAyIDIgNC00Ii8+CjxwYXRoIGQ9Im0yMSAyMS0xLTFhNy43NCA3Ljc0IDAgMCAwIDAtMTBsMS0xYTEgMSAwIDAgMCAwLTEuNDFsLTUtNWExIDEgMCAwIDAtMS40MSAwbC0xIDFhNy43NCA3Ljc0IDAgMCAwLTEwIDBsLTEtMWExIDEgMCAwIDAtMS40MSAwbC01IDVhMSAxIDAgMCAwIDAgMS40MWwxIDFhNy43NCA3Ljc0IDAgMCAwIDAgMTBsLTEgMWExIDEgMCAwIDAgMCAxLjQxbDUgNWExIDEgMCAwIDAgMS40MSAwbDEtMWE3Ljc0IDcuNzQgMCAwIDAgMTAgMGwxIDFhMSAxIDAgMCAwIDEuNDEgMGw1LTVhMSAxIDAgMCAwIDAtMS40MVoiLz4KPC9zdmc+Cjwvc3ZnPg==',
                    tag: 'disciplin-reminder',
                    requireInteraction: false
                };

                return self.registration.showNotification('Disciplin', notificationOptions);
            }
        `;

        // Create and register the service worker
        if ('serviceWorker' in navigator) {
            const blob = new Blob([serviceWorkerCode.replace('${APP_VERSION}', APP_VERSION)], {
                type: 'application/javascript'
            });
            const serviceWorkerUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(serviceWorkerUrl)
                .then(registration => {
                    console.log('Service Worker registered successfully');
                    
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showUpdateNotification();
                            }
                        });
                    });
                })
                .catch(error => {
                    console.log('Service Worker registration failed:', error);
                });
        }
    </script>

    <!-- Manifest JSON (inline for single file) -->
    <script>
        // Create and inject manifest
        const manifest = {
            "id": "https://ifexxy.github.io/disciplin/",
            "dir": "ltr",
            "lang": "en-US",
            "name": "Disciplin",
            "scope": "https://ifexxy.github.io/disciplin/",
            "display": "standalone",
            "start_url": "https://ifexxy.github.io/disciplin/",
            "short_name": "Disciplin",
            "theme_color": "#000000",
            "description": "Personal habit tracking app with notifications",
            "orientation": "portrait",
            "background_color": "#000000",
            "prefer_related_applications": false,
            "display_override": [
                "window-controls-overlay"
            ],
            "screenshots": [
                {
                    "src": "https://ifexxy.github.io/disciplin/assets/screen.png"
                },
                {
                    "src": "https://ifexxy.github.io/disciplin/assets/screen.png"
                },
                {
                    "src": "https://ifexxy.github.io/disciplin/assets/screen.png"
                }
            ],
            "features": [
                "Habit Tracking",
                "Push Notifications",
                "Progress Analytics",
                "Goal Setting"
            ],
            "icons": [
                {
                    "src": "https://ifexxy.github.io/disciplin/icons/icon-192.png",
                    "sizes": "192x192",
                    "type": "image/png",
                    "purpose": "any"
                },
                {
                    "src": "https://ifexxy.github.io/disciplin/icons/icon-192-maskable.png",
                    "sizes": "192x192",
                    "type": "image/png",
                    "purpose": "maskable"
                },
                {
                    "src": "https://ifexxy.github.io/disciplin/icons/icon-512.png",
                    "sizes": "512x512",
                    "type": "image/png",
                    "purpose": "any"
                },
                {
                    "src": "https://ifexxy.github.io/disciplin/icons/icon-512-maskable.png",
                    "sizes": "512x512",
                    "type": "image/png",
                    "purpose": "maskable"
                }
            ],
            "categories": [
                "productivity",
                "health",
                "lifestyle"
            ],
            "launch_handler": {
                "client_mode": "navigate-existing"
            },
            "shortcuts": [
                {
                    "name": "Add New Habit",
                    "short_name": "Add Habit",
                    "description": "Quickly add a new habit to track",
                    "url": "https://ifexxy.github.io/disciplin/?addHabit",
                    "icons": [
                        {
                            "src": "https://ifexxy.github.io/disciplin/icons/icon-192.png",
                            "sizes": "192x192"
                        }
                    ]
                },
                {
                    "name": "View Progress",
                    "short_name": "Progress",
                    "description": "Check your habit tracking progress",
                    "url": "https://ifexxy.github.io/disciplin/?progress",
                    "icons": [
                        {
                            "src": "https://ifexxy.github.io/disciplin/icons/icon-192.png",
                            "sizes": "192x192"
                        }
                    ]
                }
            ]
        }
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.querySelector('link[rel="manifest"]').href = manifestURL;
    </script>
    
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').then(reg => {
                reg.onupdatefound = () => {
                    const installingWorker = reg.installing;
                    installingWorker.onstatechange = () => {
                        if (installingWorker.state === 'installed') {
                            if (navigator.serviceWorker.controller) {
                                // New content is available
                                const userConfirmed = confirm("A new update is available. Please backup your entries and refresh to update.");
                                if (userConfirmed) {
                                    reg.waiting.postMessage({ type: 'SKIP_WAITING' });
                                    window.location.reload();
                                }
                            }
                        }
                    };
                };
            }).catch(err => {
                console.error('Service Worker registration failed:', err);
            });
        }
    </script>
</body>
</html>
