<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-P2BFCJMQ3Y"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-P2BFCJMQ3Y');
</script>
<!-- Firebase Forum SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<!-- Firebase Script for Cloud -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disciplin</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4F46E5">
    <!-- Version for cache busting - UPDATE THIS WHEN MAKING CHANGES -->
    <meta name="app-version" content="3.2.27">
    <link rel="icon" type="image/png" sizes="192x192" href="https://miseducatemen.wordpress.com/wp-content/uploads/2025/08/favicon.jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            /* Light mode colors */
            --bg-primary: #f8f9fa;
            --bg-secondary: white;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --header-bg: linear-gradient(135deg, #6b7280, #4b5563); /* Gray gradient */
            --text-primary: #333;
            --text-secondary: #666;
            --text-muted: #999;
            --border-color: #e9ecef;
            --border-hover: #d1d5db;
            --card-bg: #f8f9fa;
            --input-bg: white;
            --shadow: rgba(0,0,0,0.1);
            --shadow-hover: rgba(0,0,0,0.15);
            --accent-bg: rgba(255,255,255,0.2);
            --accent-hover: rgba(255,255,255,0.3);
            --success-bg: #dcfce7;
            --success-text: #16a34a;
            --error-bg: #fef2f2;
            --error-text: #dc2626;
            --modal-overlay: rgba(0,0,0,0.5);
                        --analytics-bg: linear-gradient(135deg, #808080, #764ba2);
            --achievement-earned: linear-gradient(135deg, #10b981, #059669);
                        --level-bg: linear-gradient(135deg, #808080, #764ba2);
            --flame-color: #ff6b35;
            --level-gold: #ffd700;
            --level-silver: #c0c0c0;
            --level-bronze: #cd7f32;
        }

        [data-theme="dark"] {
            /* Dark mode colors */
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-gradient: linear-gradient(135deg, #4c1d95 0%, #581c87 100%);
            --header-bg: linear-gradient(135deg, #111827, #1f2937); /* Dark gradient */
            --text-primary: #e5e5e5;
            --text-secondary: #b3b3b3;
            --text-muted: #888;
            --border-color: #404040;
            --border-hover: #555;
            --card-bg: #2d2d2d;
            --input-bg: #3a3a3a;
            --shadow: rgba(0,0,0,0.3);
            --shadow-hover: rgba(0,0,0,0.4);
            --accent-bg: rgba(255,255,255,0.1);
            --accent-hover: rgba(255,255,255,0.2);
            --success-bg: #064e3b;
            --success-text: #10b981;
            --error-bg: #7f1d1d;
            --error-text: #f87171;
            --modal-overlay: rgba(0,0,0,0.7);
            --analytics-bg: linear-gradient(135deg, #212122, #212122);
            --achievement-earned: linear-gradient(135deg, #059669, #047857);
                                                   --level-bg: linear-gradient(135deg, #212122, #212122);
            --flame-color: #ff6b35;
            --level-gold: #ffd700;
            --level-silver: #c0c0c0;
            --level-bronze: #cd7f32;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: var(--bg-secondary);
            min-height: 100vh;
            box-shadow: 0 0 20px var(--shadow);
            position: relative;
            transition: all 0.3s ease;
            padding-bottom: 60px;
        }

        .header {
    background: var(--header-bg);
    color: white;
    padding: 20px;
    text-align: center;
    position: relative;
    transition: background 0.3s ease;
}

        .header h1 {
            font-size: 28px;
            font-weight: 600;
        }

        .header-buttons {
            position: absolute;
            top: 10px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .header-buttons.left {
            left: 8px;
        }

        .header-buttons.right {
            right: 8px;
        }

        .header-btn {
            background: var(--accent-bg);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .header-btn:hover {
            background: var(--accent-hover);
        }

        .header-btn i {
    margin-right: 4px;
}

        .header-btn.enabled {
            background: rgba(16, 185, 129, 0.8);
        }

        .dark-mode-toggle {
            background: var(--accent-bg);
            border: none;
            color: white;
            padding: 8px;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .dark-mode-toggle i {
    font-size: 16px;
}

        .dark-mode-toggle:hover {
            background: var(--accent-hover);
            transform: scale(1.1);
        }
        


        /* Level System Styles */
        .level-system {
          background: var(--level-bg);
            color: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            
        }

        .level-badge {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 25px;
            margin-bottom: 10px;
        }

        .level-icon {
            font-size: 24px;
        }

        .level-text {
            font-size: 18px;
            font-weight: 600;
        }

        .xp-progress {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin-top: 10px;
        }

        .xp-fill {
            background: linear-gradient(90deg, #10b981, #059669);
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .xp-text {
            font-size: 14px;
            margin-top: 5px;
            opacity: 0.9;
        }
        
                /* Animation for new features */
        .feature-highlight {
            animation: pulse 2s infinite;
            transform-origin: center;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        





        /* Streak Flames */
        .streak-flames {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
        }

        .flame {
            color: var(--flame-color);
            font-size: 20px;
            animation: flicker 1.5s infinite alternate;
        }

        .flame.active {
            animation: flicker 1.5s infinite alternate;
        }

        .flame.inactive {
            color: var(--text-muted);
            animation: none;
        }

        @keyframes flicker {
            0% { opacity: 1; transform: scale(1) rotate(-1deg); }
            50% { opacity: 0.8; transform: scale(1.1) rotate(1deg); }
            100% { opacity: 1; transform: scale(1) rotate(-1deg); }
        }
        
        .slider-container {
            max-height: 300px; /* Set your desired height */
            overflow-y: auto;
            background: transparent;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #6366f1;
        }
        
        
        
        /* Custom scrollbar styling */
        .slider-container::-webkit-scrollbar {
            width: 8px;
        }

        .slider-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .slider-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .slider-container::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        

        /* Journal Styles */
        .journal-entry {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #4F46E5;
            transition: all 0.3s ease;
        }

        .journal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .journal-date {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .journal-mood {
            font-size: 18px;
        }

        .journal-content {
            color: var(--text-primary);
            line-height: 1.5;
        white-space: pre-line;


    

        }

        .journal-form {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

.journal-slider-container {
    max-height: 400px;
    overflow-y: auto;
    padding: 15px;
    background: transparent; /* Remove white background */
    border-radius: 10px;
}

.journal-slider-container .journal-content {
    line-height: 1.2;
    word-break: break-word;
    word-wrap: break-word;
    overflow-wrap: break-word;
}


.journal-slider-container .journal-entry:last-child {
    margin-bottom: 0;
}

/* Forum-specific styles */
.forum-thread {
    background: var(--card-bg);
    border: 2px solid var(--border-color);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.forum-thread:hover {
    border-color: #4F46E5;
    transform: translateY(-1px);
}

.forum-thread.unread {
    border-color: #4F46E5;
    background: linear-gradient(135deg, rgba(79, 70, 229, 0.05), rgba(79, 70, 229, 0.02));
}

.thread-title {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 8px;
    font-size: 16px;
    transition: color 0.3s ease;
}

.thread-title.unread {
    font-weight: bold;
}

.thread-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 8px;
}

.thread-content {
  color: var(--text-secondary);
  font-size: 14px;
  line-height: 1.7;              /* better readability */
  max-height: 50px;              /* keeps preview trimmed */
  overflow: hidden;              /* hides overflow */
  margin-bottom: 10px;
  padding: 8px 12px;             /* adds breathing space */
  white-space: pre-wrap;         /* respects line breaks */
  word-wrap: break-word;
  overflow-wrap: anywhere;
  text-align: justify;           /* justify text */
  text-justify: inter-word;
}

.thread-content p {
  margin-bottom: 12px;           /* spacing between paragraphs */
}


.thread-stats {
    display: flex;
    gap: 15px;
    font-size: 12px;
    color: var(--text-muted);
}

.thread-category {
    background: #4F46E5;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 500;
}

.reply-item {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
}

.reply-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    font-size: 12px;
}

.reply-author {
    font-weight: 600;
    color: var(--text-primary);
}

.reply-content {
    color: var(--text-primary);
    line-height: 1.5;
    white-space: pre-wrap;
}

.like-btn {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 4px;
    transition: all 0.3s ease;
}

.like-btn:hover {
    background: var(--border-color);
}

.like-btn.liked {
    color: #ef4444;
}

@media (max-width: 480px) {
    .thread-meta {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
    }
    
    .thread-stats {
        flex-wrap: wrap;
    }
}

/* Custom scrollbar */
.journal-slider-container::-webkit-scrollbar {
    width: 8px;
}

.journal-slider-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.journal-slider-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.journal-slider-container::-webkit-scrollbar-thumb:hover {
    background: #a1a1a1;
}

        /* Personalized Insights */
        .insights-personal {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .insights-personal h3 {
            color: #4F46E5;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .insight-card {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .insight-icon {
            font-size: 24px;
            min-width: 24px;
        }

        .insight-text {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
        }

        .tabs {
    display: flex;
    background: var(--bg-primary);
    border-top: 1px solid var(--border-color);
    border-bottom: none;
    transition: all 0.3s ease;
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    max-width: 400px;
    width: 100%;
    z-index: 100;
    box-shadow: 0 -2px 10px var(--shadow);
}
      .tab {
    flex: 1;
    padding: 10px 4px;
    text-align: center;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-secondary);
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
}

.tab-icon {
    font-size: 18px;
    font-weight: 300;
    color: inherit;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
}

.tab.active {
    color: #4F46E5;
}

.tab.active .tab-icon {
    font-weight: 600;
    transform: scale(1.1);
}

        .tab.active {
            background: var(--bg-secondary);
            color: #4F46E5;
            border-bottom: 2px solid #4F46E5;
        }

        .tab-content {
            display: none;
            padding: 20px;
            background: var(--bg-secondary);
            transition: all 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .motivational-text {
            text-align: center;
            margin: 20px 0;
            font-style: italic;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 500;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.3s ease;
        }
        
       /* Chat Styles */
#chat {
    position: absolute !important;
    top: 100px !important; /* Adjust this value based on your header height */
    left: 0 !important;
    right: 0 !important;
    bottom: 30px !important; /* Adjust based on bottom nav height */
    margin: 0 !important;
    padding: 20px !important;
    overflow-y: auto !important;
}
       /* Keep mobile positioning */
@media (max-width: 767px) {
    #chat {
        position: absolute !important;
        top: 100px !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 80px !important;
        margin: 0 !important;
        padding: 20px !important;
        overflow-y: auto !important;
    }
}


       
.auth-section {
    background: var(--card-bg);
    border-radius: 15px;
    padding: 30px 20px;
    text-align: center;
    transition: all 0.3s ease;
}

.auth-title {
    font-size: 24px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 10px;
    transition: color 0.3s ease;
}

.auth-subtitle {
    font-size: 16px;
    color: var(--text-secondary);
    margin-bottom: 30px;
    transition: color 0.3s ease;
}

.auth-buttons {
    display: flex;
    flex-direction: column;
    gap: 15px;
    max-width: 300px;
    margin: 0 auto;
}

.auth-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.google-btn {
    background: #db4437;
    color: white;
}

.google-btn:hover {
    background: #c23321;
}

.anonymous-btn {
    background: #6c757d;
    color: white;
}

.anonymous-btn:hover {
    background: #5a6268;
}

.email-btn {
    background: #4F46E5;
    color: white;
}

.email-btn:hover {
    background: #3730a3;
}

.chat-interface {
    display: flex;
    flex-direction: column;
    height: 80vh;
    background: var(--bg-secondary);
    border-radius: 15px;
    overflow: hidden;
    transition: all 0.3s ease;
}

.chat-header {
    background: var(--header-bg);
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-user-info {
    display: flex;
    align-items: center;
    gap: 15px;
}

.logout-btn {
    background: var(--accent-bg);
    border: none;
    color: white;
    padding: 8px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
}

.logout-btn:hover {
    background: var(--accent-hover);
}

.chat-messages {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background: var(--bg-primary);
    transition: all 0.3s ease;
}

.message {
    display: flex;
    margin-bottom: 15px;
    animation: fadeIn 0.3s ease;
}

.message.own {
    justify-content: flex-end;
}

.message-content {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 18px;
    position: relative;
}

.message:not(.own) .message-content {
    background: var(--card-bg);
    color: var(--text-primary);
    border-bottom-left-radius: 4px;
}

.message.own .message-content {
    background: #4F46E5;
    color: white;
    border-bottom-right-radius: 4px;
}

.message-author {
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 4px;
    opacity: 0.8;
}

.message-text {
    font-size: 14px;
    line-height: 1.4;
    word-wrap: break-word;
}

.message-time {
    font-size: 11px;
    opacity: 0.7;
    margin-top: 4px;
}

.chat-input-container {
    display: flex;
    padding: 15px 20px;
    background: var(--bg-secondary);
    border-top: 1px solid var(--border-color);
    gap: 10px;
    transition: all 0.3s ease;
}

#messageInput {
    flex: 1;
    padding: 12px 16px;
    border: 2px solid var(--border-color);
    border-radius: 25px;
    background: var(--input-bg);
    color: var(--text-primary);
    font-size: 14px;
    transition: all 0.3s ease;
}

#messageInput:focus {
    outline: none;
    border-color: #4F46E5;
}

#sendButton {
    background: #4F46E5;
    color: white;
    border: none;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

#sendButton:hover {
    background: #3730a3;
    transform: scale(1.05);
}

#sendButton:disabled {
    background: #9ca3af;
    cursor: not-allowed;
    transform: none;
}

.typing-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    color: var(--text-secondary);
    font-size: 12px;
    font-style: italic;
    transition: color 0.3s ease;
}

.typing-dots {
    display: flex;
    gap: 2px;
}

.typing-dot {
    width: 4px;
    height: 4px;
    background: var(--text-secondary);
    border-radius: 50%;
    animation: typingDots 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }

@keyframes typingDots {
    0%, 80%, 100% {
        transform: scale(0);
    }
    40% {
        transform: scale(1);
    }
}

/* Modal input styles for chat */
.modal-content input[type="email"],
.modal-content input[type="password"],
.modal-content input[type="text"] {
    width: 100%;
    padding: 12px;
    margin-bottom: 15px;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    font-size: 16px;
    background: var(--input-bg);
    color: var(--text-primary);
    transition: all 0.3s ease;
}

.modal-content input:focus {
    outline: none;
    border-color: #4F46E5;
}

/* Responsive adjustments */
@media (max-width: 480px) {
    .chat-interface {
        height: 80vh;
    }
    
    .message-content {
        max-width: 85%;
    }
    
    .auth-buttons {
        max-width: 100%;
    }
}
        
        /* Timer Section Styles - Add these to your existing CSS */
.timer-section {
    background: var(--card-bg);
    border-radius: 15px;
    padding: 20px;
    margin: 20px 0;
    text-align: center;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.timer-section.clean-streak {
    border-color: #10b981;
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));
}

.timer-section.relapse-streak {
    border-color: #ef4444;
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1));
}

.timer-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 10px;
    color: var(--text-primary);
    transition: color 0.3s ease;
}

.timer-title.clean {
    color: #10b981;
}

.timer-title.relapse {
    color: #ef4444;
}

.timer-subtitle {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 15px;
    transition: color 0.3s ease;
}

.timer-display {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin-bottom: 15px;
}

.timer-unit {
    background: var(--bg-secondary);
    border-radius: 10px;
    padding: 15px 5px;
    box-shadow: 0 2px 8px var(--shadow);
    transition: all 0.3s ease;
}

.timer-unit:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px var(--shadow-hover);
}

.timer-number {
    font-size: 24px;
    font-weight: bold;
    color: var(--text-primary);
    margin-bottom: 5px;
    transition: color 0.3s ease;
    font-family: 'Courier New', monospace;
}

.timer-label {
    font-size: 10px;
    font-weight: 500;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: color 0.3s ease;
}

.timer-status {
    font-size: 14px;
    font-weight: 500;
    padding: 8px 16px;
    border-radius: 20px;
    display: inline-block;
    margin-top: 10px;
}

.timer-status.clean {
    background: var(--success-bg);
    color: var(--success-text);
}

.timer-status.relapse {
    background: var(--error-bg);
    color: var(--error-text);
}

/* Responsive adjustments */
/* Floating Notification Bell - ADD THIS CSS */
.floating-notification-bell {
    position: fixed;
    bottom: 73px; /* Above the tab bar (60px) + some spacing */
    right: 15px;
    width: 45px;
    height: 45px;
    background: var(--level-bg);
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 24px;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 999; /* Below modals but above other content */
    box-shadow: 0 4px 20px var(--shadow);
    display: none; /* Hidden by default */
    align-items: center;
    justify-content: center;
    transform: scale(1);
    animation: subtle-pulse 3s ease-in-out infinite;
}

.floating-notification-bell:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 30px rgba(79, 70, 229, 0.4);
    background: linear-gradient(135deg, #3730a3, #1e1b4b);
}

.floating-notification-bell:active {
    transform: scale(0.95);
}

.floating-notification-bell.enabled {
    background: var(--level-bg);
}

.floating-notification-bell.enabled:hover {
    background: linear-gradient(135deg, #059669, #047857);
    box-shadow: 0 6px 30px rgba(16, 185, 129, 0.4);
}

.floating-notification-bell.show {
    display: flex;
}

/* Subtle pulsing animation */
@keyframes subtle-pulse {
    0%, 100% {
        box-shadow: 0 4px 20px var(--shadow), 0 0 0 0 rgba(79, 70, 229, 0.1);
    }
    50% {
        box-shadow: 0 4px 20px var(--shadow), 0 0 0 10px rgba(79, 70, 229, 0);
    }
}

[data-theme="dark"] .floating-notification-bell {
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}

[data-theme="dark"] .floating-notification-bell:hover {
    box-shadow: 0 6px 30px rgba(79, 70, 229, 0.6);
}

@media (max-width: 380px) {
    .timer-display {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
    }
    
    .timer-number {
        font-size: 20px;
    }
    
    .timer-unit {
        padding: 12px 5px;
    }
}

/* Goals Section Styles */
.goals-section {
    background: var(--card-bg);
    border-radius: 15px;
    padding: 20px;
    transition: all 0.3s ease;
}

.goal-item {
    background: var(--bg-secondary);
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
}

.goal-item.completed {
    border-color: #10b981;
    background: var(--success-bg);
}

.goal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.goal-title {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 16px;
    transition: color 0.3s ease;
}

.goal-status {
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 12px;
    font-weight: 500;
}

.goal-status.active {
    background: #3b82f6;
    color: white;
}

.goal-status.completed {
    background: #10b981;
    color: white;
}

.goal-progress {
    margin-bottom: 10px;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: var(--border-color);
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #4F46E5, #10b981);
    border-radius: 4px;
    transition: width 0.5s ease;
}

.progress-text {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 5px;
    display: flex;
    justify-content: space-between;
    transition: color 0.3s ease;
}

.goal-description {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 8px;
    line-height: 1.4;
    transition: color 0.3s ease;
}

.delete-goal-btn {
    background: #ef4444;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    cursor: pointer;
    margin-left: 8px;
}

        /* Achievement Badges */
        .achievements-section {
            margin-bottom: 30px;
        }

        .achievements-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .achievement-badge {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .achievement-badge.earned {
            background: var(--achievement-earned);
            border-color: #10b981;
            color: white;
        }

        .achievement-badge.earned:hover {
            transform: scale(1.05);
        }

        .achievement-badge:not(.earned) .achievement-icon {
    color: #666;
    opacity: 0.5;
}

[data-theme="dark"] .achievement-badge:not(.earned) .achievement-icon {
    color: #999;
}

      .achievement-icon {
    font-size: 24px;
    margin-bottom: 5px;
    color: var(--text-secondary);
    transition: color 0.3s ease;
}

        .achievement-text {
            font-size: 10px;
            font-weight: 500;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .achievement-badge.earned .achievement-icon {
    color: white;
}


        /* Analytics Section */
        .analytics-section {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .analytics-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
            text-align: center;
            transition: color 0.3s ease;
        }

        .analytics-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .analytics-card {
            background: var(--analytics-bg);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .analytics-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .analytics-label {
            font-size: 12px;
            opacity: 0.9;
        }

        /* Weekly Insights */
        .weekly-insights {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .insights-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
            text-align: center;
            transition: color 0.3s ease;
        }

        .insight-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            transition: border-color 0.3s ease;
        }

        .insight-item:last-child {
            border-bottom: none;
        }

        .insight-label {
            font-weight: 500;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }

        .insight-value {
            font-weight: 600;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        /* Backup section */
        .backup-section {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .backup-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
            text-align: center;
            transition: color 0.3s ease;
        }

        .backup-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .backup-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .backup-btn.export {
            background: #10b981;
            color: white;
        }

        .backup-btn.import {
            background: #3b82f6;
            color: white;
        }

        .backup-btn:hover {
            transform: translateY(-1px);
        }

        .file-input {
            width: 100%;
            padding: 10px;
            border: 2px dashed var(--border-hover);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            background: var(--input-bg);
        }

        .file-input:hover {
            border-color: #4F46E5;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-option input[type="radio"] {
            width: 18px;
            height: 18px;
        }

        .radio-option label {
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 10px;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: var(--card-bg);
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .checkbox-option:hover {
            background: var(--border-color);
        }

        .checkbox-option.selected {
            border-color: #4F46E5;
            background: var(--border-color);
        }

        .checkbox-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .checkbox-option label {
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .conditional-question {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 10px;
            border-left: 4px solid #4F46E5;
            transition: all 0.3s ease;
        }

        .conditional-question.show {
            display: block;
        }

        .emoji-selector {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }

        .emoji-btn {
            background: var(--card-bg);
            border: 2px solid transparent;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .emoji-btn:hover, .emoji-btn.selected {
            border-color: #4F46E5;
            background: var(--border-color);
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .form-control:focus {
            outline: none;
            border-color: #4F46E5;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: #4F46E5;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #3730a3;
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .btn.offline {
    background: #9ca3af !important;
    cursor: not-allowed !important;
    opacity: 0.6;
}

.btn.offline:hover {
    background: #9ca3af !important;
    transform: none !important;
}
        
        .streak-notification {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .history-item {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .history-item.selected {
            border-color: #4F46E5;
            background: var(--border-color);
        }

        .history-item-checkbox {
            margin-right: 15px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .history-item-content {
            flex: 1;
        }

        .history-date {
            font-weight: 600;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .history-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-success {
            background: var(--success-bg);
            color: var(--success-text);
        }

        .status-relapse {
            background: var(--error-bg);
            color: var(--error-text);
        }

        .delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        /* History Controls */
        .history-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .history-controls-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .history-controls-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .select-all-btn, .delete-selected-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .select-all-btn {
            background: #4F46E5;
            color: white;
        }

        .select-all-btn:hover {
            background: #3730a3;
        }

        .delete-selected-btn {
            background: #ef4444;
            color: white;
        }

        .delete-selected-btn:hover {
            background: #dc2626;
        }

        .delete-selected-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .selected-count {
            font-size: 14px;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }
        
        .fa, .fas, .far, .fab, .fal {
  font-family: "Font Awesome 5 Free" !important;
  font-weight: 900 !important;
  -webkit-font-smoothing: antialiased;
  display: inline-block;
  font-style: normal;
  font-variant: normal;
  text-rendering: auto;
  line-height: 1;
}

/* Moving Text Banner CSS */
.moving-text-container {
    width: 70%;
    max-width: 390px;
    margin: 15px auto;
    background: linear-gradient(135deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #ffeaa7, #dda0dd);
    background-size: 300% 300%;
    border-radius: 25px;
    padding: 0.5px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    animation: gradientShift 6s ease infinite;
    position: relative;
    overflow: hidden;
}

/* Dark mode styles */
[data-theme="dark"] .moving-text-container {
    background: linear-gradient(135deg, #e74c3c, #1abc9c, #3498db, #2ecc71, #f39c12, #9b59b6);
    background-size: 300% 300%;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

.moving-text-wrapper {
    background: var(--bg-secondary);
    border-radius: 20px;
    padding: 12px 20px;
    overflow: hidden;
    position: relative;
    height: 9px;
    display: flex;
    align-items: center;
}

.moving-text-content {
    display: flex;
    align-items: center;
    animation: moveLeft 60s linear infinite;
    white-space: nowrap;
    will-change: transform;
}

.moving-text-item {
    display: inline-flex;
    align-items: center;
    margin-right: 80px;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    transition: color 0.3s ease;
    white-space: nowrap;
}

.moving-text-item i {
    font-size: 16px;
    margin-right: 10px;
    color: #4F46E5;
    animation: pulse 2s ease-in-out infinite;
    filter: drop-shadow(0 0 3px rgba(79, 70, 229, 0.5));
}

/* Gradient background animation */
@keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

/* Moving text animation */
@keyframes moveLeft {
    0% { transform: translateX(0); }
    100% { transform: translateX(-50%); }
}

/* Icon pulse animation */
@keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
    100% { transform: scale(1); opacity: 1; }
}

/* Hover effects */
.moving-text-container:hover .moving-text-content {
    animation-play-state: paused;
}

.moving-text-container:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
}

/* Responsive design */
@media (max-width: 380px) {
    .moving-text-container {
        width: 95%;
    }
    
    .moving-text-item {
        font-size: 13px;
        margin-right: 60px;
    }
    
    .moving-text-item i {
        font-size: 14px;
        margin-right: 8px;
    }
}

/* Adjustable speed classes */
.moving-text-slow .moving-text-content {
    animation-duration: 90s;
}

.moving-text-fast .moving-text-content {
    animation-duration: 30s;
}

.moving-text-pause .moving-text-content {
    animation-play-state: paused;
}

/* Custom colors for different icons */
.moving-text-item:nth-child(1) i { color: #e74c3c; }
.moving-text-item:nth-child(2) i { color: #3498db; }
.moving-text-item:nth-child(3) i { color: #2ecc71; }
.moving-text-item:nth-child(4) i { color: #f39c12; }
.moving-text-item:nth-child(5) i { color: #e67e22; }
.moving-text-item:nth-child(6) i { color: #9b59b6; }


        /* Pagination */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px 0;
        }

        .pagination-info {
            font-size: 14px;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            border-color: #4F46E5;
            color: #4F46E5;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-current {
            font-weight: 600;
            color: #4F46E5;
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-overlay);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 15px;
            max-width: 350px;
            width: 90%;
            text-align: center;
            transition: all 0.3s ease;
        }

        .modal-content h2 {
            margin-bottom: 15px;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .modal-content p {
            margin-bottom: 20px;
            color: var(--text-secondary);
            line-height: 1.5;
            transition: color 0.3s ease;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-btn.primary {
            background: #4F46E5;
            color: white;
        }

        .modal-btn.secondary {
            background: var(--border-color);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ef4444;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .required {
            color: #ef4444;
        }

        .form-hint {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 10px;
            text-align: center;
            transition: color 0.3s ease;
        }

        #fileInput {
            display: none;
        }

        .update-notification {
            background: #3b82f6;
            color: white;
            padding: 15px;
            text-align: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1002;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .update-notification.show {
            transform: translateY(0);
        }

        .update-btn {
            background: white;
            color: #3b82f6;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            margin-left: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        .backup-reminder {
            background: #f59e0b;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            text-align: center;
            font-size: 12px;
        }
    
        .status-container {
            margin-top: 10px;
            font-size: 12px;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }

        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            margin-right: 5px;
            border-radius: 50%;
            background: gray;
            animation: pulse 1.5s infinite;
            vertical-align: middle;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.6; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .home-thread-item:hover {
    background-color: var(--hover-bg);
    border-color: #4F46E5;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(79, 70, 229, 0.1);
}

.thread-category {
    background: #4F46E5;
    color: white;
    padding: 2px 6px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 500;
}

/* SOS Floating Button */
.sos-button {
    position: fixed;
    bottom: 100px; /* Above the tab bar */
    left: 20px;
    width: 60px;
    height: 0px;
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(239, 68, 68, 0.4);
    transition: all 0.3s ease;
    z-index: 999;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    animation: pulse-sos 2s infinite;
}

.sos-button:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 25px rgba(239, 68, 68, 0.6);
    background: linear-gradient(135deg, #dc2626, #b91c1c);
}

.sos-button:active {
    transform: scale(0.95);
}

/* Pulse animation for SOS button */
@keyframes pulse-sos {
    0% {
        box-shadow: 0 4px 20px rgba(239, 68, 68, 0.4);
    }
    50% {
        box-shadow: 0 4px 30px rgba(239, 68, 68, 0.8);
    }
    100% {
        box-shadow: 0 4px 20px rgba(239, 68, 68, 0.4);
    }
}

/* Hide SOS button on resources tab */
.tab-content.active[id="resources"] ~ .sos-button {
    display: none;
}

/* Alternative approach - hide when resources tab is active */
body[data-active-tab="resources"] .sos-button {
    display: none;
}

/* Responsive adjustments */
@media (max-width: 480px) {
    .sos-button {
        width: 45px;
        height: 45px;
        font-size: 16px;
        bottom: 70px;
        right: 15px;
    }
}

.thread-detail-tab {
    width: 100%;
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    background: var(--card-background);
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

/* Dark mode adjustments */
[data-theme="dark"] .sos-button {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    box-shadow: 0 4px 20px rgba(239, 68, 68, 0.5);
}

[data-theme="dark"] .sos-button:hover {
    box-shadow: 0 6px 25px rgba(239, 68, 68, 0.7);
}

/* Mandatory Update Modal Styles */
#mandatoryUpdateModal .modal-content {
    border: 3px solid #4F46E5;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
}

#mandatoryUpdateModal .modal-btn:disabled {
    background: #9ca3af !important;
    cursor: not-allowed !important;
    transform: none !important;
}

#mandatoryUpdateModal .fa-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

        /* Dark mode specific adjustments */
        [data-theme="dark"] .status-badge.status-success {
            background: var(--success-bg);
            color: var(--success-text);
        }

        [data-theme="dark"] .status-badge.status-relapse {
            background: var(--error-bg);
            color: var(--error-text);
        }

        [data-theme="dark"] .form-control::placeholder {
            color: var(--text-muted);
        }

        [data-theme="dark"] .file-input {
            color: var(--text-secondary);
        }

        /* Responsive adjustments for small screens */
        @media (max-width: 380px) {
            .history-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .history-controls-left,
            .history-controls-right {
                justify-content: center;
                width: 100%;
            }

            .pagination {
                flex-direction: column;
                gap: 10px;
            }

            .pagination-controls {
                justify-content: center;
            }

            .tab {
                font-size: 8px;
                padding: 6px 2px;
            }

            .tab-icon {
                font-size: 16px;
            }
        }
        
        /* Loading Screen Styles */
.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 60px; /* Account for bottom tabs height */
    background: var(--bg-secondary);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 50;
    transition: opacity 0.3s ease;
}

.loading-overlay.hide {
    opacity: 0;
    pointer-events: none;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid var(--border-color);
    border-top: 4px solid #4F46E5;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
}

.loading-text {
    color: var(--text-primary);
    font-size: 16px;
    font-weight: 500;
    transition: color 0.3s ease;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.notification-item {
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.notification-item:hover {
    background-color: var(--bg-secondary);
}

.user-profile-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 15px;
}

.profile-stats {
    display: flex;
    gap: 20px;
    margin: 10px 0;
    font-size: 14px;
}

.profile-activity {
    font-size: 12px;
    color: var(--text-secondary);
}

.forum-stats-card {
    display: flex;
    justify-content: center;
    gap: 40px;
    padding: 20px;
    background: var(--card-bg);
    border-radius: 10px;
    border: 1px solid var(--border-color);
}

.stat-item {
    text-align: center;
}

.modal.show {
    display: flex !important;
}

#usernameInput {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 14px;
}

#usernameInput:focus {
    outline: none;
    border-color: #4F46E5;
}

.form-group small {
    display: block;
    margin-top: 5px;
    font-size: 12px;
}
        
    </style>
</head>
<body>
    <div id="updateNotification" class="update-notification">
        <div class="backup-reminder">⚠️ Please backup your data before updating!</div>
        <span>New version available!</span>
        <button class="update-btn" onclick="updateApp()">Update Now</button>
        <button class="update-btn" onclick="hideUpdateNotification()" style="background: rgba(255,255,255,0.2); color: white;">Later</button>
    </div>

    <div class="container"><!-- Floating Notification Bell -->
<button class="floating-notification-bell" id="floatingNotificationBtn" onclick="toggleNotifications()" title="Toggle Notifications">
    <i class="fas fa-bell"></i>
</button>
        <div class="header">

            <img src="https://miseducatemen.wordpress.com/wp-content/uploads/2025/08/disciplin-header-icon.png"/>
            
            <div class="header-buttons left">
                <button class="dark-mode-toggle" id="darkModeToggle" onclick="toggleDarkMode()" title="Toggle Dark Mode">
                    <i class="fas fa-moon"></i>
                </button></div><div class="header-buttons right">
                <button class="header-btn" id="installBtn" style="display: none;">Install App</button>
            </div>

            <div id="connectionStatus" class="status-container">
                <span id="statusIcon" class="status-dot"></span>
                <span id="statusText">Checking...</span>
            </div>
        </div>
<!-- Loading Screen -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading...</div>
</div>
        <div class="tabs">
         
            <button class="tab active" data-tab="home"><i class="fas fa-home tab-icon"></i><br>Home</button>
            <button class="tab" data-tab="howto"><i class="fas fa-question-circle tab-icon"></i><br>Guide</button>
            <button class="tab" data-tab="chat"><i class="fas fa-comments tab-icon"></i><br>Chat</button>

            <button class="tab" data-tab="log"><i class="fas fa-plus tab-icon"></i><br>Log</button>
            
                        <button class="tab" data-tab="insights"><i class="fas fa-solid fa-arrow-trend-up tab-icon"></i><br>Stats</button>
            <button class="tab" data-tab="journal"><i class="fas fa-book tab-icon"></i><br>Journal</button>
            <button class="tab" data-tab="history"><i class="fas fa-list tab-icon"></i><br>History</button>

        </div>

        <div id="home" class="tab-content active">
            <div id="notificationContainer" style="margin-bottom: 20px;"></div>
                <!-- SOS Floating Button -->
<button class="sos-button" id="sosButton" onclick="activateSOS()" title="Need help? Click for resources">
    SOS
</button>
            <!-- Moving Text Banner HTML Structure -->

<div class="moving-text-container"><center><b>ATTENTION</b></center>
    <div class="moving-text-wrapper">
        <div class="moving-text-content">
            <div class="moving-text-item">
                <i class="fas fa-wifi"></i>
                <span>To log entries, you need to turn on data</span>
            </div>
            <div class="moving-text-item">
                <i class="fas fa-download"></i>
                <span>Make sure to install the app on the top right corner</span>
            </div>
            <div class="moving-text-item">
                <i class="fas fa-cloud"></i>
                <span>You can back up your data with Google Cloud</span>
            </div>
            <div class="moving-text-item">
                <i class="fas fa-lightbulb"></i>
                <span>Success Tip: Be honest in your logs</span>
            </div>
            <div class="moving-text-item">
                <i class="fas fa-exclamation-triangle"></i>
                <span>If you decide to only use manual backup, be consistent in it</span>
            </div>
            <div class="moving-text-item">
                <i class="fas fa-comments"></i>
                <span>Use the chat tab to chat and show support to fellow users</span>
            </div>
              <div class="moving-text-item">
                <i class="fas fa-exclamation-triangle"></i><span>Make use of the SOS button on the home tab, incase of an urge</span></div>
            <!-- Duplicate for seamless loop -->
            <div class="moving-text-item">
                <i class="fas fa-wifi"></i>
                <span>To log entries, you need to turn on data</span>
            </div>
            <div class="moving-text-item">
                <i class="fas fa-download"></i>
                <span>Make sure to install the app on the top right corner</span>
            </div>
            <div class="moving-text-item">
                <i class="fas fa-cloud"></i>
                <span>You can back up your data with Google Cloud</span>
            </div>
            <div class="moving-text-item">
                <i class="fas fa-lightbulb"></i>
                <span>Success Tip: Be honest in your logs</span>
            </div>
            <div class="moving-text-item">
                <i class="fas fa-exclamation-triangle"></i>
                <span>If you decide to only use manual backup, be consistent in it</span>
            </div>
            <div class="moving-text-item">
                <i class="fas fa-comments"></i>
                <span>Use the chat tab to chat and show support to fellow users</span>
            </div>
              <div class="moving-text-item">
                <i class="fas fa-exclamation-triangle"></i><span>Make use of the SOS button on the home tab, incase of an urge</span></div>
        </div>
    </div>
</div>

            <!-- Level System -->
            <div class="level-system id="levelSystem">
                <div class="level-badge">
                    <i class="level-icon" id="levelIcon"></i>
                    <div class="level-text" id="levelText">Loading...</div>
                </div>
                <div class="xp-progress">
                    <div class="xp-fill" id="xpFill" style="width: 0%"></div>
                </div>
                <div class="xp-text" id="xpText">Loading XP...</div>
                
                <!-- Streak Flames -->
                <div class="streak-flames" id="streakFlames">
                    <!-- Flames will be generated by JavaScript -->
                </div>
            </div> <div class="stats-grid">
            <div style="text-align: center; margin: 20px 0;">
    <button onclick="switchTab('chat')" style="
        padding: 12px;
        background: var(--level-bg);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 15px;">
        <i class="fas fa-comments"></i> Join Community Chat
    </button>
</div>
            <div style="text-align: center; margin: 20px 0;">
    <button onclick="switchTab('forum')" style="
        padding: 12px;
        background: var(--level-bg);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 15px;">
        <i class="fas fa-comment"></i> View/Create Threads
    </button>
</div></div> <div class="card" style="margin-bottom: 20px;">
    <div id="homeRecentThreads">Loading forum threads...</div>
</div><!-- Goals Section --><div class="goals-section" style="margin-bottom: 30px;">
    <div class="goals-title" style="font-size: 18px; font-weight: 600; margin-bottom: 15px; text-align: center; color: var(--text-primary); transition: color 0.3s ease;">
        My Goals
    </div>
    <div id="goalsContainer">
        <!-- Goals will be populated here -->
    </div>
    <button onclick="showAddGoalModal()" style="
        width: 100%;
        padding: 12px;
        background: #4F46E5;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 15px;
    " onmouseover="this.style.background='#3730a3'" onmouseout="this.style.background='#4F46E5'">
        + Add New Goal
    </button>
</div>
 <div id="streakNotification" class="streak-notification" style="display: none;"></div>
<!-- timer section -->
<div id="timerSection" class="timer-section">
    <div class="timer-title" id="timerTitle">Clean Streak Timer</div>
    <div class="timer-subtitle" id="timerSubtitle">Time since your last relapse</div>
    
    <div class="timer-display">
        <div class="timer-unit">
            <div class="timer-number" id="timerDays">0</div>
            <div class="timer-label">Days</div>
        </div>
        <div class="timer-unit">
            <div class="timer-number" id="timerHours">0</div>
            <div class="timer-label">Hours</div>
        </div>
        <div class="timer-unit">
            <div class="timer-number" id="timerMinutes">0</div>
            <div class="timer-label">Minutes</div>
        </div>
        <div class="timer-unit">
            <div class="timer-number" id="timerSeconds">0</div>
            <div class="timer-label">Seconds</div>
        </div>
    </div>
    
    <div class="timer-status" id="timerStatus">No entries yet</div>
</div>
            <div class="stats-grid">            <div style="text-align: center; margin: 20px 0;">
                <button onclick="switchTab('howto')" style="
                    background: #4F46E5;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                " onmouseover="this.style.background='#3730a3'" onmouseout="this.style.background='#4F46E5'">
                    <i class="fas fa-info-circle"></i> How to <br>use this <br> App
                </button>
            </div>
            <div style="text-align: center; margin: 20px 0;">
                <button onclick="switchTab('resources')" style="
                    background: #ef4444;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                " onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
                    <i class="fas fa-shield-alt"></i> Anti Relapse Button
                </button>
            </div>
                <div class="stat-card">
                    <div class="stat-number" id="currentStreak">0</div>
                    <div class="stat-label">Current Streak</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="longestStreak">0</div>
                    <div class="stat-label">Longest Streak</div>
                </div>
            </div>
           
            <div class="achievements-section">
                <div class="achievements-title"><i class="fas fa-trophy"></i> Achievements</div>
                <div class="achievements-grid" id="achievementsGrid"></div>
            </div>
             <!-- Analytics Section -->
            <div class="analytics-section">
                <div class="analytics-title">Total Stats</div>
                <div class="analytics-stats">
                    <div class="analytics-card">
                        <div class="analytics-number" id="globalEntries">---</div>
                        <div class="analytics-label">Total Entries</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-number" id="activeUsers">---</div>
                        <div class="analytics-label">Active Users</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 10px; font-size: 12px; color: var(--text-muted); transition: color 0.3s ease;">
                    Real-time data from all Disciplin users
                </div>
            </div>
<br>        <p style="font-size: 12px; font-style: italic; color: var(--text-muted); margin-top: 20px; text-align: center; transition: color 0.3s ease;">Built with ❤️ by Smile >_<br>1000% Privacy<br>Hosted on GitHub </p>
            <div class="motivational-text" id="motivationalText">
                Everyday is a new day, to achieve something new
            </div>
        </div>

        <div id="howto" class="tab-content">
   <div style="background: var(--card-bg); border-radius: 15px; padding: 20px; margin-bottom: 20px; transition: all 0.3s ease;">
       <h2 style="text-align: center; margin-bottom: 10px; color: #4F46E5; font-size: 22px;">How to Use Disciplin</h2>
       <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary); font-size: 14px; transition: color 0.3s ease;">Version 3.5.0</p>
       
       <div style="line-height: 1.6; color: var(--text-primary); font-size: 14px; transition: color 0.3s ease;">
           <p style="margin-bottom: 15px;">Disciplin is an offline and online installable web app designed to track masturbation patterns, relapses and streaks depending on what the user logs, it is important to Install the app on your first visit, by clicking on "install app" on the top right corner of the web app.</p>

           <p style="margin-bottom: 15px;">With Disciplin, you can log "entries", these entries contain how your PREVIOUS day went and not your current day, you can only log one entry per day, if you need to log an entry again, you will have to delete the current entry for that day.</p>

           <p style="margin-bottom: 15px;">You can view the history of the entries you have submitted, you can delete each or in bulk depending on your preference.</p>

           <p style="margin-bottom: 15px;">You can view your personal stats, weekly or monthly, this shows you common patterns and with such information, you can adjust your strategy.</p>

           <p style="margin-bottom: 15px;">You can also earn continuous streaks(clean days) if you don't relapse after logging your first entry, there are also achievements to be conquered on your way to personal freedom.</p>

           <p style="margin-bottom: 20px;">You can back up your data whenever you want so as not to lose them incase of app failure or an update.</p>

           <h3 style="color: #4F46E5; font-weight: 600; margin-top: 20px; margin-bottom: 10px;">New Features</h3>
           <ul style="margin-left: 20px; margin-bottom: 20px;">
               <li><strong>Level System:</strong> Gain XP and levels based on your clean days and achievements</li>
               <li><strong>Streak Flames:</strong> Visual flames that grow with your consecutive clean days</li>
               <li><strong>Journal:</strong> Write personal reflections and track your thoughts</li>
               <li><strong>Personalized Insights:</strong> AI-powered insights based on your unique patterns</li>
               <li><strong>Goals:</strong> Set goals according to your streak or custom and let the app do the counting!</li> 
               <li><strong>Community Chat:</strong> A global community chat system powered by Firebase is now available on the Chat Tab</li>
               <li><strong>Google Cloud Sync:</strong> An optional method for data backup is now available, users can, with their google accounts be able to sync their data across devices, available in the history/backup tab.</li>
               <li><strong>Forum:</strong> Users can now create threads, reply to threads, like and delete threads! Available in Home tab.</li>
           </ul>

           <h3 style="color: #4F46E5; font-weight: 600; margin-top: 20px; margin-bottom: 10px;">Features</h3>
           <ul style="margin-left: 20px; margin-bottom: 20px;">
               <li>• Ability to log entries when online only</li>
               <li>• View Entries in History Tab</li>
               <li>• Delete Entries</li>
               <li>• Back up Entries in Back Up Tab(now in history tab)</li>
               <li>• View Personalized Stats in Stats Tab</li>
               <li>• Streak System with Visual Flames</li>
               <li>• Level System with XP progression</li>
               <li>• Personal Journal for reflections</li>
               <li>• AI-powered Personalized Insights</li>
               <li>• Chat with fellow Disciplin users in the chat tab</li>
               <li>• Create threads, reply and like threads, available in home tab
               <li>• Achievements Badges on Home Tab based on clean days, highest being 365 clean days</li>
               <li>• Anti Relapse/SOS Button to put you back on track</li>
               <li>• Dark and Light Mode</li>
               <li>• All data is stored on user device, no server is used(google cloud is optional)</li>
           </ul>

           <h3 style="color: #4F46E5; font-weight: 600; margin-top: 20px; margin-bottom: 10px;">Privacy</h3>
           <p style="margin-bottom: 15px;">Since this app deals with personal information, it is important you know how your data is being handled(entries). Disciplin is a client-side("as is") based web app, this means only optional data you opt for are being shared to google cloud for the purpose of syncing across devices, if you do not opt for this, your data("entries") will only be saved on your device and you could lose them if you dont't occasionally back up the data, we recommend you opt for google cloud backup, this way you dont't ever lose your data since they are automatically backup.</p>

           <p style="margin-bottom: 20px;">PLEASE NOTE: All data you enter here are saved on your device, this means you will lose your progress if you switch to another device without backing up your data(if you don't opt for google sync).</p>

           <h3 style="color: #4F46E5; font-weight: 600; margin-top: 20px; margin-bottom: 10px;">Terms of Service</h3>
           <p style="margin-bottom: 20px;">"Disciplin" is a free to use app and can also be used offline as well, however to submit an entry, use the chat tab and sync with google(optional), the user will have to be online, every other feature can be used when offline.</p>

           <h3 style="color: #4F46E5; font-weight: 600; margin-top: 20px; margin-bottom: 10px;">Contact</h3>
           <p style="margin-bottom: 20px;">If you would like to contact us for any partnership, suggestions or complaints(bug reports), please send a mail to <a href="mailto:ifexxy9@gmail.com" style="color: #4F46E5; text-decoration: underline;">ifexxy9@gmail.com</a>  or use the chat tab</p>

           <p style="font-size: 12px; font-style: italic; color: var(--text-muted); margin-top: 20px; text-align: center; transition: color 0.3s ease;">This doc was last updated Sunday 17th August, 2025</p>
       </div>
   </div>
   
   <div class="motivational-text" id="howtoMotivationalText">
       Everyday is a new day, to achieve something new
   </div>
</div>

        <div id="insights" class="tab-content">
            <!-- Personalized Insights -->
            <div class="insights-personal" id="personalizedInsights">
                <h3><i class="fas fa-brain"></i> Personalized Insights</h3>
                <div id="personalInsightsList">
                    <!-- Insights will be generated by JavaScript -->
                </div>
            </div>

            <div class="weekly-insights">
                <div class="insights-title">Stats Dashboard</div>
                <div id="weeklyInsights"></div>
            </div>
            
            <div class="motivational-text" id="insightsMotivationalText">
                Everyday is a new day, to achieve something new
            </div>
        </div>

        <div id="log" class="tab-content">
            <div class="motivational-text" id="logMotivationalText">
                Everyday is a new day, to achieve something new
            </div>
            <form id="logForm">
                <div class="form-group">
                    <label>Did you masturbate yesterday? <span class="required">*</span></label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="no" name="masturbated" value="no" required>
                            <label for="no">No</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="yes" name="masturbated" value="yes" required>
                            <label for="yes">Yes</label>
                        </div>
                    </div>

                    <div id="timeQuestion" class="conditional-question">
                        <label>What time of day did you masturbate? (Multiple answers allowed)</label>
                        <div class="checkbox-group">
                            <div class="checkbox-option">
                                <input type="checkbox" id="morning" name="timeOfDay" value="morning">
                                <label for="morning">Morning</label>
                            </div>
                            <div class="checkbox-option">
                                <input type="checkbox" id="afternoon" name="timeOfDay" value="afternoon">
                                <label for="afternoon">Afternoon</label>
                            </div>
                            <div class="checkbox-option">
                                <input type="checkbox" id="evening" name="timeOfDay" value="evening">
                                <label for="evening">Evening</label>
                            </div>
                            <div class="checkbox-option">
                                <input type="checkbox" id="nighttime" name="timeOfDay" value="nighttime">
                                <label for="nighttime">Nighttime</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>How is your energy level today? <span class="required">*</span></label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="low" name="energyLevel" value="Low" required>
                            <label for="low">Low</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="medium" name="energyLevel" value="Medium" required>
                            <label for="medium">Medium</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="high" name="energyLevel" value="High" required>
                            <label for="high">High</label>
                        </div>
                    </div>
                </div><br>
                <div class="form-group">
                    <label>What time did you sleep last night? <span class="required">*</span></label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="before8pm" name="sleepTime" value="Before 8pm" required>
                            <label for="before8pm">Before 8pm</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="8pm11pm" name="sleepTime" value="8pm - 11pm" required>
                            <label for="8pm11pm">8pm - 11pm</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="after12am" name="sleepTime" value="After 12am" required>
                            <label for="after12am">After 12am</label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>How are you feeling today?</label>
                    <div class="emoji-selector">
                        <button type="button" class="emoji-btn" data-mood="😊">😊</button>
                        <button type="button" class="emoji-btn" data-mood="😔">😔</button>
                        <button type="button" class="emoji-btn" data-mood="😤">😤</button>
                        <button type="button" class="emoji-btn" data-mood="💪">💪</button>
                        <button type="button" class="emoji-btn" data-mood="😌">😌</button>
                    </div>
                </div>

                <div class="form-group">
                    <p class="form-hint">If you masturbated, what caused it? (write on the optional notes if any)</p>
                    <label>Optional Notes</label>
                    <textarea class="form-control" id="notes" rows="4" placeholder="Any additional thoughts or triggers..."></textarea>
                </div>

                <button type="submit" class="btn" id="logSubmitBtn">Log Entry</button>
            </form>
        </div>

        <!-- New Journal Tab -->
        <div id="journal" class="tab-content">
            <div class="journal-form">
                <h3 style="color: #4F46E5; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-pen"></i> Journal
                </h3>

                <div class="form-group">

                    <textarea 
                        class="form-control" 
                        id="journalText" 
                        rows="6" 
                        placeholder="Write about your day, thoughts, challenges, victories, or anything on your mind..."></textarea>
                </div>
                <button type="button" class="btn" onclick="saveJournalEntry()">
                  Save(+5 XP)
                </button>
            </div>

            <div id="journalEntries">
                <!-- Journal entries will be loaded here -->
            </div>

         
        </div>

        <div id="history" class="tab-content">
            <!-- History Controls -->
            <div class="history-controls">
                <div class="history-controls-left">
                    <button class="select-all-btn" id="selectAllBtn" onclick="toggleSelectAll()">
                        Select All
                    </button>
                    <span class="selected-count" id="selectedCount">0 selected</span>
                </div>
                <div class="history-controls-right">
                    <button class="delete-selected-btn" id="deleteSelectedBtn" onclick="deleteSelectedEntries()" disabled>
                        Delete Selected
                    </button>
                </div>
                  <button onclick="switchTab('backup')" style="
        width: 100%;
        padding: 12px;
        background: #4F46E5;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 15px;
    " onmouseover="this.style.background='#3730a3'" onmouseout="this.style.background='#4F46E5'">
        <i class="fas fa-info-circle"></i> Click Here to Backup Your Data (incl. Journals)
    </button>  <button onclick="firebaseManager.signInWithGoogle()" style="
        width: 100%;
        padding: 12px;
        background: #4F46E5;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 15px;
    " onmouseover="this.style.background='#3730a3'" onmouseout="this.style.background='#4F46E5'"><i class="fas fa-solid fa-cloud"></i> Click here to sync with Google (excl. Journals) </button>
            </div>

            <!-- History List -->
            <div id="historyList"></div>

            <!-- Pagination -->
            <div class="pagination" id="historyPagination">
                <div class="pagination-info" id="paginationInfo">
                    Showing 0 of 0 entries
                </div>
                <div class="pagination-controls">
                    <button class="pagination-btn" id="prevBtn" onclick="previousPage()" disabled>
                        Previous
                    </button>
                    <span class="pagination-current" id="currentPage">1</span>
                    <button class="pagination-btn" id="nextBtn" onclick="nextPage()" disabled>
                        Next
                    </button>
                </div>
            </div>
        </div>

        <div id="backup" class="tab-content">
            <div class="backup-section">
                <div class="backup-title"><i class="fas fa-cloud"></i> Backup & Import</div>
                <p style="margin-bottom: 15px; color: var(--text-secondary); text-align: center; font-size: 14px; transition: color 0.3s ease;">
                    Export your data to keep it safe, or import from a previous backup.
                </p>
                
                <div class="backup-buttons">
                    <button class="backup-btn export" onclick="exportData()"><i class="fas fa-download"></i> Export Data</button>
                    <button class="backup-btn import" onclick="document.getElementById('fileInput').click()"><i class="fas fa-upload"></i> Import Data</button>
                </div>

                <input type="file" id="fileInput" accept=".json" onchange="importData(event)">
                
                <div class="file-input" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-file-upload"></i> Click here or use the Import button to select your backup file
                </div>

            </div>

            <div class="motivational-text">
                Keep your progress safe with regular backups
            </div>
        </div>
        
<div id="forum" class="tab-content">
    <!-- Forum Header -->
    <div class="forum-header" style="background: var(--card-bg); border-radius: 15px; padding: 20px; margin-bottom: 20px; transition: all 0.3s ease;">
    <div id="userProfile" style="margin-bottom: 20px;"></div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2 style="color: #4F46E5; font-size: 22px; margin: 0;">Community Forum</h2>
            <div style="display: flex; gap: 10px; align-items: center;">
                <span id="authStatus" style="font-size: 12px; color: var(--text-secondary);"></span>
                <button id="authBtn" class="btn" style="padding: 8px 16px; font-size: 14px; width: auto;">Sign In</button>
            </div>
        </div>
        
        <!-- Category Filter -->
        <div style="margin-bottom: 15px;">
            <select id="categoryFilter" style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text-primary);">
                <option value="">All Categories</option>
            </select>
        </div>

        <!-- Create Thread Button -->
        <button id="createThreadBtn" class="btn" style="width: 100%; display: none;">Create New Thread</button>
    </div>

    <!-- Thread List -->
    
<div class="forum-rules" style="margin-bottom: 20px; padding: 15px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-secondary); text-align: left;">
  <h3 style="margin-bottom: 10px; color: #4F46E5;">Forum Rules</h3>
  <ul style="padding-left: 20px; line-height: 1.6; margin: 0;">
    <li>Be respectful to others, no harassment, hate speech, or personal attacks.</li>
    <li>Stay on topic, create threads in the appropriate category.</li>
    <li>No spam or self-promotion without permission.</li>
    <li>Use clear titles and provide enough details when starting a thread.</li>
    <li>Do not share personal information you wouldn’t want public.</li>
    <li>Threads are sorted by most recent.</li>
      <li>Most topics should go under "general" except otherwise.</li>
  </ul>
  <p style="margin-top: 10px; font-size: 13px; color: var(--text-secondary);">
    By posting, you agree to follow these rules. Violations may lead to removal of content or account restrictions.
  </p>
</div>
<input type="text" id="threadSearch" placeholder="Search threads..." class="form-control" style="margin-bottom: 15px; width: 100%;">


    <div id="threadList"></div>
<div id="forumStats" style="margin-top: 30px; text-align: center;"></div>
    <!-- Pagination -->
    <div class="forum-pagination" style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
        <div id="forumPaginationInfo" style="font-size: 14px; color: var(--text-secondary);"></div>
        <div style="display: flex; gap: 10px;">
            <button id="forumPrevBtn" class="pagination-btn" disabled>Previous</button>
            <span id="forumCurrentPage" style="font-weight: 600; color: #4F46E5;">1</span>
            <button id="forumNextBtn" class="pagination-btn" disabled>Next</button>
        </div>
    </div>
   
<div id="threadDetailTab" class="thread-detail-tab" style="display: none;">
    <button id="backToThreadsBtn" class="btn-secondary">← Back to Threads</button>
    <div id="threadDetailContent"></div>
</div>
    <!-- Create Thread Modal -->
    <div id="createThreadModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h2>Create New Thread</h2>
            <form id="createThreadForm">
                <div class="form-group">
                    <label>Title <span class="required">*</span></label>
                    <input type="text" id="threadTitle" class="form-control" required maxlength="100">
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="threadCategory" class="form-control">
                        <option value="general">General</option>
                        
                        <option value="motivation">Motivation</option>
                        <option value="tips">Tips & Strategies</option>
                        <option value="success">Success Stories</option>
                        <option value="support">Support</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Content <span class="required">*</span></label>
                    <textarea id="threadContent" class="form-control" rows="5" required maxlength="2000"></textarea>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="modal-btn secondary" onclick="closeCreateThreadModal()">Cancel</button>
                    <button type="submit" class="modal-btn primary">Create Thread</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Thread Detail Modal -->
    <div id="threadDetailModal" class="modal">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div id="threadDetailContent"></div>
            <button class="modal-btn secondary" onclick="closeThreadDetailModal()" style="width: 100%; margin-top: 20px;">Close</button>
        </div>
    </div>
</div>
<div id="resources" class="tab-content">
    <div style="background: var(--card-bg); border-radius: 15px; padding: 20px; margin-bottom: 20px; transition: all 0.3s ease;">
        <h2 style="text-align: center; margin-bottom: 20px; color: #4F46E5; font-size: 24px;">
            <i class="fas fa-shield-alt" style="margin-right: 8px;"></i>Anti-Relapse Resource Center
        </h2>
        
        <div style="background: var(--error-bg); color: var(--error-text); padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; border-left: 4px solid #ef4444;">
            <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
            <strong>Emergency Mode Active</strong> - You're here because you need support right now!
        </div>

        <div style="line-height: 1.6; color: var(--text-primary); font-size: 14px; transition: color 0.3s ease;">
            <p style="margin-bottom: 20px; font-size: 16px; font-weight: 600; text-align: center; color: #4F46E5;">
                <i class="fas fa-hand-paper" style="margin-right: 8px;"></i>STOP - Take a deep breath. You have the power to choose differently.
            </p>

            <div style="background: var(--success-bg); color: var(--success-text); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: var(--success-text); font-weight: 600; margin-bottom: 10px; font-size: 16px;">
                    <i class="fas fa-bolt" style="margin-right: 8px;"></i>Immediate Action Steps
                </h3>
                <ul style="margin-left: 20px; margin-bottom: 0;">
                    <li style="margin-bottom: 8px;"><i class="fas fa-mobile-alt" style="margin-right: 8px; color: var(--success-text);"></i>Put your device down immediately</li>
                    <li style="margin-bottom: 8px;"><i class="fas fa-walking" style="margin-right: 8px; color: var(--success-text);"></i>Go for a 10-minute walk or do 20 push-ups</li>
                    <li style="margin-bottom: 8px;"><i class="fas fa-tint" style="margin-right: 8px; color: var(--success-text);"></i>Splash cold water on your face</li>
                    <li style="margin-bottom: 8px;"><i class="fas fa-phone" style="margin-right: 8px; color: var(--success-text);"></i>Call or text a friend or family member</li>
                    <li style="margin-bottom: 0;"><i class="fas fa-book-open" style="margin-right: 8px; color: var(--success-text);"></i>Read this entire page before making any decisions</li>
                </ul>
            </div>

            <h3 style="color: #4F46E5; font-weight: 600; margin-top: 25px; margin-bottom: 15px; font-size: 18px;">
                <i class="fas fa-brain" style="margin-right: 8px;"></i>Remember Why You Started
            </h3>
            <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #4F46E5;">
                <p style="margin-bottom: 15px;">You downloaded Disciplin because you recognized that compulsive sexual behavior was affecting your life negatively. You took control and decided to change.</p>
                <p style="margin-bottom: 15px; font-weight: 600;">Your current streak represents days of:</p>
                <ul style="margin-left: 20px;">
                    <li style="margin-bottom: 5px;"><i class="fas fa-check" style="margin-right: 8px; color: #10b981;"></i>Self-discipline and mental strength</li>
                    <li style="margin-bottom: 5px;"><i class="fas fa-check" style="margin-right: 8px; color: #10b981;"></i>Improved energy and focus</li>
                    <li style="margin-bottom: 5px;"><i class="fas fa-check" style="margin-right: 8px; color: #10b981;"></i>Better sleep quality and mood</li>
                    <li style="margin-bottom: 5px;"><i class="fas fa-check" style="margin-right: 8px; color: #10b981;"></i>Increased confidence and self-respect</li>
                    <li style="margin-bottom: 0;"><i class="fas fa-check" style="margin-right: 8px; color: #10b981;"></i>Progress toward your personal goals</li>
                </ul>
            </div>

            <h3 style="color: #4F46E5; font-weight: 600; margin-top: 25px; margin-bottom: 15px; font-size: 18px;">
                <i class="fas fa-fire" style="margin-right: 8px;"></i>The Urge is Temporary - Your Progress is Permanent
            </h3>
            <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <p style="margin-bottom: 15px;">Every urge you resist makes you stronger. This feeling will pass in 10-15 minutes if you don't feed it with attention.</p>
                <p style="margin-bottom: 15px; font-style: italic;">"The pain of discipline weighs ounces, but the pain of regret weighs tons."</p>
                <p style="margin-bottom: 0;">How will you feel 30 minutes from now if you relapse? Compare that to how proud you'll feel if you overcome this urge.</p>
            </div>

            <h3 style="color: #4F46E5; font-weight: 600; margin-top: 25px; margin-bottom: 15px; font-size: 18px;">
                <i class="fas fa-tools" style="margin-right: 8px;"></i>Coping Strategies That Work
            </h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; border-left: 4px solid #10b981;">
                    <h4 style="color: var(--text-primary); margin-bottom: 10px; font-size: 14px;">
                        <i class="fas fa-dumbbell" style="margin-right: 8px; color: #10b981;"></i>Physical
                    </h4>
                    <ul style="font-size: 12px; margin-left: 15px;">
                        <li>Exercise or stretch</li>
                        <li>Cold shower</li>
                        <li>Go outside</li>
                        <li>Clean your space</li>
                    </ul>
                </div>
                <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; border-left: 4px solid #3b82f6;">
                    <h4 style="color: var(--text-primary); margin-bottom: 10px; font-size: 14px;">
                        <i class="fas fa-brain" style="margin-right: 8px; color: #3b82f6;"></i>Mental
                    </h4>
                    <ul style="font-size: 12px; margin-left: 15px;">
                        <li>Practice breathing</li>
                        <li>Write in journal</li>
                        <li>Meditate 5 mins</li>
                        <li>Positive self-talk</li>
                    </ul>
                </div>
                <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; border-left: 4px solid #f59e0b;">
                    <h4 style="color: var(--text-primary); margin-bottom: 10px; font-size: 14px;">
                        <i class="fas fa-users" style="margin-right: 8px; color: #f59e0b;"></i>Social
                    </h4>
                    <ul style="font-size: 12px; margin-left: 15px;">
                        <li>Call someone</li>
                        <li>Visit family/friends</li>
                        <li>Join communities</li>
                        <li>Help others</li>
                    </ul>
                </div>
                <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; border-left: 4px solid #8b5cf6;">
                    <h4 style="color: var(--text-primary); margin-bottom: 10px; font-size: 14px;">
                        <i class="fas fa-palette" style="margin-right: 8px; color: #8b5cf6;"></i>Creative
                    </h4>
                    <ul style="font-size: 12px; margin-left: 15px;">
                        <li>Learn new skill</li>
                        <li>Play music</li>
                        <li>Read a book</li>
                        <li>Work on hobbies</li>
                    </ul>
                </div>
            </div>

            <h3 style="color: #4F46E5; font-weight: 600; margin-top: 25px; margin-bottom: 15px; font-size: 18px;">
                <i class="fas fa-lightbulb" style="margin-right: 8px;"></i>Understanding Your Triggers
            </h3>
            <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <p style="margin-bottom: 15px;">Common triggers include:</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div><i class="fas fa-bed" style="margin-right: 8px; color: #ef4444;"></i>Boredom or loneliness</div>
                    <div><i class="fas fa-frown" style="margin-right: 8px; color: #ef4444;"></i>Stress or anxiety</div>
                    <div><i class="fas fa-moon" style="margin-right: 8px; color: #ef4444;"></i>Late night phone use</div>
                    <div><i class="fas fa-laptop" style="margin-right: 8px; color: #ef4444;"></i>Unrestricted internet</div>
                    <div><i class="fas fa-user-friends" style="margin-right: 8px; color: #ef4444;"></i>Social media scrolling</div>
                    <div><i class="fas fa-clock" style="margin-right: 8px; color: #ef4444;"></i>Specific times of day</div>
                </div>
                <p style="margin-bottom: 0; font-weight: 600;">Identify your trigger and remove yourself from that situation immediately.</p>
            </div>

            <h3 style="color: #4F46E5; font-weight: 600; margin-top: 25px; margin-bottom: 15px; font-size: 18px;">
                <i class="fas fa-chart-line" style="margin-right: 8px;"></i>Benefits You're Working Toward
            </h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <i class="fas fa-battery-full" style="font-size: 24px; margin-bottom: 8px;"></i>
                    <h4 style="margin-bottom: 8px;">Higher Energy</h4>
                    <p style="font-size: 12px; margin: 0;">Feel more alert and motivated throughout the day</p>
                </div>
                <div style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <i class="fas fa-eye" style="font-size: 24px; margin-bottom: 8px;"></i>
                    <h4 style="margin-bottom: 8px;">Better Focus</h4>
                    <p style="font-size: 12px; margin: 0;">Improved concentration and mental clarity</p>
                </div>
                <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <i class="fas fa-smile-beam" style="font-size: 24px; margin-bottom: 8px;"></i>
                    <h4 style="margin-bottom: 8px;">Confidence</h4>
                    <p style="font-size: 12px; margin: 0;">Increased self-esteem and social confidence</p>
                </div>
                <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <i class="fas fa-bed" style="font-size: 24px; margin-bottom: 8px;"></i>
                    <h4 style="margin-bottom: 8px;">Better Sleep</h4>
                    <p style="font-size: 12px; margin: 0;">More restful and consistent sleep patterns</p>
                </div>
            </div>

            <h3 style="color: #4F46E5; font-weight: 600; margin-top: 25px; margin-bottom: 15px; font-size: 18px;">
                <i class="fas fa-question-circle" style="margin-right: 8px;"></i>Ask Yourself These Questions
            </h3>
            <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <ul style="margin-left: 20px;">
                    <li style="margin-bottom: 10px;"><i class="fas fa-clock" style="margin-right: 8px; color: #4F46E5;"></i>How will I feel in 1 hour if I relapse?</li>
                    <li style="margin-bottom: 10px;"><i class="fas fa-calendar-alt" style="margin-right: 8px; color: #4F46E5;"></i>Will this decision help me reach my goals?</li>
                    <li style="margin-bottom: 10px;"><i class="fas fa-heart" style="margin-right: 8px; color: #4F46E5;"></i>What would someone I respect think of this choice?</li>
                    <li style="margin-bottom: 10px;"><i class="fas fa-trophy" style="margin-right: 8px; color: #4F46E5;"></i>Is temporary pleasure worth losing my progress?</li>
                    <li style="margin-bottom: 0;"><i class="fas fa-muscle" style="margin-right: 8px; color: #4F46E5;"></i>What can I do right now that my future self will thank me for?</li>
                </ul>
            </div>

            <h3 style="color: #4F46E5; font-weight: 600; margin-top: 25px; margin-bottom: 15px; font-size: 18px;">
                <i class="fas fa-first-aid" style="margin-right: 8px;"></i>If You Do Relapse
            </h3>
            <div style="background: var(--card-bg); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <p style="margin-bottom: 15px;">Recovery is not about perfection - it's about progress and getting back up when you fall.</p>
                <ul style="margin-left: 20px; margin-bottom: 15px;">
                    <li style="margin-bottom: 8px;"><i class="fas fa-ban" style="margin-right: 8px; color: #ef4444;"></i>Don't binge - stop immediately after a slip</li>
                    <li style="margin-bottom: 8px;"><i class="fas fa-pen" style="margin-right: 8px; color: #3b82f6;"></i>Log it honestly in the app</li>
                    <li style="margin-bottom: 8px;"><i class="fas fa-search" style="margin-right: 8px; color: #f59e0b;"></i>Analyze what led to the relapse</li>
                    <li style="margin-bottom: 8px;"><i class="fas fa-heart" style="margin-right: 8px; color: #10b981;"></i>Practice self-compassion, not self-punishment</li>
                    <li style="margin-bottom: 0;"><i class="fas fa-play" style="margin-right: 8px; color: #8b5cf6;"></i>Start your new streak immediately</li>
                </ul>
                <p style="margin-bottom: 0; font-style: italic;">"A champion is defined not by their wins but by how they can recover when they fall." - Serena Williams</p>
            </div>

            <div style="background: linear-gradient(135deg, #4F46E5, #3730a3); color: white; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 20px;">
                <i class="fas fa-fist-raised" style="font-size: 32px; margin-bottom: 15px;"></i>
                <h3 style="margin-bottom: 15px; font-size: 20px;">You Are Stronger Than This Urge</h3>
                <p style="margin-bottom: 15px; font-size: 16px;">Every time you resist, you prove to yourself that you have control over your impulses.</p>
                <p style="margin-bottom: 0; font-weight: 600; font-size: 18px;">Close this app, put down your device, and do something that moves you forward.</p>
            </div>

            <div style="text-align: center; margin-top: 25px; padding: 15px; background: var(--card-bg); border-radius: 10px;">
                <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 10px; transition: color 0.3s ease;">Need professional support?</p>
                <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 0; transition: color 0.3s ease;">
                    <i class="fas fa-phone" style="margin-right: 4px;"></i>Consider speaking with a counselor or therapist who specializes in compulsive sexual behaviors.
                </p>
            </div>
        </div>
    </div>
    
    <div class="motivational-text" id="resourcesMotivationalText">
        Everyday is a new day, to achieve something new
    </div>
</div>
<div id="chat" class="tab-content">
    <!-- Authentication Section -->
    <div id="authSection" class="auth-section">
        <div class="auth-title">Join the Community Chat</div>
        <div class="auth-subtitle">Welcome to the Disciplin community chat!
<br>
Share encouragement, tips, and support with fellow users.</div>
        
        <div class="auth-buttons">
            <button class="auth-btn google-btn" onclick="signInWithGoogle()">
                <i class="fas fa-google"></i> Continue with Google
            </button>
            <button class="auth-btn anonymous-btn" onclick="showAnonymousModal()">
                <i class="fas fa-user-secret"></i> Join Anonymously
            </button>
            <button class="auth-btn email-btn" onclick="showEmailModal()">
                <i class="fas fa-envelope"></i> Sign up with Email
            </button>
        </div>
    </div>
     <!-- Chat Interface -->
      <div style="background: var(--card-bg); border-radius: 15px; padding: 20px; margin-bottom: 20px; transition: all 0.3s ease;">
       <h2 style="text-align: center; margin-bottom: 10px; color: #4F46E5; font-size: 22px;">Disciplin Community Chat </h2> <div style="line-height: 1.6; color: var(--text-primary); font-size: 14px; transition: color 0.3s ease;">
           <p style="margin-bottom: 15px;"><b>RULE:</b> Please respond appropriately and treat others with respect, make sure your comment is relevant to whatever discussion ongoing in the chat space.<br></p></div></div>
    <div id="chatInterface" class="chat-interface" style="display: none;">  
        <div class="chat-header">
            <div class="chat-user-info">
                <span id="chatUsername">Loading...please wait</span>
                <button class="logout-btn" onclick="signOut()">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be loaded here -->
        </div>
        
        <div class="chat-input-container">
            <input type="text" id="messageInput" placeholder="Type your message..." maxlength="500">
            <button id="sendButton" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
           <span class="chat-rules">
                    <i class="fas fa-info-circle"></i>
                    Be respectful and supportive(15 secs cool down enabled)
                </span>
        </div>

    <!-- Modals -->
    <div id="welcomeModal" class="modal">
        <div class="modal-content">
            <h2>Welcome to Disciplin</h2>
            <p>First time? Please install the app by clicking on "Install App" to enjoy full offline capabilities. Disciplin is an app for tracking compulsive sexual behavior, such as masturbation and porn addiction, Please proceed to read the full guide by clicking continue. </p>
            <button class="modal-btn primary" onclick="switchTab('guide')">Continue</button> or <button class="modal-btn primary" onclick="closeWelcomeModal()">Close Pop Up</button>
        </div>
    </div>
<!-- Anonymous Username Modal -->
        <div id="anonymousModal" class="modal">
        <div class="modal-content">
            <h2>Choose a Username</h2>
            <p>Enter a username to join the chat anonymously:</p>
            <input type="text" id="anonymousUsername" placeholder="Your username..." maxlength="20">
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeAnonymousModal()">Cancel</button>
                <button class="modal-btn primary" onclick="signInAnonymously()">Join Chat</button>
            </div>
        </div>
    </div>

    <!-- Email Registration Modal -->
    <div id="emailModal" class="modal">
        <div class="modal-content">
            <h2>Create Account</h2>
            <input type="email" id="emailInput" placeholder="Email address...">
            <input type="password" id="passwordInput" placeholder="Password..." minlength="6">
            <input type="text" id="emailUsername" placeholder="Display name..." maxlength="20">
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeEmailModal()">Cancel</button>
                <button class="modal-btn primary" onclick="signUpWithEmail()">Create Account</button>
            </div>
            <p style="text-align: center; margin-top: 10px;">
                <a href="#" onclick="switchToSignIn()">Already have an account? Sign in</a>
            </p>
        </div>
    </div>

    <!-- Email Sign In Modal -->
    <div id="signInModal" class="modal">
        <div class="modal-content">
            <h2>Sign In</h2>
            <input type="email" id="signInEmail" placeholder="Email address...">
            <input type="password" id="signInPassword" placeholder="Password...">
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeSignInModal()">Cancel</button>
                <button class="modal-btn primary" onclick="signInWithEmail()">Sign In</button>
            </div>
            <p style="text-align: center; margin-top: 10px;">
                <a href="#" onclick="switchToSignUp()">Don't have an account? Sign up</a>
            </p>
        </div>
    </div>
</div>
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h2>Delete Entry</h2>
            <p>Are you sure you want to delete this entry? This action cannot be undone.</p>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="modal-btn primary" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>
<div id="usernameModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Choose Your Username</h3>
        </div>
        <form id="usernameForm">
            <div class="form-group">
                <label>Username (required)</label>
                <input type="text" id="usernameInput" class="form-control" 
                       placeholder="Enter a unique username" required 
                       maxlength="20" pattern="[a-zA-Z0-9_]+" 
                       title="Only letters, numbers, and underscores allowed">
                <small style="color: var(--text-muted);">Username will be used for mentions (@username)</small>
            </div>
            <div class="form-actions">
                <button type="submit">Continue to Forum</button>
            </div>
        </form>
    </div>
</div>
    <div id="deleteSelectedModal" class="modal">
        <div class="modal-content">
            <h2>Delete Selected Entries</h2>
            <p id="deleteSelectedText">Are you sure you want to delete the selected entries? This action cannot be undone.</p>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeDeleteSelectedModal()">Cancel</button>
                <button class="modal-btn primary" onclick="confirmDeleteSelected()">Delete All</button>
            </div>
        </div>
    </div>

    <div id="notificationModal" class="modal">
        <div class="modal-content">
            <h2>Enable Notifications</h2>
            <p>Get reminded to check in with your progress if you haven't opened the app in 6 hours. This helps maintain consistency in your journey.</p>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeNotificationModal()">Cancel</button>
                <button class="modal-btn primary" onclick="enableNotifications()">Enable</button>
            </div>
        </div>
    </div>
<!-- Add Goal Modal -->
<div id="addGoalModal" class="modal">
    <div class="modal-content">
        <h2>Set a New Goal</h2>
        <div class="form-group" style="margin-bottom: 20px; text-align: left;">
            <label>Goal Type</label>
            <div class="radio-group" style="justify-content: center; margin-bottom: 15px;">
                <div class="radio-option">
                    <input type="radio" id="streakGoal" name="goalType" value="streak" checked>
                    <label for="streakGoal">Streak Goal</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="customGoal" name="goalType" value="custom">
                    <label for="customGoal">Custom Goal</label>
                </div>
            </div>
            <input type="number" id="goalTarget" placeholder="Target (days/count)" min="1" max="365" class="form-control" style="margin-bottom: 10px;">
            <input type="text" id="goalTitle" placeholder="Goal title (optional)" class="form-control" style="margin-bottom: 10px;">
            <textarea id="goalDescription" placeholder="Goal description (optional)" class="form-control" rows="2"></textarea>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn secondary" onclick="closeAddGoalModal()">Cancel</button>
            <button class="modal-btn primary" onclick="createGoal()">Create Goal</button>
        </div>
    </div>
</div>

<!-- Goal Achievement Modal -->
<div id="goalAchievementModal" class="modal">
    <div class="modal-content">
        <h2> Goal Achieved!</h2>
        <p id="achievementText">Congratulations! You've reached your goal!</p>
        <button class="modal-btn primary" onclick="closeGoalAchievementModal()">Awesome!</button>
    </div>
</div>
    <div id="notification" class="notification"></div>
<!-- Mandatory Update Modal -->
<div id="mandatoryUpdateModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div style="text-align: center; margin-bottom: 20px;">
            <i class="fas fa-download" style="font-size: 40px; color: #4F46E5; margin-bottom: 15px;"></i>
        </div>
        <h2 style="text-align: center; color: #4F46E5;">Update Required</h2>
        <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 15px; margin: 15px 0;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <i class="fas fa-exclamation-triangle" style="color: #f59e0b; font-size: 20px;"></i>
                <strong style="color: #92400e;">Important: Automatic Backup is Enabled</strong>
            </div>
            <p style="color: #92400e; font-size: 14px; margin: 0;">
                No need to backup, your data is saved locally unless you cleared cache, we recommend you make use of google sync.
            </p>
        </div>
        <p style="text-align: center; margin-bottom: 20px; color: var(--text-secondary);">
            A new version of Disciplin is available with improvements and bug fixes. The update will be applied automatically.
        </p>
        <div style="display: flex; gap: 10px;">
            
            <button class="modal-btn primary" onclick="applyMandatoryUpdate()" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                <i class="fas fa-sync-alt"></i>
                Update Now
            </button>
        </div>
    </div>
</div>
    <!-- Analytics Integration Script -->
    <script>
        // Analytics integration for Disciplin app
        class DisciplinAnalytics {
            constructor() {
                // Configuration
                this.config = {
                    backendUrl: 'https://disciplinback-production.up.railway.app', // Your Railway backend URL
                    enabled: true, // Set to false to disable analytics
                    heartbeatInterval: 5 * 60 * 1000, // 5 minutes
                    retryAttempts: 3,
                    retryDelay: 1000,
                    fetchInterval: 30 * 1000 // 30 seconds for fetching global stats
                };
                
                // State
                this.userId = null;
                this.sessionId = null;
                this.heartbeatTimer = null;
                this.fetchTimer = null;
                this.isOnline = navigator.onLine;
                this.pendingRequests = [];
                
                this.init();
            }
            
            async init() {
                if (!this.config.enabled) return;
                
                try {
                    // Get or create user ID from localStorage
                    this.userId = localStorage.getItem('disciplin_user_id');
                    
                    await this.initSession();
                    this.startHeartbeat();
                    this.startFetchingStats();
                    this.setupEventListeners();
                    
                    console.log('📊 Disciplin Analytics initialized');
                } catch (error) {
                    console.warn('Analytics initialization failed:', error);
                }
            }
            
            async initSession() {
                try {
                    const response = await this.makeRequest('/api/init-session', {
                        method: 'POST',
                        body: JSON.stringify({
                            userId: this.userId
                        })
                    });
                    
                    if (response.success) {
                        this.userId = response.userId;
                        this.sessionId = response.sessionId;
                        
                        // Store user ID for future sessions
                        localStorage.setItem('disciplin_user_id', this.userId);
                        
                        console.log('📊 Session initialized:', this.sessionId);
                    }
                } catch (error) {
                    console.warn('Failed to initialize session:', error);
                }
            }
            
            async trackEntry(entryCount = 1, entryType = 'log', metadata = {}) {
                if (!this.config.enabled || !this.userId) return;
                
                try {
                    const response = await this.makeRequest('/api/track-entry', {
                        method: 'POST',
                        body: JSON.stringify({
                            userId: this.userId,
                            sessionId: this.sessionId,
                            entryCount,
                            entryType,
                            metadata: {
                                ...metadata,
                                timestamp: new Date().toISOString(),
                                userAgent: navigator.userAgent,
                                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                            }
                        })
                    });
                    
                    if (response.success) {
                        console.log('📊 Entry tracked:', entryCount, entryType);
                        // Immediately fetch updated stats
                        this.fetchGlobalStats();
                    }
                } catch (error) {
                    console.warn('Failed to track entry:', error);
                    // Queue for retry when online
                    this.queueRequest('trackEntry', arguments);
                }
            }
            
            async sendHeartbeat() {
                if (!this.config.enabled || !this.userId) return;
                
                try {
                    const response = await this.makeRequest('/api/heartbeat', {
                        method: 'POST',
                        body: JSON.stringify({
                            userId: this.userId,
                            sessionId: this.sessionId
                        })
                    });
                    
                    if (response.success) {
                        console.log('💓 Heartbeat sent');
                    }
                } catch (error) {
                    console.warn('Heartbeat failed:', error);
                }
            }
            
            async fetchGlobalStats() {
                if (!this.config.enabled) return;
                
                try {
                    const response = await this.makeRequest('/api/analytics', {
                        method: 'GET'
                    });
                    
                    if (response.success && response.data) {
                        this.updateGlobalStatsUI(response.data);
                        console.log('📊 Global stats updated');
                    }
                } catch (error) {
                    console.warn('Failed to fetch global stats:', error);
                }
            }
            
            updateGlobalStatsUI(data) {
                const globalEntriesEl = document.getElementById('globalEntries');
                const activeUsersEl = document.getElementById('activeUsers');
                
                if (globalEntriesEl && data.totalEntries !== undefined) {
                    // Animate number change
                    this.animateNumber(globalEntriesEl, parseInt(globalEntriesEl.textContent) || 0, data.totalEntries);
                }
                
                if (activeUsersEl && data.activeUsers !== undefined) {
                    this.animateNumber(activeUsersEl, parseInt(activeUsersEl.textContent) || 0, data.activeUsers);
                }
            }
            
            animateNumber(element, from, to) {
                const duration = 1000; // 1 second
                const steps = 30;
                const stepValue = (to - from) / steps;
                let current = from;
                let step = 0;
                
                const timer = setInterval(() => {
                    step++;
                    current += stepValue;
                    
                    if (step >= steps) {
                        current = to;
                        clearInterval(timer);
                    }
                    
                    element.textContent = Math.round(current);
                }, duration / steps);
            }
            
            async makeRequest(endpoint, options = {}) {
                const url = `${this.config.backendUrl}${endpoint}`;
                
                const defaultOptions = {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    timeout: 10000
                };
                
                for (let attempt = 0; attempt < this.config.retryAttempts; attempt++) {
                    try {
                        const response = await fetch(url, { ...defaultOptions, ...options });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        return await response.json();
                    } catch (error) {
                        console.warn(`Request attempt ${attempt + 1} failed:`, error);
                        
                        if (attempt < this.config.retryAttempts - 1) {
                            await this.delay(this.config.retryDelay * Math.pow(2, attempt));
                        } else {
                            throw error;
                        }
                    }
                }
            }
            
            startHeartbeat() {
                if (this.heartbeatTimer) {
                    clearInterval(this.heartbeatTimer);
                }
                
                this.heartbeatTimer = setInterval(() => {
                    this.sendHeartbeat();
                }, this.config.heartbeatInterval);
                
                // Send initial heartbeat
                this.sendHeartbeat();
            }
            
            startFetchingStats() {
                if (this.fetchTimer) {
                    clearInterval(this.fetchTimer);
                }
                
                // Fetch stats immediately
                this.fetchGlobalStats();
                
                // Then fetch every 30 seconds
                this.fetchTimer = setInterval(() => {
                    this.fetchGlobalStats();
                }, this.config.fetchInterval);
            }
            
            stopHeartbeat() {
                if (this.heartbeatTimer) {
                    clearInterval(this.heartbeatTimer);
                    this.heartbeatTimer = null;
                }
            }
            
            stopFetchingStats() {
                if (this.fetchTimer) {
                    clearInterval(this.fetchTimer);
                    this.fetchTimer = null;
                }
            }
            
            setupEventListeners() {
                // Track online/offline status
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    console.log('📊 Back online - processing queued requests');
                    this.processPendingRequests();
                    this.startHeartbeat();
                    this.startFetchingStats();
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    console.log('📊 Offline - queuing requests');
                    this.stopHeartbeat();
                    this.stopFetchingStats();
                });
                
                // Track page visibility changes
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.stopHeartbeat();
                        this.stopFetchingStats();
                    } else {
                        this.startHeartbeat();
                        this.startFetchingStats();
                    }
                });
                
                // Track app being closed
                window.addEventListener('beforeunload', () => {
                    this.stopHeartbeat();
                    this.stopFetchingStats();
                });
            }
            
            queueRequest(method, args) {
                this.pendingRequests.push({ method, args, timestamp: Date.now() });
                
                // Limit queue size
                if (this.pendingRequests.length > 50) {
                    this.pendingRequests = this.pendingRequests.slice(-25);
                }
            }
            
            async processPendingRequests() {
                if (!this.isOnline || this.pendingRequests.length === 0) return;
                
                const requests = [...this.pendingRequests];
                this.pendingRequests = [];
                
                for (const request of requests) {
                    try {
                        // Skip old requests (older than 1 hour)
                        if (Date.now() - request.timestamp > 60 * 60 * 1000) {
                            continue;
                        }
                        
                        if (request.method === 'trackEntry') {
                            await this.trackEntry(...request.args);
                        }
                        
                        // Small delay between requests
                        await this.delay(100);
                    } catch (error) {
                        console.warn('Failed to process pending request:', error);
                    }
                }
            }
            
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            // Public methods for integration
            disable() {
                this.config.enabled = false;
                this.stopHeartbeat();
                this.stopFetchingStats();
                console.log('📊 Analytics disabled');
            }
            
            enable() {
                this.config.enabled = true;
                this.init();
                console.log('📊 Analytics enabled');
            }
        }

        // Initialize analytics globally
        let disciplinAnalytics = null;
        
        function initAnalytics() {
            if (!disciplinAnalytics) {
                disciplinAnalytics = new DisciplinAnalytics();
            }
        }

        // Integration functions for existing app
        function trackFormSubmission(entry) {
            if (disciplinAnalytics) {
                disciplinAnalytics.trackEntry(1, 'log_entry', {
                    masturbated: entry.masturbated,
                    hasNotes: !!entry.notes,
                    timeOfDay: entry.timeOfDay,
                    energy: entry.energy,
                    mood: entry.mood
                });
            }
        }

        function trackDataExport() {
            if (disciplinAnalytics) {
                disciplinAnalytics.trackEntry(0, 'data_export', {
                    action: 'export'
                });
            }
        }

        function trackDataImport() {
            if (disciplinAnalytics) {
                disciplinAnalytics.trackEntry(0, 'data_import', {
                    action: 'import'
                });
            }
        }

        function trackTabSwitch(tabName) {
            if (disciplinAnalytics) {
                disciplinAnalytics.trackEntry(1, 'tab_switch', {
                    tab: tabName
                });
            }
        }
        
        function updatePageTitle(tabName) {
    const newTitle = tabTitles[tabName] || 'Disciplin';
    document.title = newTitle;
}
        
 // Firebase Chat System
class FirebaseChat {
    constructor() {
        this.db = null;
        this.auth = null;
        this.user = null;
        this.messagesRef = null;
        this.onlineRef = null;
        this.unsubscribeMessages = null;
        this.unsubscribeOnline = null;
        this.isConnected = false;
        this.typingTimeout = null;
        this.lastActivity = Date.now();
    }
}
    // Firebase Chat System
class DisciplinChat {
    constructor() {
        this.firebaseConfig = {
            apiKey: "AIzaSyDdZV7b_23WAuu6kiKfpLxdL-v9zpgWjBM",
            authDomain: "disciplin-chat.firebaseapp.com",
            projectId: "disciplin-chat",
            storageBucket: "disciplin-chat.firebasestorage.app",
            messagingSenderId: "595537471459",
            appId: "1:595537471459:web:4c6c35e907c947a8d222d6"
        };
        
        this.messagesRef = null;
        this.unsubscribeMessages = null;
        this.currentUser = null;
        this.lastMessageTime = null;
        
        this.init();
    }
    
    init() {
        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(this.firebaseConfig);
        }
        
        this.db = firebase.firestore();
        this.auth = firebase.auth();
        this.messagesRef = this.db.collection('chat');
        
        // Auth state observer
        this.auth.onAuthStateChanged((user) => {
            if (user) {
                this.currentUser = user;
                this.showChatInterface();
                this.loadMessages();
                this.updateUserLastSeen();
            } else {
                this.currentUser = null;
                this.showAuthSection();
            }
        });
        
        this.setupMessageInput();
    }
    
    async signInWithGoogle() {
        try {
            const provider = new firebase.auth.GoogleAuthProvider();
            const result = await this.auth.signInWithPopup(provider);
            
            // Save user profile
            await this.saveUserProfile(result.user.uid, {
                username: result.user.displayName,
                email: result.user.email,
                authMethod: 'google',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            showNotification('Signed in successfully!', 'success');
        } catch (error) {
            console.error('Google sign-in error:', error);
            showNotification('Sign-in failed: ' + error.message);
        }
    }
    
    async signInAnonymously() {
        const username = document.getElementById('anonymousUsername').value.trim();
        
        if (!username) {
            showNotification('Please enter a username');
            return;
        }
        
        if (username.length < 3) {
            showNotification('Username must be at least 3 characters');
            return;
        }
        
        try {
            const result = await this.auth.signInAnonymously();
            
            // Save user profile with anonymous username
            await this.saveUserProfile(result.user.uid, {
                username: username,
                authMethod: 'anonymous',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Remember username locally
            localStorage.setItem('disciplin_anonymous_username', username);
            
            this.closeAnonymousModal();
            showNotification('Joined chat successfully!', 'success');
        } catch (error) {
            console.error('Anonymous sign-in error:', error);
            showNotification('Sign-in failed: ' + error.message);
        }
    }
    
    async signUpWithEmail() {
        const email = document.getElementById('emailInput').value.trim();
        const password = document.getElementById('passwordInput').value;
        const username = document.getElementById('emailUsername').value.trim();
        
        if (!email || !password || !username) {
            showNotification('Please fill in all fields');
            return;
        }
        
        if (password.length < 6) {
            showNotification('Password must be at least 6 characters');
            return;
        }
        
        if (username.length < 3) {
            showNotification('Username must be at least 3 characters');
            return;
        }
        
        try {
            const result = await this.auth.createUserWithEmailAndPassword(email, password);
            
            // Save user profile
            await this.saveUserProfile(result.user.uid, {
                username: username,
                email: email,
                authMethod: 'email',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            this.closeEmailModal();
            showNotification('Account created successfully!', 'success');
        } catch (error) {
            console.error('Email sign-up error:', error);
            showNotification('Sign-up failed: ' + error.message);
        }
    }
    
    async signInWithEmail() {
        const email = document.getElementById('signInEmail').value.trim();
        const password = document.getElementById('signInPassword').value;
        
        if (!email || !password) {
            showNotification('Please fill in all fields');
            return;
        }
        
        try {
            await this.auth.signInWithEmailAndPassword(email, password);
            this.closeSignInModal();
            showNotification('Signed in successfully!', 'success');
        } catch (error) {
            console.error('Email sign-in error:', error);
            showNotification('Sign-in failed: ' + error.message);
        }
    }
    
    async signOut() {
        try {
            await this.auth.signOut();
            if (this.unsubscribeMessages) {
                this.unsubscribeMessages();
                this.unsubscribeMessages = null;
            }
            showNotification('Signed out successfully!', 'success');
        } catch (error) {
            console.error('Sign-out error:', error);
            showNotification('Sign-out failed: ' + error.message);
        }
    }
    
    async saveUserProfile(uid, data) {
        try {
            await this.db.collection('users').doc(uid).set(data, { merge: true });
        } catch (error) {
            console.error('Error saving user profile:', error);
        }
    }
    
    async updateUserLastSeen() {
        if (this.currentUser) {
            try {
                await this.db.collection('users').doc(this.currentUser.uid).update({
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error('Error updating last seen:', error);
            }
        }
    }
    
    async loadMessages() {
        if (!this.messagesRef || this.unsubscribeMessages) return;
        
        try {
            this.unsubscribeMessages = this.messagesRef
                .orderBy('timestamp', 'asc')
                .limit(50)
                .onSnapshot((snapshot) => {
                    const messagesContainer = document.getElementById('chatMessages');
                    
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const messageData = change.doc.data();
                            this.displayMessage(messageData);
                        }
                    });
                    
                    // Auto-scroll to bottom
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                });
        } catch (error) {
            console.error('Error loading messages:', error);
            showNotification('Error loading messages');
        }
    }
    
    displayMessage(messageData) {
        const messagesContainer = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        const isOwnMessage = messageData.userId === this.currentUser.uid;
        
        messageDiv.className = `message ${isOwnMessage ? 'own' : ''}`;
        
        const timestamp = messageData.timestamp 
  ? messageData.timestamp.toDate().toLocaleString([], { 
      day: '2-digit', 
      month: 'short',   // e.g. "Aug"
      year: 'numeric', 
      hour: '2-digit', 
      minute: '2-digit' 
    }) 
  : 'Sent';

        
        messageDiv.innerHTML = `
            <div class="message-content">
                ${!isOwnMessage ? `<div class="message-author">${messageData.username}</div>` : ''}
                <div class="message-text">${this.escapeHtml(messageData.text)}</div>
                <div class="message-time">${timestamp}</div>
            </div>
        `;
        
        messagesContainer.appendChild(messageDiv);
    }
    
    async sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const messageText = messageInput.value.trim();
        
        if (!messageText || !this.currentUser) return;
        
        // Rate limiting: prevent spam
        const now = Date.now();
        if (this.lastMessageTime && now - this.lastMessageTime < 15000) {
            showNotification('Please wait for 15 secs before sending another message');
            return;
        }
        
        try {
            // Get user profile for username
            const userDoc = await this.db.collection('users').doc(this.currentUser.uid).get();
            const userData = userDoc.data();
            const username = userData?.username || 'Anonymous';
            
            await this.messagesRef.add({
                text: messageText,
                username: username,
                userId: this.currentUser.uid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            messageInput.value = '';
            this.lastMessageTime = now;
            
        } catch (error) {
            console.error('Error sending message:', error);
            showNotification('Error sending message');
        }
    }
    
    setupMessageInput() {
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        
        if (messageInput) {
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendMessage();
                }
            });
            
            messageInput.addEventListener('input', () => {
                const hasText = messageInput.value.trim().length > 0;
                sendButton.disabled = !hasText;
            });
        }
    }
    
    showAuthSection() {
        document.getElementById('authSection').style.display = 'block';
        document.getElementById('chatInterface').style.display = 'none';
    }
    
    async showChatInterface() {
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('chatInterface').style.display = 'flex';
        
        // Update username display
        if (this.currentUser) {
            try {
                const userDoc = await this.db.collection('users').doc(this.currentUser.uid).get();
                const userData = userDoc.data();
                const username = userData?.username || 'Anonymous';
                document.getElementById('chatUsername').textContent = username;
            } catch (error) {
                console.error('Error fetching username:', error);
                document.getElementById('chatUsername').textContent = 'User';
            }
        }
    }
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Modal functions
    showAnonymousModal() {
        const savedUsername = localStorage.getItem('disciplin_anonymous_username');
        if (savedUsername) {
            document.getElementById('anonymousUsername').value = savedUsername;
        }
        document.getElementById('anonymousModal').classList.add('show');
    }
    
    closeAnonymousModal() {
        document.getElementById('anonymousModal').classList.remove('show');
    }
    
    showEmailModal() {
        document.getElementById('emailModal').classList.add('show');
    }
    
    closeEmailModal() {
        document.getElementById('emailModal').classList.remove('show');
    }
    
    showSignInModal() {
        document.getElementById('signInModal').classList.add('show');
    }
    
    closeSignInModal() {
        document.getElementById('signInModal').classList.remove('show');
    }
    
    switchToSignIn() {
        this.closeEmailModal();
        this.showSignInModal();
    }
    
    switchToSignUp() {
        this.closeSignInModal();
        this.showEmailModal();
    }
}

// Initialize chat system
let disciplinChat;

// Chat-related global functions
function signInWithGoogle() {
    if (disciplinChat) disciplinChat.signInWithGoogle();
}

function signInAnonymously() {
    if (disciplinChat) disciplinChat.signInAnonymously();
}

function signUpWithEmail() {
    if (disciplinChat) disciplinChat.signUpWithEmail();
}

function signInWithEmail() {
    if (disciplinChat) disciplinChat.signInWithEmail();
}

function signOut() {
    if (disciplinChat) disciplinChat.signOut();
}

function sendMessage() {
    if (disciplinChat) disciplinChat.sendMessage();
}

function showAnonymousModal() {
    if (disciplinChat) disciplinChat.showAnonymousModal();
}

function closeAnonymousModal() {
    if (disciplinChat) disciplinChat.closeAnonymousModal();
}

function showEmailModal() {
    if (disciplinChat) disciplinChat.showEmailModal();
}

function closeEmailModal() {
    if (disciplinChat) disciplinChat.closeEmailModal();
}

function closeSignInModal() {
    if (disciplinChat) disciplinChat.closeSignInModal();
}

function switchToSignIn() {
    if (disciplinChat) disciplinChat.switchToSignIn();
}

function switchToSignUp() {
    if (disciplinChat) disciplinChat.switchToSignUp();
}

// Initialize chat when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Wait a bit to ensure Firebase is loaded
    setTimeout(() => {
        disciplinChat = new DisciplinChat();
    }, 1000);


});


// Forum functionality with thread detail tabs - COMPLETE FIXED VERSION
class ForumManager {
    constructor() {
        this.firebaseConfig = {
            apiKey: "AIzaSyDdZV7b_23WAuu6kiKfpLxdL-v9zpgWjBM",
            authDomain: "disciplin-chat.firebaseapp.com",
            projectId: "disciplin-chat",
            storageBucket: "disciplin-chat.firebasestorage.app",
            messagingSenderId: "595537471459",
            appId: "1:595537471459:web:4c6c35e907c947a8d222d6"
        };
        
        this.currentUser = null;
        this.currentPage = 1;
        this.threadsPerPage = 20;
        this.currentThreadId = null;
        this.currentUserProfile = null;
        this.notifications = [];
        this.notificationListener = null;
        this.isCreatingThread = false; // Add flag to prevent double creation
        this.eventListenersAttached = false; // Add flag to prevent duplicate listeners
        this.isAddingReply = false; // Add flag to prevent double replies
        this.init();
    }
    
    async init() {
        try {
            // Initialize Firebase
            firebase.initializeApp(this.firebaseConfig);
            this.db = firebase.firestore();
            this.auth = firebase.auth();
            this.loadForumStats();
            

            
            // In the init() method, update the auth state listener
this.auth.onAuthStateChanged(async (user) => {
    this.currentUser = user;
    
    if (user) {
        // Check if user has a username set
        const userProfile = await this.getUserProfile();
        
        if (!userProfile || !userProfile.username) {
            // Show username modal
            this.showUsernameModal();
        } else {
            // User has username, proceed normally
            this.currentUserProfile = userProfile;
            this.updateAuthUI();
            this.setupNotificationListener();
            this.loadUserProfile();
        }
    } else {
        this.currentUserProfile = null;
        if (this.notificationListener) {
            this.notificationListener();
            this.notificationListener = null;
        }
        this.updateAuthUI();
    }
});
            
            // Set up event listeners only once
            if (!this.eventListenersAttached) {
                this.setupEventListeners();
                this.eventListenersAttached = true;
            }
            
            // Load initial threads
            this.loadThreads();
            
            console.log('Forum initialized successfully');
        } catch (error) {
            console.error('Forum initialization failed:', error);
            this.showForumError('Failed to initialize forum');
        }
    }
    
    setupEventListeners() {
        // Auth button
        const authBtn = document.getElementById('authBtn');
        if (authBtn && !authBtn.hasAttribute('data-listener-attached')) {
            authBtn.addEventListener('click', () => {
                if (this.currentUser) {
                    this.signOut();
                } else {
                    this.signIn();
                }
            });
            authBtn.setAttribute('data-listener-attached', 'true');
        }
        
        // Create thread button
        const createThreadBtn = document.getElementById('createThreadBtn');
        if (createThreadBtn && !createThreadBtn.hasAttribute('data-listener-attached')) {
            createThreadBtn.addEventListener('click', () => {
                document.getElementById('createThreadModal').classList.add('show');
            });
            createThreadBtn.setAttribute('data-listener-attached', 'true');
        }
        
        // Create thread form - FIXED: Remove existing listeners first
        const createThreadForm = document.getElementById('createThreadForm');
        if (createThreadForm && !createThreadForm.hasAttribute('data-listener-attached')) {
            // Clone the form to remove all existing listeners
            const newForm = createThreadForm.cloneNode(true);
            createThreadForm.parentNode.replaceChild(newForm, createThreadForm);
            
            // Add single event listener
            newForm.addEventListener('submit', (e) => {
                e.preventDefault();
                e.stopPropagation(); // Prevent event bubbling
                this.createThread();
            });
            newForm.setAttribute('data-listener-attached', 'true');
        }
        
        // Category filter
        const categoryFilter = document.getElementById('categoryFilter');
        if (categoryFilter && !categoryFilter.hasAttribute('data-listener-attached')) {
            categoryFilter.addEventListener('change', () => {
                this.currentPage = 1;
                this.loadThreads();
            });
            categoryFilter.setAttribute('data-listener-attached', 'true');
        }
        
        // Pagination
        const forumPrevBtn = document.getElementById('forumPrevBtn');
        if (forumPrevBtn && !forumPrevBtn.hasAttribute('data-listener-attached')) {
            forumPrevBtn.addEventListener('click', () => {
                if (this.currentPage > 1) {
                    this.currentPage--;
                    this.loadThreads();
                }
            });
            forumPrevBtn.setAttribute('data-listener-attached', 'true');
        }
        
        const forumNextBtn = document.getElementById('forumNextBtn');
        if (forumNextBtn && !forumNextBtn.hasAttribute('data-listener-attached')) {
            forumNextBtn.addEventListener('click', () => {
                this.currentPage++;
                this.loadThreads();
            });
            forumNextBtn.setAttribute('data-listener-attached', 'true');
        }
        
        // Back to threads button
        const backBtn = document.getElementById('backToThreadsBtn');
        if (backBtn && !backBtn.hasAttribute('data-listener-attached')) {
            backBtn.addEventListener('click', () => {
                this.closeThreadTab();
            });
            backBtn.setAttribute('data-listener-attached', 'true');
        }
    }
    
    // Method to open thread in a new tab
    openThreadTab(threadId) {
        this.openThread(threadId);
    }
    
    // Method to close thread tab and return to threads list
    closeThreadTab() {
        console.log('Closing thread tab');
        
        // Use your existing structure
        const forumHeader = document.querySelector('.forum-header');
        const forumRules = document.querySelector('.forum-rules');
        const threadSearch = document.getElementById('threadSearch');
        const threadList = document.getElementById('threadList');
        const pagination = document.querySelector('.forum-pagination');
        const detailTab = document.getElementById('threadDetailTab');
        
        // Show all main forum elements
        if (forumHeader) forumHeader.style.display = 'block';
        if (forumRules) forumRules.style.display = 'block';
        if (threadSearch) threadSearch.style.display = 'block';
        if (threadList) threadList.style.display = 'block';
        if (pagination) pagination.style.display = 'flex';
        
        // Hide detail tab
        if (detailTab) detailTab.style.display = 'none';
        
        this.currentThreadId = null;
    }

    async checkUsernameAvailability(username) {
    try {
        const snapshot = await this.db.collection('users')
            .where('username', '==', username.toLowerCase())
            .limit(1)
            .get();
        
        return snapshot.empty;
    } catch (error) {
        console.error('Error checking username:', error);
        return false;
    }
}

async createUserProfile(username) {
    if (!this.currentUser) return false;
    
    try {
        await this.db.collection('users').doc(this.currentUser.uid).set({
            uid: this.currentUser.uid,
            username: username.toLowerCase(),
            displayName: username,
            email: this.currentUser.email || null,
            isAnonymous: this.currentUser.isAnonymous,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastActive: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        return true;
    } catch (error) {
        console.error('Error creating user profile:', error);
        return false;
    }
}

async getUserProfile() {
    if (!this.currentUser) return null;
    
    try {
        const doc = await this.db.collection('users').doc(this.currentUser.uid).get();
        return doc.exists ? doc.data() : null;
    } catch (error) {
        console.error('Error getting user profile:', error);
        return null;
    }
}

    showUsernameModal() {
    const modal = document.getElementById('usernameModal');
    if (modal) {
        modal.classList.add('show');
        
        // Set up form handler if not already done
        const form = document.getElementById('usernameForm');
        if (form && !form.hasAttribute('data-listener-attached')) {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                this.handleUsernameSubmit();
            });
            form.setAttribute('data-listener-attached', 'true');
        }
    }
}

async handleUsernameSubmit() {
    const usernameInput = document.getElementById('usernameInput');
    const username = usernameInput?.value.trim();
    
    if (!username) {
        showNotification('Please enter a username');
        return;
    }
    
    // Validate username format
    if (!/^[a-zA-Z0-9_]+$/.test(username)) {
        showNotification('Username can only contain letters, numbers, and underscores');
        return;
    }
    
    if (username.length < 3 || username.length > 20) {
        showNotification('Username must be between 3 and 20 characters');
        return;
    }
    
    // Check availability
    const isAvailable = await this.checkUsernameAvailability(username);
    if (!isAvailable) {
        showNotification('Username is already taken. Please choose another.');
        return;
    }
    
    // Create user profile
    const success = await this.createUserProfile(username);
    if (success) {
        this.currentUserProfile = {
            uid: this.currentUser.uid,
            username: username.toLowerCase(),
            displayName: username,
            email: this.currentUser.email || null,
            isAnonymous: this.currentUser.isAnonymous
        };
        
        this.closeUsernameModal();
        this.updateAuthUI();
        this.setupNotificationListener();
        this.loadUserProfile();
        showNotification('Username set successfully!', 'success');
    } else {
        showNotification('Failed to set username. Please try again.');
    }
}

closeUsernameModal() {
    const modal = document.getElementById('usernameModal');
    if (modal) {
        modal.classList.remove('show');
        document.getElementById('usernameForm').reset();
    }
}
    
    async signIn() {
        try {
            const provider = new firebase.auth.GoogleAuthProvider();
            await this.auth.signInWithPopup(provider);
            showNotification('Signed in successfully!', 'success');
        } catch (error) {
            console.error('Sign in error:', error);
            
            // Fallback to anonymous auth
            if (confirm('Google sign-in failed. Sign in anonymously instead?')) {
                try {
                    await this.auth.signInAnonymously();
                    showNotification('Signed in anonymously!', 'success');
                } catch (anonError) {
                    console.error('Anonymous sign in error:', anonError);
                    showNotification('Sign in failed');
                }
            }
        }
    }
    
    async signOut() {
        try {
            await this.auth.signOut();
            showNotification('Signed out successfully!', 'success');
        } catch (error) {
            console.error('Sign out error:', error);
            showNotification('Sign out failed');
        }
    }
    
   updateAuthUI() {
    const authBtn = document.getElementById('authBtn');
    const authStatus = document.getElementById('authStatus');
    const createThreadBtn = document.getElementById('createThreadBtn');
    
    if (this.currentUser && this.currentUserProfile) {
        const displayName = this.currentUserProfile.displayName;
        if (authBtn) authBtn.textContent = 'Sign Out';
        if (authStatus) authStatus.textContent = `Signed in as: ${displayName}`;
        if (createThreadBtn) createThreadBtn.style.display = 'block';
        this.loadForumStats();
    } else {
        if (authBtn) authBtn.textContent = 'Sign In';
        if (authStatus) authStatus.textContent = 'Sign in to create threads and reply';
        if (createThreadBtn) createThreadBtn.style.display = 'none';
    }
}
    
   setupForumStatsListener() {
    // Listen for new threads
    this.db.collection('forum').doc('threads').collection('threads')
        .onSnapshot(() => {
            this.loadForumStats();
        });
} 

// Update createNotification method
async createNotification(toUserId, type, data) {
    try {
        await this.db.collection('notifications').add({
            to: toUserId,
            from: this.currentUser.uid,
            fromName: this.currentUserProfile?.displayName || 'Unknown User', // Updated
            type: type,
            data: data,
            read: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (error) {
        console.error('Error creating notification:', error);
    }
}

setupNotificationListener() {
    if (!this.currentUser || this.notificationListener) return;
    
    this.notificationListener = this.db.collection('notifications')
        .where('to', '==', this.currentUser.uid)
        .where('read', '==', false)
        .onSnapshot((snapshot) => {
            this.notifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            this.updateNotificationUI();
        });
}

updateNotificationUI() {
    const notificationContainer = document.getElementById('notificationContainer');
    if (!notificationContainer) return;
    
    if (this.notifications.length === 0) {
        notificationContainer.innerHTML = '<p>No new notifications</p>';
        return;
    }
    
    notificationContainer.innerHTML = this.notifications.map(notification => `
        <div class="notification-item" onclick="forumManager.handleNotificationClick('${notification.id}', '${notification.data.threadId}')">
            <div>${this.getNotificationMessage(notification)}</div>
            <div style="font-size: 12px; color: var(--text-muted);">${this.getTimeAgo(notification.createdAt?.toDate())}</div>
        </div>
    `).join('');
}

getNotificationMessage(notification) {
    if (notification.type === 'reply') {
        return `${notification.fromName} replied to your thread "${notification.data.threadTitle}"`;
    } else if (notification.type === 'mention') {
        return `${notification.fromName} mentioned you in "${notification.data.threadTitle}"`;
    }
    return 'New notification';
}

async handleNotificationClick(notificationId, threadId) {
    // Mark as read
    await this.db.collection('notifications').doc(notificationId).update({ read: true });
    
    // Switch to forum tab and open thread
    switchTab('forum');
    setTimeout(() => this.openThreadTab(threadId), 100);
}
    
    async loadThreads(searchTerm = "") {
        try {
            const categoryFilter = document.getElementById('categoryFilter')?.value || '';
            let query;

            if (searchTerm) {
                // Search by title (prefix match)
                query = this.db.collection('forum').doc('threads').collection('threads')
                    .orderBy('title')
                    .startAt(searchTerm)
                    .endAt(searchTerm + '\uf8ff');
            } else {
                // Default: order by last activity
                query = this.db.collection('forum').doc('threads').collection('threads')
                    .orderBy('lastActivity', 'desc');
            }

            if (categoryFilter) {
                query = query.where('category', '==', categoryFilter);
            }

            const snapshot = await query.limit(this.threadsPerPage).get();
            const threads = [];

            for (const doc of snapshot.docs) {
                const thread = { id: doc.id, ...doc.data() };

                // Check if user has read this thread
                if (this.currentUser) {
                    const readStatus = await this.getUserReadStatus(thread.id);
                    thread.unread = !readStatus || readStatus.lastRead < thread.lastActivity;
                } else {
                    thread.unread = false;
                }

                threads.push(thread);
            }

            this.renderThreads(threads);
            this.updateForumPagination(threads.length);

        } catch (error) {
            console.error('Error loading threads:', error);
            this.showForumError('Failed to load threads');
        }
    }
    
    renderThreads(threads) {
        const threadList = document.getElementById('threadList');
        
        if (!threadList) return;
        
        if (threads.length === 0) {
            threadList.innerHTML = `
                <div class="empty-state">
                    <h3>No threads found</h3>
                    <p>Be the first to start a discussion!</p>
                </div>
            `;
            return;
        }
        
        threadList.innerHTML = threads.map(thread => {
            const timeAgo = this.getTimeAgo(thread.createdAt?.toDate() || new Date());
            const lastActivity = this.getTimeAgo(thread.lastActivity?.toDate() || new Date());
            
            return `
                <div class="forum-thread ${thread.unread ? 'unread' : ''}" onclick="forumManager.openThreadTab('${thread.id}')">
                    <div class="thread-title ${thread.unread ? 'unread' : ''}">${this.escapeHtml(thread.title)}</div>
                    <div class="thread-meta">
                        <div>
                            <span class="thread-category">${thread.category}</span>
                            <span style="margin-left: 10px;">by ${this.escapeHtml(thread.authorName)} • ${timeAgo}</span>
                        </div>
                        <div>Last activity: ${lastActivity}</div>
                    </div>
                    <div class="thread-stats">
                        <span><i class="fas fa-solid fa-thumbs-up"></i> ${thread.likeCount || 0}</span>
                        <span><i class="fas fa-solid fa-comment"></i> ${thread.replyCount || 0}</span>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    async loadRecentThreadsForHome() {
        console.log('🔄 HOME: Loading threads...');
        
        try {
            const query = this.db.collection('forum').doc('threads').collection('threads')
                .orderBy('lastActivity', 'desc')
                .limit(10);

            const snapshot = await query.get();
            const threads = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            console.log('🔄 HOME: Found', threads.length, 'threads');
            return threads;
        } catch (error) {
            console.error('❌ HOME: Error:', error);
            return [];
        }
    }
    
    renderHomeThreads(threads) {
        const homeThreadsContainer = document.getElementById('homeRecentThreads');
        if (!homeThreadsContainer) return;
        
        if (threads.length === 0) {
            homeThreadsContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No recent forum activity</p>';
            return;
        }
        
        homeThreadsContainer.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0; color: #4F46E5;">Recent Forum Activity</h3>
                <button onclick="switchTab('forum')" style="background: none; border: none; color: #4F46E5; cursor: pointer; font-size: 12px;">View All →</button>
            </div>
            ${threads.map(thread => {
                const timeAgo = this.getTimeAgo(thread.createdAt?.toDate() || new Date());
                return `
                    <div class="home-thread-item" onclick="switchTab('forum'); setTimeout(() => forumManager.openThreadTab('${thread.id}'), 100);" 
                         style="padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s ease;">
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px; font-size: 14px;">${this.escapeHtml(thread.title)}</div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
                            <span class="thread-category">${thread.category}</span> • by ${this.escapeHtml(thread.authorName)} • ${timeAgo}
                        </div>
                        <div style="font-size: 13px; color: var(--text-muted); line-height: 1.4; max-height: 40px; overflow: hidden;">
                            ${this.escapeHtml(thread.content).substring(0, 100)}${thread.content.length > 100 ? '...' : ''}
                        </div>
                        <div style="display: flex; gap: 15px; margin-top: 8px; font-size: 11px; color: var(--text-muted);">
                            <span><i class="fas fa-thumbs-up"></i> ${thread.likeCount || 0}</span>
                            <span><i class="fas fa-comment"></i> ${thread.replyCount || 0}</span>
                        </div>
                    </div>
                `;
            }).join('')}
        `;
    }

    async editThread(threadId) {
        if (!this.currentUser) return;
        
        try {
            const threadDoc = await this.db.collection('forum').doc('threads').collection('threads').doc(threadId).get();
            if (!threadDoc.exists) return;
            
            const thread = threadDoc.data();
            
            // Create edit modal HTML
            const modalHTML = `
                <div id="editThreadModal" class="modal show" style="display: flex;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Edit Thread</h3>
                            <span class="close" onclick="forumManager.closeEditThreadModal()">&times;</span>
                        </div>
                        <form id="editThreadForm">
                            <div class="form-group">
                                <label>Title</label>
                                <input type="text" id="editThreadTitle" class="form-control" value="${this.escapeHtml(thread.title)}" required maxlength="200">
                            </div>
                            <div class="form-group">
                                <label>Content</label>
                                <textarea id="editThreadContent" class="form-control" rows="6" required maxlength="2000">${this.escapeHtml(thread.content)}</textarea>
                            </div>
                            <div class="form-actions">
                                <button type="button" onclick="forumManager.closeEditThreadModal()">Cancel</button>
                                <button type="submit">Update Thread</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Add form submit handler with duplication protection
            const editForm = document.getElementById('editThreadForm');
            if (editForm && !editForm.hasAttribute('data-listener-attached')) {
                editForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.updateThread(threadId);
                });
                editForm.setAttribute('data-listener-attached', 'true');
            }
            
        } catch (error) {
            console.error('Error loading thread for edit:', error);
            showNotification('Failed to load thread for editing');
        }
    }

    async updateThread(threadId) {
        const title = document.getElementById('editThreadTitle')?.value.trim();
        const content = document.getElementById('editThreadContent')?.value.trim();
        
        if (!title || !content) {
            showNotification('Please fill in all fields');
            return;
        }
        
        try {
            await this.db.collection('forum').doc('threads').collection('threads').doc(threadId).update({
                title,
                content,
                editedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            this.closeEditThreadModal();
            this.openThread(threadId); // Reload thread
            showNotification('Thread updated successfully!', 'success');
            
        } catch (error) {
            console.error('Error updating thread:', error);
            showNotification('Failed to update thread');
        }
    }

    closeEditThreadModal() {
        const modal = document.getElementById('editThreadModal');
        if (modal) modal.remove();
    }

    async editReply(threadId, replyId) {
        if (!this.currentUser) return;
        
        try {
            const replyDoc = await this.db.collection('forum').doc('threads').collection('threads')
                .doc(threadId).collection('replies').doc(replyId).get();
            
            if (!replyDoc.exists) return;
            
            const reply = replyDoc.data();
            
            // Find the reply content div by ID
            const contentDiv = document.getElementById(`replyContent${replyId}`);
            if (!contentDiv) {
                console.error('Reply content div not found');
                return;
            }
            
            const originalContent = contentDiv.innerHTML;
            contentDiv.innerHTML = `
                <div id="editReply${replyId}">
                    <textarea id="editReplyContent${replyId}" class="form-control" rows="3" maxlength="1000">${this.escapeHtml(reply.content)}</textarea>
                    <div style="margin-top: 10px;">
                        <button onclick="forumManager.updateReply('${threadId}', '${replyId}')" class="btn-secondary">Update</button>
                        <button onclick="forumManager.cancelEditReply('${replyId}', \`${originalContent.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)" class="btn-secondary">Cancel</button>
                    </div>
                </div>
            `;
            
        } catch (error) {
            console.error('Error loading reply for edit:', error);
            showNotification('Failed to load reply for editing');
        }
    }

    async updateReply(threadId, replyId) {
        const content = document.getElementById(`editReplyContent${replyId}`)?.value.trim();
        
        if (!content) {
            showNotification('Please enter content');
            return;
        }
        
        try {
            await this.db.collection('forum').doc('threads').collection('threads')
                .doc(threadId).collection('replies').doc(replyId).update({
                    content,
                    editedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            
            this.openThread(threadId); // Reload thread
            showNotification('Reply updated successfully!', 'success');
            
        } catch (error) {
            console.error('Error updating reply:', error);
            showNotification('Failed to update reply');
        }
    }

    cancelEditReply(replyId, originalContent) {
        const editDiv = document.getElementById(`editReply${replyId}`);
        if (editDiv) {
            editDiv.parentElement.innerHTML = originalContent;
        }
    }
    
    async createThread() {
        // FIXED: Add protection against double submission
        if (this.isCreatingThread) {
            console.log('Thread creation already in progress, ignoring duplicate request');
            return;
        }
        
        if (!this.currentUser) {
            showNotification('Please sign in to create threads');
            return;
        }
        
        const title = document.getElementById('threadTitle')?.value.trim() || '';
        const content = document.getElementById('threadContent')?.value.trim() || '';
        const category = document.getElementById('threadCategory')?.value || '';
        
        if (!title || !content) {
            showNotification('Please fill in all required fields');
            return;
        }
        
        // Set flag to prevent double submission
        this.isCreatingThread = true;
        
        // Disable the submit button
        const submitBtn = document.querySelector('#createThreadForm button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating...';
        }
        
        try {
            const thread = {
    title,
    content,
    category,
    authorId: this.currentUser.uid,
    authorName: this.currentUserProfile?.displayName || 'Unknown User', // Updated
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    lastActivity: firebase.firestore.FieldValue.serverTimestamp(),
    likeCount: 0,
    replyCount: 0,
    likes: {}
};
            
            await this.db.collection('forum').doc('threads').collection('threads').add(thread);
            
              // Update user stats
        await this.updateUserStats('thread');
        
        // Update forum stats
        await this.loadForumStats();
            
            this.closeCreateThreadModal();
            this.loadThreads();
            showNotification('Thread created successfully!', 'success');
            
        } catch (error) {
            console.error('Error creating thread:', error);
            showNotification('Failed to create thread');
        } finally {
            // Reset the flag and button state
            this.isCreatingThread = false;
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Thread';
            }
        }
    }
    
    // Update the openThread method:
    async openThread(threadId) {
        console.log('Opening thread:', threadId);
        
        try {
            this.currentThreadId = threadId;
            const threadDoc = await this.db.collection('forum').doc('threads').collection('threads').doc(threadId).get();
            
            if (!threadDoc.exists) {
                showNotification('Thread not found');
                return;
            }
            
            const thread = { id: threadDoc.id, ...threadDoc.data() };
            
            // Mark as read for authenticated users
            if (this.currentUser) {
                await this.markThreadAsRead(threadId);
            }
            
            // Load replies
            const repliesSnapshot = await this.db.collection('forum').doc('threads').collection('threads')
                .doc(threadId).collection('replies').orderBy('createdAt', 'asc').get();
            
            const replies = repliesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            this.renderThreadDetail(thread, replies);
            
            // Hide main forum elements
            const forumHeader = document.querySelector('.forum-header');
            const forumRules = document.querySelector('.forum-rules');
            const threadSearch = document.getElementById('threadSearch');
            const threadList = document.getElementById('threadList');
            const pagination = document.querySelector('.forum-pagination');
            const detailTab = document.getElementById('threadDetailTab');
            
            if (forumHeader) forumHeader.style.display = 'none';
            if (forumRules) forumRules.style.display = 'none';
            if (threadSearch) threadSearch.style.display = 'none';
            if (threadList) threadList.style.display = 'none';
            if (pagination) pagination.style.display = 'none';
            
            // Show detail tab
            if (detailTab) {
                detailTab.style.display = 'block';
                console.log('Showed detail tab');
            } else {
                console.log('ERROR: threadDetailTab not found!');
            }
            
            // Scroll to top of the page
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
        } catch (error) {
            console.error('Error loading thread:', error);
            showNotification('Failed to load thread');
        }
    }
    
    renderThreadDetail(thread, replies) {
        const timeAgo = this.getTimeAgo(thread.createdAt?.toDate() || new Date());
        const canEdit = this.currentUser && this.currentUser.uid === thread.authorId;
        const isLiked = this.currentUser && thread.likes && thread.likes[this.currentUser.uid];
        
        const threadDetailContent = document.getElementById('threadDetailContent');
        if (!threadDetailContent) return;
        
        threadDetailContent.innerHTML = `
            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                    <h2 style="color: #4F46E5; margin: 0;">${this.escapeHtml(thread.title)}</h2> 
                    ${canEdit ? `<button onclick="forumManager.editThread('${thread.id}')" class="edit-btn" style="padding: 4px 8px; font-size: 12px; margin-right: 5px; background: #10B981; color: white; border: none; border-radius: 3px;">Edit</button> <button onclick="forumManager.deleteThread('${thread.id}')" class="delete-btn" style="padding: 4px 8px; font-size: 12px;">Delete</button>` : ''}
                </div>
                <div style="margin-bottom: 10px;">
                    <span class="thread-category">${thread.category}</span>
                    <span style="margin-left: 10px; font-size: 12px; color: var(--text-secondary);">by ${this.escapeHtml(thread.authorName)} • ${timeAgo}</span>
                </div>
                <div style="margin-bottom: 15px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: anywhere; text-align: left; max-width: 100%; padding: 0;">${this.escapeHtml(thread.content)}</div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <button class="like-btn ${isLiked ? 'liked' : ''}" onclick="forumManager.toggleLike('${thread.id}')">
                        ${isLiked ? '❤️' : '🤍'} ${thread.likeCount || 0}
                    </button>
                    <span style="font-size: 12px; color: var(--text-muted);"><i class="fas fa-solid fa-comment"></i> ${replies.length}</span>
                </div>
            </div>
            
            <div style="border-top: 2px solid var(--border-color); padding-top: 20px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">Replies (${replies.length})</h3>
                ${replies.length === 0 ? '<p style="color: var(--text-secondary); font-style: italic;">No replies yet. Be the first to reply!</p>' : ''}
                ${replies.map(reply => {
                    const replyTime = this.getTimeAgo(reply.createdAt?.toDate() || new Date());
                    const canEditReply = this.currentUser && this.currentUser.uid === reply.authorId;
                    return `
                        <div class="reply-item">
                            <div class="reply-header">
                                <span class="reply-author">${this.escapeHtml(reply.authorName)}</span>
                                <div>
                                    <span style="color: var(--text-muted);">${replyTime}</span>
                                    ${canEditReply ? `<button onclick="forumManager.editReply('${thread.id}', '${reply.id}')" class="edit-btn" style="margin-left: 5px; padding: 2px 6px; font-size: 10px; background: #10B981; color: white; border: none; border-radius: 3px;">Edit</button> <button onclick="forumManager.deleteReply('${thread.id}', '${reply.id}')" class="delete-btn" style="margin-left: 10px; padding: 2px 6px; font-size: 10px;">Delete</button>` : ''}
                                </div>
</div>
   <div class="reply-content" id="replyContent${reply.id}" 
                                 style="line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: anywhere; text-align: left; max-width: 100%; padding: 10px 0; margin-top: 8px;">${this.escapeHtml(reply.content)}</div>
                        </div>
                    `;
                }).join('')}
            </div>
            
            ${this.currentUser ? `
                <div style="border-top: 2px solid var(--border-color); padding-top: 20px;">
                    <h4 style="margin-bottom: 10px;">Add Reply</h4>
                    <textarea id="replyContent" class="form-control" rows="3" placeholder="Write your reply..." maxlength="1000"></textarea>
                    <button onclick="forumManager.addReply('${thread.id}')" class="btn" style="margin-top: 10px; width: 100%;" id="addReplyBtn">Post Reply</button>
                </div>
            ` : `
                <div style="border-top: 2px solid var(--border-color); padding-top: 20px; text-align: center;">
                    <p style="color: var(--text-secondary);">Sign in to reply to this thread</p>
                    <button onclick="forumManager.signIn()" class="btn" style="margin-top: 10px;">Sign In</button>
                </div>
            `}
        `;
    }
    
    async addReply(threadId) {
        // FIXED: Add protection against double submission
        if (this.isAddingReply) {
            console.log('Reply addition already in progress, ignoring duplicate request');
            return;
        }
        
        if (!this.currentUser) {
            showNotification('Please sign in to reply');
            return;
        }
        
        const content = document.getElementById('replyContent')?.value.trim() || '';
        if (!content) {
            showNotification('Please enter a reply');
            return;
        }
        
        // Set flag to prevent double submission
        this.isAddingReply = true;
        
        // Disable the reply button
        const replyBtn = document.getElementById('addReplyBtn');
        if (replyBtn) {
            replyBtn.disabled = true;
            replyBtn.textContent = 'Posting...';
        }
        
        try {
            const reply = {
    content,
    authorId: this.currentUser.uid,
    authorName: this.currentUserProfile?.displayName || 'Unknown User', // Updated
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
};
            
            // Add reply
            await this.db.collection('forum').doc('threads').collection('threads')
                .doc(threadId).collection('replies').add(reply);
            
            // Update thread reply count and last activity
            await this.db.collection('forum').doc('threads').collection('threads').doc(threadId).update({
                replyCount: firebase.firestore.FieldValue.increment(1),
                lastActivity: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Get thread data for notifications
        const threadDoc = await this.db.collection('forum').doc('threads').collection('threads').doc(threadId).get();
        const thread = threadDoc.data();
        
        // Create notification for thread author (if not replying to own thread)
        if (thread.authorId !== this.currentUser.uid) {
            await this.createNotification(thread.authorId, 'reply', {
                threadId: threadId,
                threadTitle: thread.title
            });
        }
        
        // Check for mentions in reply content
      const mentions = await this.extractMentions(content);
for (const mention of mentions) {
    if (mention.userId !== this.currentUser.uid) {
        await this.createNotification(mention.userId, 'mention', {
            threadId: threadId,
            threadTitle: thread.title
        });
    }
}
        
        
        // Update thread reply count and last activity
        await this.db.collection('forum').doc('threads').collection('threads').doc(threadId).update({
            replyCount: firebase.firestore.FieldValue.increment(1),
            lastActivity: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Update user stats
        await this.updateUserStats('reply');
        
            
            // Reload thread
            this.openThread(threadId);
            showNotification('Reply added successfully!', 'success');
            
        } catch (error) {
            console.error('Error adding reply:', error);
            showNotification('Failed to add reply');
        } finally {
            // Reset the flag and button state
            this.isAddingReply = false;
            if (replyBtn) {
                replyBtn.disabled = false;
                replyBtn.textContent = 'Post Reply';
            }
        }
    }
    
    async extractMentions(text) {
    const mentionRegex = /@([a-zA-Z0-9_]+)/g;
    const mentions = [];
    let match;
    
    while ((match = mentionRegex.exec(text)) !== null) {
        const username = match[1].toLowerCase();
        
        // Verify username exists
        const userSnapshot = await this.db.collection('users')
            .where('username', '==', username)
            .limit(1).get();
        
        if (!userSnapshot.empty) {
            mentions.push({
                username: username,
                userId: userSnapshot.docs[0].id
            });
        }
    }
    
    return mentions;
}

    
async updateUserStats(action) {
    if (!this.currentUser || !this.currentUserProfile) return;
    
    const userStatsRef = this.db.collection('userStats').doc(this.currentUser.uid);
    const statsDoc = await userStatsRef.get();
    
    if (!statsDoc.exists) {
        await userStatsRef.set({
            userId: this.currentUser.uid,
            userName: this.currentUserProfile.displayName, // Updated
            username: this.currentUserProfile.username, // Add username field
            threadCount: action === 'thread' ? 1 : 0,
            replyCount: action === 'reply' ? 1 : 0,
            lastThreadCreated: action === 'thread' ? firebase.firestore.FieldValue.serverTimestamp() : null,
            lastReplyCreated: action === 'reply' ? firebase.firestore.FieldValue.serverTimestamp() : null
        });
    } else {
        const updateData = {};
        if (action === 'thread') {
            updateData.threadCount = firebase.firestore.FieldValue.increment(1);
            updateData.lastThreadCreated = firebase.firestore.FieldValue.serverTimestamp();
        } else if (action === 'reply') {
            updateData.replyCount = firebase.firestore.FieldValue.increment(1);
            updateData.lastReplyCreated = firebase.firestore.FieldValue.serverTimestamp();
        }
        await userStatsRef.update(updateData);
    }
}

        

async loadUserProfile() {
    if (!this.currentUser) return;
    
    try {
        const userStatsDoc = await this.db.collection('userStats').doc(this.currentUser.uid).get();
        const userStats = userStatsDoc.exists ? userStatsDoc.data() : {
            threadCount: 0,
            replyCount: 0,
            lastThreadCreated: null,
            lastReplyCreated: null
        };
        
        this.renderUserProfile(userStats);
    } catch (error) {
        console.error('Error loading user profile:', error);
    }
}

renderUserProfile(userStats) {
    const profileContainer = document.getElementById('userProfile');
    if (!profileContainer) return;
    
    const userName = this.currentUserProfile?.displayName || 'Unknown User'; // Updated
    const username = this.currentUserProfile?.username || 'unknown'; // Add username display
    const lastThread = userStats.lastThreadCreated ? this.getTimeAgo(userStats.lastThreadCreated.toDate()) : 'Never';
    const lastReply = userStats.lastReplyCreated ? this.getTimeAgo(userStats.lastReplyCreated.toDate()) : 'Never';
    
    profileContainer.innerHTML = `
        <div class="user-profile-card">
            <h3>${this.escapeHtml(userName)}</h3>
            <p style="color: var(--text-muted); font-size: 12px; margin: 5px 0;">@${username}</p>
            <div class="profile-stats">
                <div>Threads: ${userStats.threadCount || 0}</div>
                <div>Replies: ${userStats.replyCount || 0}</div>
            </div>
            <div class="profile-activity">
                <div>Last thread: ${lastThread}</div>
                <div>Last reply: ${lastReply}</div>
            </div>
        </div>
    `;
}
        
async loadForumStats() {
    try {
        // Get total threads
        const threadsSnapshot = await this.db.collection('forum').doc('threads').collection('threads').get();
        const totalThreads = threadsSnapshot.size;
        
        // Get unique thread creators
        const userStatsSnapshot = await this.db.collection('userStats').get();
        const totalUsers = userStatsSnapshot.size;
        
        this.renderForumStats(totalThreads, totalUsers);
    } catch (error) {
        console.error('Error loading forum stats:', error);
    }
}

renderForumStats(totalThreads, totalUsers) {
    const statsContainer = document.getElementById('forumStats');
    if (!statsContainer) return;
    
    statsContainer.innerHTML = `
        <div class="forum-stats-card">
            <div class="stat-item">
                <span class="stat-number">${totalThreads}</span>
                <span class="stat-label">Total Threads</span>
            </div>
            <div class="stat-item">
                <span class="stat-number">${totalUsers}</span>
                <span class="stat-label">Active Users</span>
            </div>
        </div>
    `;
}
    
    async toggleLike(threadId) {
        if (!this.currentUser) {
            showNotification('Please sign in to like threads');
            return;
        }
        
        try {
            const threadRef = this.db.collection('forum').doc('threads').collection('threads').doc(threadId);
            const threadDoc = await threadRef.get();
            
            if (!threadDoc.exists) return;
            
            const thread = threadDoc.data();
            const likes = thread.likes || {};
            const isLiked = likes[this.currentUser.uid];
            
            if (isLiked) {
                delete likes[this.currentUser.uid];
                await threadRef.update({
                    likes,
                    likeCount: firebase.firestore.FieldValue.increment(-1)
                });
            } else {
                likes[this.currentUser.uid] = true;
                await threadRef.update({
                    likes,
                    likeCount: firebase.firestore.FieldValue.increment(1)
                });
            }
            
            // Reload thread
            this.openThread(threadId);
            
        } catch (error) {
            console.error('Error toggling like:', error);
            showNotification('Failed to update like');
        }
    }
    
    async deleteThread(threadId) {
        if (!this.currentUser) return;
        
        if (!confirm('Are you sure you want to delete this thread? This action cannot be undone.')) {
            return;
        }
        
        try {
            await this.db.collection('forum').doc('threads').collection('threads').doc(threadId).delete();
            this.closeThreadTab();
            this.loadThreads();
            showNotification('Thread deleted successfully!', 'success');
        } catch (error) {
            console.error('Error deleting thread:', error);
            showNotification('Failed to delete thread');
        }
    }
    
    async deleteReply(threadId, replyId) {
        if (!this.currentUser) return;
        
        if (!confirm('Are you sure you want to delete this reply?')) {
            return;
        }
        
        try {
            await this.db.collection('forum').doc('threads').collection('threads')
                .doc(threadId).collection('replies').doc(replyId).delete();
            
            // Update reply count
            await this.db.collection('forum').doc('threads').collection('threads').doc(threadId).update({
                replyCount: firebase.firestore.FieldValue.increment(-1)
            });
            
            this.openThread(threadId);
            showNotification('Reply deleted successfully!', 'success');
        } catch (error) {
            console.error('Error deleting reply:', error);
            showNotification('Failed to delete reply');
        }
    }
    
    async getUserReadStatus(threadId) {
        if (!this.currentUser) return null;
        
        try {
            const doc = await this.db.collection('forum').doc('userReadStatus')
                .collection(this.currentUser.uid).doc(threadId).get();
            return doc.exists ? doc.data() : null;
        } catch (error) {
            console.error('Error getting read status:', error);
            return null;
        }
    }
    
    async markThreadAsRead(threadId) {
        if (!this.currentUser) return;
        
        try {
            await this.db.collection('forum').doc('userReadStatus')
                .collection(this.currentUser.uid).doc(threadId).set({
                    lastRead: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
        } catch (error) {
            console.error('Error marking thread as read:', error);
        }
    }
    
    updateForumPagination(threadsCount) {
        const paginationInfo = document.getElementById('forumPaginationInfo');
        const prevBtn = document.getElementById('forumPrevBtn');
        const nextBtn = document.getElementById('forumNextBtn');
        const currentPageSpan = document.getElementById('forumCurrentPage');
       
        if (paginationInfo) paginationInfo.textContent = `Page ${this.currentPage}`;
        if (prevBtn) prevBtn.disabled = this.currentPage <= 1;
        if (nextBtn) nextBtn.disabled = threadsCount < this.threadsPerPage;
        if (currentPageSpan) currentPageSpan.textContent = this.currentPage;
    }
    
    closeCreateThreadModal() {
        const modal = document.getElementById('createThreadModal');
        const form = document.getElementById('createThreadForm');
        if (modal) modal.classList.remove('show');
        if (form) form.reset();
        
        // Reset the creation flag when modal is closed
        this.isCreatingThread = false;
        
        // Reset submit button if it exists
        const submitBtn = document.querySelector('#createThreadForm button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Create Thread';
        }
    }
    
    // Updated to close thread tab instead of modal
    closeThreadDetailModal() {
        this.closeThreadTab();
    }
    
    showForumError(message) {
        const threadList = document.getElementById('threadList');
        if (threadList) {
            threadList.innerHTML = `
                <div class="empty-state">
                    <h3>Error</h3>
                    <p>${message}</p>
                    <button class="btn" onclick="forumManager.loadThreads()">Retry</button>
                </div>
            `;
        }
    }
    
    getTimeAgo(date) {
        const now = new Date();
        const diffInSeconds = Math.floor((now - date) / 1000);
        
        if (diffInSeconds < 60) return 'Just now';
        if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
        if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
        if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)}d ago`;
        
        return date.toLocaleDateString();
    }
    
    
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
}

// Global forum functions - updated for tab navigation
function closeCreateThreadModal() {
    if (window.forumManager) {
        window.forumManager.closeCreateThreadModal();
    }
}

function closeThreadDetailModal() {
    if (window.forumManager) {
        window.forumManager.closeThreadTab();
    }
}

async function loadThreadsForHome() {
    try {
        if (!forumManager.db) {
            console.log('⏳ DB not ready, retrying...');
            setTimeout(loadThreadsForHome, 1000);
            return;
        }
        
        // Use same query as loadThreads but limit to 5 threads
        const query = forumManager.db.collection('forum').doc('threads').collection('threads')
            .orderBy('lastActivity', 'desc')
            .limit(6);

        const snapshot = await query.get();
        const threads = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        console.log('✅ HOME TAB: Got', threads.length, 'threads');
        renderThreadsOnHome(threads);
        
    } catch (error) {
        console.error('❌ HOME TAB: Error:', error);
        document.getElementById('homeRecentThreads').innerHTML = 
            '<p style="color: var(--text-secondary);">Failed to load forum threads</p>';
    }
}

function renderThreadsOnHome(threads) {
    const homeThreadsContainer = document.getElementById('homeRecentThreads');
    if (!homeThreadsContainer) return;
    
    if (threads.length === 0) {
        homeThreadsContainer.innerHTML = '<p style="color: var(--text-secondary);">No recent forum activity</p>';
        return;
    }
    
    homeThreadsContainer.innerHTML = `
        <h3 style="color: #4F46E5; margin-bottom: 15px;">Recent Forum Activity</h3>
        ${threads.map(thread => {
            const timeAgo = forumManager.getTimeAgo(thread.createdAt?.toDate() || new Date());
            return `
                <div style="border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: pointer;" 
                     onclick="switchTab('forum'); setTimeout(() => forumManager.openThreadTab('${thread.id}'), 100);">
                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">
                        ${forumManager.escapeHtml(thread.title)}
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
                        ${thread.category} • by ${forumManager.escapeHtml(thread.authorName)} • ${timeAgo}
                    </div>
                    <div style="font-size: 13px; color: var(--text-muted);">
                        ${forumManager.escapeHtml(thread.content).substring(0, 100)}${thread.content.length > 100 ? '...' : ''}
                    </div>
                    <div style="display: flex; gap: 15px; margin-top: 8px; font-size: 11px; color: var(--text-muted);">
                        <span><i class="fas fa-solid fa-thumbs-up"></i> ${thread.likeCount || 0}</span>
                        <span><i class="fas fa-solid fa-comment"></i> ${thread.replyCount || 0}</span>
                    </div>
                </div>
            `;
        }).join('')}
        <div style="text-align: center; margin-top: 15px;">
            <button onclick="switchTab('forum')" style="background: none; border: 1px solid #4F46E5; color: #4F46E5; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                View All Threads →
            </button>
        </div>
    `;
}

// Initialize forum manager
let forumManager = null;
// Initialize forum manager immediately
forumManager = new ForumManager();

    </script>

    <script>
        // App version for cache busting - IMPORTANT: UPDATE THIS WHEN MAKING CHANGES
        const APP_VERSION = '3.2.27';
        
        // Tab title mapping
const tabTitles = {
    'home': 'Home - Disciplin',
    'howto': 'Guide - Disciplin',
    'chat': 'Chat - Disciplin',
    'insights': 'Stats - Disciplin',
    'log': 'Log Entry -  Disciplin',
    'journal': 'Journal - Disciplin',
    'history': 'History - Disciplin',
    'backup': 'Back Up - Disciplin',
    'resources': 'History - Disciplin'
};
        
        // History pagination variables
        let currentHistoryPage = 1;
        let entriesPerPage = 10;
        let selectedEntries = new Set();
        let allEntries = [];
        
        // New variables for enhanced features
        let currentJournalMood = '';
        let currentMood = '';
        let deleteEntryId = null;
        let selectedEntriesToDelete = [];
        let deferredPrompt = null;
        let notificationPermission = false;
        let inactivityTimer = null;

        // Level system configuration
        const levelSystem = {
            levels: [
                { level: 1, name: 'Beginner', icon: 'fas fa-seedling', minXP: 0, color: '#cd7f32' },
                { level: 2, name: 'Novice', icon: 'fas fa-leaf', minXP: 100, color: '#cd7f32' },
                { level: 3, name: 'Apprentice', icon: 'fas fa-tree', minXP: 300, color: '#cd7f32' },
                { level: 4, name: 'Warrior', icon: 'fas fa-sword', minXP: 600, color: '#c0c0c0' },
                { level: 5, name: 'Guardian', icon: 'fas fa-shield-alt', minXP: 1000, color: '#c0c0c0' },
                { level: 6, name: 'Champion', icon: 'fas fa-medal', minXP: 1500, color: '#c0c0c0' },
                { level: 7, name: 'Master', icon: 'fas fa-crown', minXP: 2200, color: '#ffd700' },
                { level: 8, name: 'Legend', icon: 'fas fa-star', minXP: 3000, color: '#ffd700' },
                { level: 9, name: 'Hero', icon: 'fas fa-trophy', minXP: 4000, color: '#ffd700' },
                { level: 10, name: 'Sage', icon: 'fas fa-infinity', minXP: 5500, color: '#ffd700' }
            ]
        };

        // Achievement definitions with Font Awesome icons
        const achievements = [
            { id: 'first_day', icon: '<i class="fas fa-seedling"></i>', text: 'First Day', condition: (streak) => streak >= 1 },
            { id: 'three_days', icon: '<i class="fas fa-fire"></i>', text: '3 Days Strong', condition: (streak) => streak >= 3 },
            { id: 'week_warrior', icon: '<i class="fas fa-bolt"></i>', text: 'Week Warrior', condition: (streak) => streak >= 7 },
            { id: 'two_weeks', icon: '<i class="fas fa-rocket"></i>', text: 'Two Weeks', condition: (streak) => streak >= 14 },
            { id: 'month_master', icon: '<i class="fas fa-medal"></i>', text: 'Month Master', condition: (streak) => streak >= 30 },
            { id: 'quarter_champion', icon: '<i class="fas fa-gem"></i>', text: 'Quarter Champion', condition: (streak) => streak >= 90 },
            { id: 'six_months', icon: '<i class="fas fa-crown"></i>', text: 'Half Year King', condition: (streak) => streak >= 180 },
            { id: 'year_legend', icon: '<i class="fas fa-trophy"></i>', text: 'Year Legend', condition: (streak) => streak >= 365 }
        ];

        // Motivational texts
        const motivationalTexts = [
            "Everyday is a new day, to achieve something new",
            "Every urge resisted is a win",
            "Progress is Progress no matter how small"
        ];

        // Notification messages
        const notificationMessages = [
            "Time to check in with your progress! 💪",
            "Remember your goals - how are you doing today? 🎯",
            "Your streak is waiting for you to log today's progress! 🔥",
            "Stay consistent - check in with Disciplin now! 📈",
            "Don't break the chain - log your daily progress! ⛓️"
        ];
        
        // Mandatory update functions
function showMandatoryUpdateModal(registration) {
    // Store the registration for later use
    window.pendingUpdateRegistration = registration;
    
    // Show the mandatory update modal
    document.getElementById('mandatoryUpdateModal').classList.add('show');
    
    // Disable all other interactions by adding overlay
    document.body.style.pointerEvents = 'none';
    document.getElementById('mandatoryUpdateModal').style.pointerEvents = 'auto';
}

function goToBackupTab() {
    // Close the update modal temporarily
    document.getElementById('mandatoryUpdateModal').classList.remove('show');
    
    // Re-enable interactions
    document.body.style.pointerEvents = 'auto';
    
    // Switch to backup tab
    switchTab('backup');
    
    // Show the modal again after a short delay
    setTimeout(() => {
        document.getElementById('mandatoryUpdateModal').classList.add('show');
        document.body.style.pointerEvents = 'none';
        document.getElementById('mandatoryUpdateModal').style.pointerEvents = 'auto';
    }, 2000);
    
    // Show a reminder notification
    showNotification('Backup your data, then return here to update!', 'success');
}

function applyMandatoryUpdate() {
    // Show loading state
    const updateBtn = document.querySelector('#mandatoryUpdateModal .modal-btn.primary');
    const originalText = updateBtn.innerHTML;
    updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
    updateBtn.disabled = true;
    
    // Clear all caches
    if ('caches' in window) {
        caches.keys().then(names => {
            names.forEach(name => {
                caches.delete(name);
            });
        });
    }
    
    // Update the stored version
    localStorage.setItem('disciplin_version', APP_VERSION);
    
    // Apply the service worker update
    if (window.pendingUpdateRegistration && window.pendingUpdateRegistration.waiting) {
        window.pendingUpdateRegistration.waiting.postMessage({ type: 'SKIP_WAITING' });
    }
    
    // Force reload without confirmation after a brief delay
    setTimeout(() => {
        window.location.reload(true);
    }, 1000);
}

// Goals Management
function getGoals() {
    const goals = localStorage.getItem('disciplin_goals');
    return goals ? JSON.parse(goals) : [];
}

function saveGoals(goals) {
    localStorage.setItem('disciplin_goals', JSON.stringify(goals));
}

function showAddGoalModal() {
    document.getElementById('addGoalModal').classList.add('show');
    trackActivity();
}

function closeAddGoalModal() {
    document.getElementById('addGoalModal').classList.remove('show');
    // Reset form
    document.getElementById('goalTarget').value = '';
    document.getElementById('goalTitle').value = '';
    document.getElementById('goalDescription').value = '';
    document.getElementById('streakGoal').checked = true;
}

function createGoal() {
    const target = parseInt(document.getElementById('goalTarget').value);
    const title = document.getElementById('goalTitle').value;
    const description = document.getElementById('goalDescription').value;
    const type = document.querySelector('input[name="goalType"]:checked').value;
    
    if (!target || target < 1) {
        showNotification('Please enter a valid target number');
        return;
    }
    
    const goal = {
        id: Date.now(),
        type: type,
        target: target,
        title: title || `${target} Day${target > 1 ? 's' : ''} ${type === 'streak' ? 'Streak' : 'Goal'}`,
        description: description,
        progress: 0,
        completed: false,
        createdAt: new Date().toISOString()
    };
    
    const goals = getGoals();
    goals.push(goal);
    saveGoals(goals);
    
    closeAddGoalModal();
    updateGoalsDisplay();
    trackActivity();
    showNotification('Goal created successfully!', 'success');
}

function updateGoalsDisplay() {
    const goals = getGoals();
    const container = document.getElementById('goalsContainer');
    
    if (goals.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                <h3>No goals set yet</h3>
                <p>Create your first goal to start tracking your progress!</p>
            </div>
        `;
        return;
    }
    
    // Update goal progress based on current stats
    const entries = getEntries().sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    let currentStreak = 0;
    
    // Calculate current streak
    for (let i = entries.length - 1; i >= 0; i--) {
        if (!entries[i].masturbated) {
            currentStreak++;
        } else {
            break;
        }
    }
    
    goals.forEach(goal => {
        if (goal.type === 'streak') {
            goal.progress = currentStreak;
        }
        
        // Check if goal is completed
        if (!goal.completed && goal.progress >= goal.target) {
            goal.completed = true;
            showGoalAchievementModal(goal);
        }
    });
    
    saveGoals(goals);
    
    container.innerHTML = goals.map(goal => {
        const progressPercentage = Math.min((goal.progress / goal.target) * 100, 100);
        
        return `
            <div class="goal-item ${goal.completed ? 'completed' : ''}">
                <div class="goal-header">
                    <div class="goal-title">${goal.title}</div>
                    <div style="display: flex; align-items: center;">
                        <span class="goal-status ${goal.completed ? 'completed' : 'active'}">
                            ${goal.completed ? 'Completed' : 'Active'}
                        </span>
                        <button class="delete-goal-btn" onclick="deleteGoal(${goal.id})">×</button>
                    </div>
                </div>
                <div class="goal-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                    </div>
                    <div class="progress-text">
                        <span>${goal.progress}/${goal.target} ${goal.type === 'streak' ? 'days' : 'completed'}</span>
                        <span>${Math.round(progressPercentage)}%</span>
                    </div>
                </div>
                ${goal.description ? `<div class="goal-description">${goal.description}</div>` : ''}
            </div>
        `;
    }).join('');
}

function deleteGoal(goalId) {
    if (confirm('Are you sure you want to delete this goal?')) {
        const goals = getGoals().filter(goal => goal.id !== goalId);
        saveGoals(goals);
        updateGoalsDisplay();
        trackActivity();
        showNotification('Goal deleted successfully!', 'success');
    }
}

function showGoalAchievementModal(goal) {
    const modal = document.getElementById('goalAchievementModal');
    const text = document.getElementById('achievementText');
    
    text.textContent = `Congratulations! You've achieved your goal: "${goal.title}"! Keep up the amazing work! `;
    
    modal.classList.add('show');
    
    // Show celebration notification
    setTimeout(() => {
        showNotification(` Goal Achieved: ${goal.title}!`, 'success');
    }, 500);
}

function closeGoalAchievementModal() {
    document.getElementById('goalAchievementModal').classList.remove('show');
}

        // Level System Functions
        function calculateUserLevel(entries) {
            let xp = 0;
            let currentStreak = 0;
            let longestStreak = 0;
            let tempStreak = 0;
            
            // Calculate streaks and XP
            for (let i = 0; i < entries.length; i++) {
                if (!entries[i].masturbated) {
                    tempStreak++;
                    longestStreak = Math.max(longestStreak, tempStreak);
                    xp += 10; // 10 XP per clean day
                } else {
                    tempStreak = 0;
                }
            }
            
            // Calculate current streak
            for (let i = entries.length - 1; i >= 0; i--) {
                if (!entries[i].masturbated) {
                    currentStreak++;
                } else {
                    break;
                }
            }
            
            // Bonus XP for achievements
            achievements.forEach(achievement => {
                if (achievement.condition(longestStreak)) {
                    xp += 50; // 50 bonus XP per achievement
                }
            });
            
            // Bonus XP for journal entries
            const journalEntries = getJournalEntries();
            xp += journalEntries.length * 5; // 5 XP per journal entry
            
            // Find current level
            let currentLevel = levelSystem.levels[0];
            for (let level of levelSystem.levels) {
                if (xp >= level.minXP) {
                    currentLevel = level;
                } else {
                    break;
                }
            }
            
            return { xp, currentLevel, currentStreak, longestStreak };
        }
        
        

        function updateLevelSystem() {
            const entries = getEntries().sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            const { xp, currentLevel, currentStreak } = calculateUserLevel(entries);
            
            // Update level display
            const levelIcon = document.getElementById('levelIcon');
            const levelText = document.getElementById('levelText');
            const xpFill = document.getElementById('xpFill');
            const xpText = document.getElementById('xpText');
            
            if (levelIcon && levelText && xpFill && xpText) {
                levelIcon.className = `level-icon ${currentLevel.icon}`;
                levelIcon.style.color = currentLevel.color;
                levelText.textContent = `Level ${currentLevel.level}: ${currentLevel.name}`;
                
                // Calculate XP progress to next level
                const nextLevel = levelSystem.levels.find(level => level.minXP > xp);
                if (nextLevel) {
                    const progressPercent = ((xp - currentLevel.minXP) / (nextLevel.minXP - currentLevel.minXP)) * 100;
                    xpFill.style.width = `${Math.min(100, Math.max(0, progressPercent))}%`;
                    xpText.textContent = `${xp}/${nextLevel.minXP} XP to Level ${nextLevel.level}`;
                } else {
                    xpFill.style.width = '100%';
                    xpText.textContent = `${xp} XP - Max Level Reached!`;
                }
            }
            
            // Update streak flames
            updateStreakFlames(currentStreak);
        }

        function updateStreakFlames(currentStreak) {
            const streakFlames = document.getElementById('streakFlames');
            if (!streakFlames) return;
            
            const maxFlames = 10;
            const flamesToShow = Math.min(currentStreak, maxFlames);
            
            let flamesHTML = '';
            for (let i = 0; i < maxFlames; i++) {
                const isActive = i < flamesToShow;
                const flameClass = isActive ? 'flame active' : 'flame inactive';
                flamesHTML += `<i class="${flameClass} fas fa-fire"></i>`;
            }
            
            if (currentStreak > maxFlames) {
                flamesHTML += `<span style="color: var(--flame-color); font-weight: bold; margin-left: 10px;">+${currentStreak - maxFlames}</span>`;
            }
            
            streakFlames.innerHTML = flamesHTML;
        }

        // Journal Functions
        function saveJournalEntry() {
            const journalText = document.getElementById('journalText').value.trim();
            
            if (!journalText) {
                showNotification('Please write something in your journal entry');
                return;
            }
            
            const entry = {
                id: Date.now(),
                date: new Date().toDateString(),
                timestamp: new Date().toISOString(),
                text: journalText,
                mood: currentJournalMood
            };
            
            const journalEntries = getJournalEntries();
            journalEntries.push(entry);
            localStorage.setItem('disciplin_journal', JSON.stringify(journalEntries));
            
            // Clear form
            document.getElementById('journalText').value = '';
            currentJournalMood = '';
            document.querySelectorAll('.journal-mood-btn').forEach(btn => btn.classList.remove('selected'));
            
            // Reload journal display
            loadJournalEntries();
            updateLevelSystem(); // Update XP for journal entry
            
            showNotification('Journal entry saved successfully!', 'success');
            trackActivity();
        }

        function getJournalEntries() {
            const entries = localStorage.getItem('disciplin_journal');
            return entries ? JSON.parse(entries) : [];
        }

        function loadJournalEntries() {
            const journalEntries = getJournalEntries();
            const container = document.getElementById('journalEntries');
            
            if (!container) return;
            
            if (journalEntries.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3> No journal entries yet</h3>
                        <p>Start writing your thoughts and reflections to track your journey.</p>
                    </div>
                `;
                return;
            }
            
// Sort by most recent first
journalEntries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

// Add slider class to container
container.className = 'journal-slider-container';

container.innerHTML = journalEntries.map(entry => `
    <div class="journal-entry">
        <div class="journal-header">
            <div class="journal-date">${new Date(entry.timestamp).toLocaleDateString()}</div>
            <div class="journal-mood">${entry.mood || '📝'}</div>
        </div>
        <div class="journal-content">
            <p style="margin-bottom: 15px;">${entry.text}</p>
        </div>
        <button onclick="deleteJournalEntry(${entry.id})" style="
            background: #ef4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 10px;
            float: right;
        ">
            <i class="fas fa-trash"></i> Delete
        </button>
        <div style="clear: both;"></div>
    </div>
`).join('');
        }

        function deleteJournalEntry(entryId) {
            if (!confirm('Are you sure you want to delete this journal entry?')) {
                return;
            }
            
            const journalEntries = getJournalEntries().filter(entry => entry.id !== entryId);
            localStorage.setItem('disciplin_journal', JSON.stringify(journalEntries));
            
            loadJournalEntries();
            updateLevelSystem(); // Update XP
            showNotification('Journal entry deleted', 'success');
        }

        // Personalized Insights Functions
        function generatePersonalizedInsights() {
            const entries = getEntries();
            const journalEntries = getJournalEntries();
            const insights = [];
            
            if (entries.length < 3) {
                insights.push({
                    icon: 'fas fa-info-circle',
                    text: 'Keep logging entries to unlock personalized insights based on your patterns.'
                });
                return insights;
            }
            
            // Analyze patterns
            const recentEntries = entries.slice(-14); // Last 14 days
            const relapseCount = recentEntries.filter(e => e.masturbated).length;
            const cleanCount = recentEntries.filter(e => !e.masturbated).length;
            
            // Current streak analysis
            let currentStreak = 0;
            for (let i = entries.length - 1; i >= 0; i--) {
                if (!entries[i].masturbated) {
                    currentStreak++;
                } else {
                    break;
                }
            }
            
            // Generate insights based on patterns
            if (currentStreak >= 7) {
                insights.push({
                    icon: 'fas fa-fire',
                    text: `Excellent work! You're on a ${currentStreak}-day streak. Your consistency is building strong habits.`
                });
            } else if (currentStreak >= 3) {
                insights.push({
                    icon: 'fas fa-seedling',
                    text: `Good progress with your ${currentStreak}-day streak. Keep building momentum!`
                });
            }
            
            // Energy level insights
            const energyData = {};
            entries.forEach(entry => {
                if (entry.energy && !entry.masturbated) {
                    energyData[entry.energy] = (energyData[entry.energy] || 0) + 1;
                }
            });
            
            if (Object.keys(energyData).length > 0) {
                const mostFrequentEnergy = Object.keys(energyData).reduce((a, b) => energyData[a] > energyData[b] ? a : b);
                insights.push({
                    icon: 'fas fa-battery-three-quarters',
                    text: `Your energy levels are typically "${mostFrequentEnergy}" on clean days. Maintain good energy management!`
                });
            }
            
            // Sleep pattern insights
            const lateNightRelapses = entries.filter(e => e.masturbated && e.sleepTime === 'After 12am').length;
            const totalRelapses = entries.filter(e => e.masturbated).length;
            
            if (totalRelapses > 0 && lateNightRelapses / totalRelapses > 0.4) {
                insights.push({
                    icon: 'fas fa-moon',
                    text: 'Consider improving your sleep schedule. Late nights seem to be a trigger for you.'
                });
            }
            
            // Time of day insights
            const timeData = {};
            entries.forEach(entry => {
                if (entry.masturbated && entry.timeOfDay) {
                    entry.timeOfDay.forEach(time => {
                        timeData[time] = (timeData[time] || 0) + 1;
                    });
                }
            });
            
            if (Object.keys(timeData).length > 0) {
                const riskiestTime = Object.keys(timeData).reduce((a, b) => timeData[a] > timeData[b] ? a : b);
                insights.push({
                    icon: 'fas fa-clock',
                    text: `Be extra mindful during ${riskiestTime} hours - this appears to be your highest risk time.`
                });
            }
            
            // Journal insights
            if (journalEntries.length > 5) {
                insights.push({
                    icon: 'fas fa-journal-whills',
                    text: `Great job maintaining your journal! You've written ${journalEntries.length} entries. Reflection strengthens self-awareness.`
                });
            } else if (journalEntries.length > 0) {
                insights.push({
                    icon: 'fas fa-pen',
                    text: 'Consider writing more journal entries. Reflection helps identify patterns and triggers.'
                });
            }
            
            // Progress insights
            const successRate = cleanCount / Math.max(recentEntries.length, 1) * 100;
            if (successRate >= 80) {
                insights.push({
                    icon: 'fas fa-chart-line',
                    text: `Outstanding! Your recent success rate is ${Math.round(successRate)}%. You're developing strong self-control.`
                });
            } else if (successRate >= 60) {
                insights.push({
                    icon: 'fas fa-trending-up',
                    text: `Good progress with a ${Math.round(successRate)}% success rate. Focus on consistency to reach the next level.`
                });
            } else {
                insights.push({
                    icon: 'fas fa-heart',
                    text: 'Every journey has ups and downs. Stay committed - small improvements compound over time.'
                });
            }
            
            return insights;
        }

        function updatePersonalizedInsights() {
            const insights = generatePersonalizedInsights();
            const container = document.getElementById('personalInsightsList');
            
            if (!container) return;
            
            container.innerHTML = insights.map(insight => `
                <div class="insight-card">
                    <div class="insight-icon">
                        <i class="${insight.icon}"></i>
                    </div>
                    <div class="insight-text">${insight.text}</div>
                </div>
            `).join('');
        }

        // Dark Mode functionality
        function initializeDarkMode() {
            const savedTheme = localStorage.getItem('disciplin_theme') || 'dark';
            const darkModeToggle = document.getElementById('darkModeToggle');
            
            // Apply saved theme
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateDarkModeToggle(savedTheme);
            
            // Also update the theme-color meta tag
            updateThemeColor(savedTheme);
        }

        function toggleDarkMode() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('disciplin_theme', newTheme);
            updateDarkModeToggle(newTheme);
            updateThemeColor(newTheme);
            
            // Track this as user activity
            trackActivity();
            
            // Show a subtle notification
            showNotification(`Switched to ${newTheme} mode`, 'success');
        }

        function updateDarkModeToggle(theme) {
            const darkModeToggle = document.getElementById('darkModeToggle');
            if (darkModeToggle) {
                if (theme === 'dark') {
                    darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                    darkModeToggle.title = 'Switch to Light Mode';
                } else {
                    darkModeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                    darkModeToggle.title = 'Switch to Dark Mode';
                }
            }
        }

        function updateThemeColor(theme) {
            const themeColorMeta = document.querySelector('meta[name="theme-color"]');
            if (themeColorMeta) {
                themeColorMeta.content = theme === 'dark' ? '#2d2d2d' : '#4F46E5';
            }
        }

        // Hybrid Service Worker Registration - tries external file first, falls back to inline
        if ('serviceWorker' in navigator) {
            // Try to register external service worker first
            navigator.serviceWorker.register('service-worker.js')
                .then(registration => {
                    console.log('External Service Worker registered successfully');
                    setupServiceWorkerHandlers(registration);
                })
                .catch(error => {
                    console.log('Inline Service Worker registration failed:', error);
                });
        }

        // Hybrid Manifest approach - try external first, fallback to inline
        function setupManifest() {
            // Check if external manifest.json exists
            fetch('manifest.json')
                .then(response => {
                    if (response.ok) {
                        console.log('Using external manifest.json');
                        // External manifest exists, use it (already linked in HTML)
                    } else {
                        throw new Error('External manifest not found');
                    }
                })
                .catch(() => {
                    console.log('External manifest not found, using inline version');
                    // Create inline manifest as fallback
                    const manifest = {
                        "name": "Disciplin",
                        "short_name": "Disciplin", 
                        "description": "Personal habit tracking app with notifications",
                        "start_url": "./",
                        "display": "standalone",
                        "background_color": "#4F46E5",
                        "theme_color": "#4F46E5",
                        "orientation": "portrait",
                        "scope": "./",
                        "icons": [
                            {
                                "src": "https://miseducatemen.wordpress.com/wp-content/uploads/2025/07/dp_512x512_1_192x192.jpg",
                                "sizes": "192x192",
                                "type": "image/png",
                                "purpose": "any maskable"
                            },
                            {
                                "src": "https://miseducatemen.wordpress.com/wp-content/uploads/2025/07/dp_512x512.jpg",
                                "sizes": "512x512", 
                                "type": "image/png",
                                "purpose": "any maskable"
                            }
                        ],
                        "categories": ["productivity", "health", "lifestyle"],
                        "lang": "en-US",
                        "dir": "ltr"
                    };

                    const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
                    const manifestURL = URL.createObjectURL(manifestBlob);
                    
                    // Update the manifest link to use inline version
                    const manifestLink = document.querySelector('link[rel="manifest"]');
                    if (manifestLink) {
                        manifestLink.href = manifestURL;
                    }
                });
        }

        // Initialize manifest setup
        setupManifest();

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js').then(reg => {
                reg.onupdatefound = () => {
                    const installingWorker = reg.installing;
                    installingWorker.onstatechange = () => {
                        if (installingWorker.state === 'installed') {
                            if (navigator.serviceWorker.controller) {
                                // New content is available
                                const userConfirmed = confirm("A new update is available. Please backup your entries and refresh to update.");
                                if (userConfirmed) {
                                    reg.waiting.postMessage({ type: 'SKIP_WAITING' });
                                    window.location.reload();
                                }
                            }
                        }
                    };
                };
            }).catch(err => {
                console.log('External Service Worker registration failed, inline version will be used:', err);
            });
        }

        // History pagination functions
        function loadHistory() {
            allEntries = getEntries().sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            selectedEntries.clear();
            updateSelectedCount();
            currentHistoryPage = 1;
            renderHistoryPage();
        }

        function renderHistoryPage() {
            const historyList = document.getElementById('historyList');
            const totalEntries = allEntries.length;

            if (totalEntries === 0) {
                historyList.innerHTML = `
                    <div class="empty-state">
                        <h3>No entries yet</h3>
                        <p>Start logging your daily activities to see your history here.</p>
                    </div>
                `;
                updatePaginationInfo(0, 0, 0);
                return;
            }

            const startIndex = (currentHistoryPage - 1) * entriesPerPage;
            const endIndex = Math.min(startIndex + entriesPerPage, totalEntries);
            const entriesForPage = allEntries.slice(startIndex, endIndex);

            historyList.innerHTML = entriesForPage.map(entry => `
                <div class="history-item ${selectedEntries.has(entry.id) ? 'selected' : ''}">
                    <input type="checkbox" 
                           class="history-item-checkbox" 
                           ${selectedEntries.has(entry.id) ? 'checked' : ''}
                           onchange="toggleEntrySelection(${entry.id}, this.checked)">
                    <div class="history-item-content">
                        <div class="history-date">${new Date(entry.timestamp).toLocaleDateString()}</div>
                        <div class="history-status">
                            <span class="status-badge ${entry.masturbated ? 'status-relapse' : 'status-success'}">
                                ${entry.masturbated ? 'Relapsed' : 'Clean Day'}
                            </span>
                            ${entry.mood ? entry.mood : ''}
                        </div>
                        ${entry.energy ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 3px; transition: color 0.3s ease;">Energy: ${entry.energy}</div>` : ''}
                        ${entry.timeOfDay && entry.timeOfDay.length > 0 ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 3px; transition: color 0.3s ease;">Time: ${entry.timeOfDay.join(', ')}</div>` : ''}
                        ${entry.sleepTime ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 3px; transition: color 0.3s ease;">Sleep: ${entry.sleepTime}</div>` : ''}
                        ${entry.notes ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px; transition: color 0.3s ease;">${entry.notes}</div>` : ''}
                    </div>
                    <button class="delete-btn" onclick="showDeleteModal(${entry.id})">Delete</button>
                </div>
            `).join('');

            updatePaginationInfo(startIndex + 1, endIndex, totalEntries);
            updatePaginationButtons();
        }

        function updatePaginationInfo(start, end, total) {
            const paginationInfo = document.getElementById('paginationInfo');
            if (total === 0) {
                paginationInfo.textContent = 'No entries found';
            } else {
                paginationInfo.textContent = `Showing ${start}-${end} of ${total} entries`;
            }
        }

        function updatePaginationButtons() {
            const totalPages = Math.ceil(allEntries.length / entriesPerPage);
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const currentPageSpan = document.getElementById('currentPage');

            prevBtn.disabled = currentHistoryPage <= 1;
            nextBtn.disabled = currentHistoryPage >= totalPages;
            currentPageSpan.textContent = `${currentHistoryPage} of ${totalPages}`;
        }

        function previousPage() {
            if (currentHistoryPage > 1) {
                currentHistoryPage--;
                renderHistoryPage();
                trackActivity();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(allEntries.length / entriesPerPage);
            if (currentHistoryPage < totalPages) {
                currentHistoryPage++;
                renderHistoryPage();
                trackActivity();
            }
        }

        // Multiple selection functions
        function toggleEntrySelection(entryId, isSelected) {
            const historyItem = event.target.closest('.history-item');
            
            if (isSelected) {
                selectedEntries.add(entryId);
                historyItem.classList.add('selected');
            } else {
                selectedEntries.delete(entryId);
                historyItem.classList.remove('selected');
            }
            
            updateSelectedCount();
            updateSelectAllButton();
            trackActivity();
        }

        function toggleSelectAll() {
            const startIndex = (currentHistoryPage - 1) * entriesPerPage;
            const endIndex = Math.min(startIndex + entriesPerPage, allEntries.length);
            const entriesForPage = allEntries.slice(startIndex, endIndex);
            
            const allPageEntriesSelected = entriesForPage.every(entry => selectedEntries.has(entry.id));
            
            entriesForPage.forEach(entry => {
                if (allPageEntriesSelected) {
                    selectedEntries.delete(entry.id);
                } else {
                    selectedEntries.add(entry.id);
                }
            });
            
            renderHistoryPage();
            updateSelectedCount();
            updateSelectAllButton();
            trackActivity();
        }

        function updateSelectedCount() {
            const selectedCount = document.getElementById('selectedCount');
            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            
            selectedCount.textContent = `${selectedEntries.size} selected`;
            deleteSelectedBtn.disabled = selectedEntries.size === 0;
        }

        function updateSelectAllButton() {
            const selectAllBtn = document.getElementById('selectAllBtn');
            const startIndex = (currentHistoryPage - 1) * entriesPerPage;
            const endIndex = Math.min(startIndex + entriesPerPage, allEntries.length);
            const entriesForPage = allEntries.slice(startIndex, endIndex);
            
            const allPageEntriesSelected = entriesForPage.length > 0 && 
                                         entriesForPage.every(entry => selectedEntries.has(entry.id));
            
            selectAllBtn.textContent = allPageEntriesSelected ? 'Deselect All' : 'Select All';
        }

        function deleteSelectedEntries() {
            if (selectedEntries.size === 0) return;
            
            selectedEntriesToDelete = Array.from(selectedEntries);
            const deleteText = document.getElementById('deleteSelectedText');
            deleteText.textContent = `Are you sure you want to delete ${selectedEntriesToDelete.length} selected entries? This action cannot be undone.`;
            
            document.getElementById('deleteSelectedModal').classList.add('show');
        }

        function closeDeleteSelectedModal() {
            document.getElementById('deleteSelectedModal').classList.remove('show');
            selectedEntriesToDelete = [];
        }

        function confirmDeleteSelected() {
            if (selectedEntriesToDelete.length === 0) return;
            
            const entries = getEntries().filter(entry => !selectedEntriesToDelete.includes(entry.id));
            localStorage.setItem('disciplin_entries', JSON.stringify(entries));
            
            selectedEntries.clear();
            selectedEntriesToDelete = [];
            closeDeleteSelectedModal();
            
            // Refresh all views
            loadHistory();
            updateStatsWithTimer();
            updateAchievements();
            updateWeeklyInsights();
            updateStreakNotification();
            updateLevelSystem();
            updatePersonalizedInsights();
            
            trackActivity();
            showNotification(`Selected entries deleted successfully!`, 'success');
            alert(`✅ Selected entries deleted successfully!`);
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeDarkMode(); // Initialize dark mode first
            
            initAnalytics(); // Initialize analytics
            showWelcomeModal();
            checkForUpdates();
            initializeApp();                      
            loadThreadsForHome();
            setupEventListeners();
            updateStats();
            updateStatsWithTimer();
            loadHistory();
            updateAchievements();
            updateWeeklyInsights();
            updateLevelSystem();
            updatePersonalizedInsights();
            
            loadJournalEntries();
            
            rotateMotiationTexts();
            initializeNotifications();
            setupInactivityTimer();
            initializeTimer(); 
            updateGoalsDisplay();
      updateFloatingNotificationButton();
  
      updatePageTitle('home');
      // Initialize forum
    forumManager = new ForumManager();
    window.forumManager = forumManager; 
        
        });

        // Fixed version checking function
        function checkForUpdates() {
            const storedVersion = localStorage.getItem('disciplin_version');
            console.log('Stored version:', storedVersion, 'Current version:', APP_VERSION);
            
            // Only show update notification if there's a stored version and it's different
            if (storedVersion && storedVersion !== APP_VERSION) {
                console.log('New version detected, showing update notification');
                // Show update notification after a short delay
                setTimeout(() => {
                    showUpdateNotification();
                }, 1000);
            } else if (!storedVersion) {
                // First time user, set the version
                localStorage.setItem('disciplin_version', APP_VERSION);
            }
        }

        function showUpdateNotification() {
            const updateNotification = document.getElementById('updateNotification');
            updateNotification.classList.add('show');
        }

        function hideUpdateNotification() {
            const updateNotification = document.getElementById('updateNotification');
            updateNotification.classList.remove('show');
        }
// Timer functionality - Add these functions to your existing JavaScript

let timerInterval = null;
let timerStartTime = null;
let timerType = null; // 'clean' or 'relapse'

function initializeTimer() {
    const entries = getEntries().sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    
    if (entries.length === 0) {
        showNoEntriesTimer();
        return;
    }
    
    const timerData = calculateTimerData(entries);
    updateTimerDisplay(timerData);
    startTimerUpdates();
}

function calculateTimerData(entries) {
    let consecutiveCleanStart = null;
    let consecutiveRelapseStart = null;
    let currentStreakType = null;
    
    // Find the most recent consecutive streak
    for (let i = entries.length - 1; i >= 0; i--) {
        const entry = entries[i];
        const isClean = !entry.masturbated;
        
        if (i === entries.length - 1) {
            // Start with the most recent entry type
            currentStreakType = isClean ? 'clean' : 'relapse';
            if (isClean) {
                consecutiveCleanStart = entry.timestamp;
            } else {
                consecutiveRelapseStart = entry.timestamp;
            }
        } else {
            // Check if streak continues
            if (currentStreakType === 'clean' && isClean) {
                consecutiveCleanStart = entry.timestamp;
            } else if (currentStreakType === 'relapse' && !isClean) {
                consecutiveRelapseStart = entry.timestamp;
            } else {
                // Streak broken, stop looking
                break;
            }
        }
    }
    
    return {
        type: currentStreakType,
        startTime: currentStreakType === 'clean' ? consecutiveCleanStart : consecutiveRelapseStart,
        isClean: currentStreakType === 'clean'
    };
}

function updateTimerDisplay(timerData) {
    const timerSection = document.getElementById('timerSection');
    const timerTitle = document.getElementById('timerTitle');
    const timerSubtitle = document.getElementById('timerSubtitle');
    const timerStatus = document.getElementById('timerStatus');
    
    timerStartTime = new Date(timerData.startTime);
    timerType = timerData.type;
    
    // Update UI based on timer type
    if (timerData.isClean) {
        timerSection.className = 'timer-section clean-streak';
        timerTitle.className = 'timer-title clean';
        timerTitle.textContent = 'Clean Streak Timer';
        timerSubtitle.textContent = 'Time since your journey to personal freedom began';
        timerStatus.className = 'timer-status clean';
    } else {
        timerSection.className = 'timer-section relapse-streak';
        timerTitle.className = 'timer-title relapse';
        timerTitle.textContent = 'Recovery Timer';
        timerSubtitle.textContent = 'Time since last relapse - you can overcome this';
        timerStatus.className = 'timer-status relapse';
    }
    
    // Update the timer numbers immediately
    updateTimerNumbers();
}

function updateTimerNumbers() {
    if (!timerStartTime) return;
    
    const now = new Date();
    const diff = now - timerStartTime;
    
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
    
    // Update display with animation
    updateNumberWithAnimation('timerDays', days);
    updateNumberWithAnimation('timerHours', hours);
    updateNumberWithAnimation('timerMinutes', minutes);
    updateNumberWithAnimation('timerSeconds', seconds);
    
    // Update status text
    const timerStatus = document.getElementById('timerStatus');
    if (timerType === 'clean') {
        timerStatus.textContent = `${days} days, ${hours}h ${minutes}m ${seconds}s clean`;
    } else {
        timerStatus.textContent = `${days} days, ${hours}h ${minutes}m ${seconds}s in recovery`;
    }
}

function updateNumberWithAnimation(elementId, newValue) {
    const element = document.getElementById(elementId);
    const currentValue = parseInt(element.textContent) || 0;
    
    if (currentValue !== newValue) {
        element.style.transform = 'scale(1.1)';
        element.style.color = timerType === 'clean' ? '#10b981' : '#ef4444';
        
        setTimeout(() => {
            element.textContent = newValue.toString().padStart(2, '0');
            element.style.transform = 'scale(1)';
            element.style.color = 'var(--text-primary)';
        }, 150);
    } else {
        element.textContent = newValue.toString().padStart(2, '0');
    }
}

function startTimerUpdates() {
    // Clear any existing timer
    if (timerInterval) {
        clearInterval(timerInterval);
    }
    
    // Update every second
    timerInterval = setInterval(updateTimerNumbers, 1000);
}

function showNoEntriesTimer() {
    const timerSection = document.getElementById('timerSection');
    const timerTitle = document.getElementById('timerTitle');
    const timerSubtitle = document.getElementById('timerSubtitle');
    const timerStatus = document.getElementById('timerStatus');
    
    timerSection.className = 'timer-section';
    timerTitle.className = 'timer-title';
    timerTitle.textContent = 'Journey Timer';
    timerSubtitle.textContent = 'Start logging entries to track your progress';
    timerStatus.className = 'timer-status';
    timerStatus.textContent = 'No entries yet - Begin your journey!';
    
    // Show zeros
    document.getElementById('timerDays').textContent = '00';
    document.getElementById('timerHours').textContent = '00';
    document.getElementById('timerMinutes').textContent = '00';
    document.getElementById('timerSeconds').textContent = '00';
}

function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
}

// Update your existing functions to include timer updates
function updateStatsWithTimer() {
    updateStats(); // Your existing function
    initializeTimer(); // Add this line
}

// Update your existing updateStats function name references
// Replace updateStats() calls with updateStatsWithTimer() in these functions:
// - handleFormSubmit (after saveEntry)
// - confirmDelete (after deleting entry)
// - confirmDeleteSelected (after deleting entries)
// - importData (after importing)

        function updateApp() {
            // Show confirmation with backup reminder
            const hasEntries = getEntries().length > 0;
            let confirmMessage = 'This will update the app and may clear your cache. ';
            
            if (hasEntries) {
                confirmMessage += 'IMPORTANT: Make sure you have backed up your data from the Backup tab before proceeding. Continue with update?';
            } else {
                confirmMessage += 'Continue with update?';
            }
            
            if (confirm(confirmMessage)) {
                // Clear all caches
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => {
                            caches.delete(name);
                        });
                    });
                }
                
                // Update the stored version
                localStorage.setItem('disciplin_version', APP_VERSION);
                
                // Hide update notification
                hideUpdateNotification();
                
                // Force reload with cache bypass
                window.location.reload(true);
            }
        }

        function initializeNotifications() {
            // Check notification permission status
            if ('Notification' in window) {
                const permission = Notification.permission;
                const isEnabled = localStorage.getItem('disciplin_notifications') === 'true';
                
                if (permission === 'granted' && isEnabled) {
                    notificationPermission = true;
                    updateFloatingNotificationButton(true);
                } else {
                    updateFloatingNotificationButton(false);
                }
            }
        }

        function updateFloatingNotificationButton(enabled) {
            const btn = document.getElementById('notificationBtn');
            if (enabled) {
                btn.classList.add('enabled');
                btn.innerHTML = '<i class="fas fa-bell"></i> Enabled';
            } else {
                btn.classList.remove('enabled');
                btn.innerHTML = '<i class="far fa-bell-slash"></i> Enable Alerts';
                updateFloatingNotificationButton();
            }
        }

        function toggleNotifications() {
            if (notificationPermission) {
                // Disable notifications
                notificationPermission = false;
                localStorage.setItem('disciplin_notifications', 'false');
                updateFloatingNotificationButton(false);
                clearInactivityTimer();
                showNotification('Notifications disabled', 'success');
            } else {
                // Show notification modal
                document.getElementById('notificationModal').classList.add('show');
            }
        }

        function closeNotificationModal() {
            document.getElementById('notificationModal').classList.remove('show');
        }

        function enableNotifications() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        notificationPermission = true;
                        localStorage.setItem('disciplin_notifications', 'true');
                        updateFloatingNotificationButton(true);
                        setupInactivityTimer();
                        closeNotificationModal();
                        showNotification('Notifications enabled!', 'success');
                        
                        // Show a test notification
                        setTimeout(() => {
                            showPushNotification('Notifications are now active! 🎉');
                        }, 1000);
                    } else {
                        showNotification('Notification permission denied');
                        closeNotificationModal();
                    }
                });
            } else {
                showNotification('Notifications not supported in this browser');
                closeNotificationModal();
            }
        }

        function showPushNotification(message = null) {
            if (!notificationPermission || !('Notification' in window)) return;
            
            const randomMessage = message || notificationMessages[Math.floor(Math.random() * notificationMessages.length)];
            
            const notification = new Notification('Disciplin', {
                body: randomMessage,
                icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiM0RjQ2RTUiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiPgo8cGF0aCBkPSJtOSAxMiAyIDIgNC00Ii8+CjxwYXRoIGQ9Im0yMSAyMS0xLTFhNy43NCA3Ljc0IDAgMCAwIDAtMTBsMS0xYTEgMSAwIDAgMCAwLTEuNDFsLTUtNWExIDEgMCAwIDAtMS40MSAwbC0xIDFhNy43NCA3Ljc0IDAgMCAwLTEwIDBsLTEtMWExIDEgMCAwIDAtMS40MSAwbC01IDVhMSAxIDAgMCAwIDAgMS40MWwxIDFhNy43NCA3Ljc0IDAgMCAwIDAgMTBsLTEgMWExIDEgMCAwIDAgMCAxLjQxbDUgNWExIDEgMCAwIDAgMS40MSAwbDEtMWE3Ljc0IDcuNzQgMCAwIDAgMTAgMGwxIDFhMSAxIDAgMCAwIDEuNDEgMGw1LTVhMSAxIDAgMCAwIDAtMS40MVoiLz4KPC9zdmc+Cjwvc3ZnPg==',
                badge: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzIiIGhlaWdodD0iNzIiIHZpZXdCb3g9IjAgMCA3MiA3MiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjcyIiBoZWlnaHQ9IjcyIiByeD0iMTIiIGZpbGw9IiM0RjQ2RTUiLz4KPHN2ZyB4PSIxOCIgeT0iMTgiIHdpZHRoPSIzNiIgaGVpZ2h0PSIzNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiPgo8cGF0aCBkPSJtOSAxMiAyIDIgNC00Ii8+CjxwYXRoIGQ9Im0yMSAyMS0xLTFhNy43NCA3Ljc0IDAgMCAwIDAtMTBsMS0xYTEgMSAwIDAgMCAwLTEuNDFsLTUtNWExIDEgMCAwIDAtMS40MSAwbC0xIDFhNy43NCA3Ljc0IDAgMCAwLTEwIDBsLTEtMWExIDEgMCAwIDAtMS40MSAwbC01IDVhMSAxIDAgMCAwIDAgMS40MWwxIDFhNy43NCA3Ljc0IDAgMCAwIDAgMTBsLTEgMWExIDEgMCAwIDAgMCAxLjQxbDUgNWExIDEgMCAwIDAgMS40MSAwbDEtMWE3Ljc0IDcuNzQgMCAwIDAgMTAgMGwxIDFhMSAxIDAgMCAwIDEuNDEgMGw1LTVhMSAxIDAgMCAwIDAtMS40MVoiLz4KPC9zdmc+Cjwvc3ZnPg==',
                tag: 'disciplin-reminder',
                requireInteraction: false,
                silent: false
            });

            notification.onclick = function() {
                window.focus();
                notification.close();
            };

            // Auto close after 10 seconds
            setTimeout(() => {
                notification.close();
            }, 10000);
        }

        function setupInactivityTimer() {
            if (!notificationPermission) return;
            
            // Clear existing timer
            clearInactivityTimer();
            
            // Set timer for 6 hours (21600000 ms)
            inactivityTimer = setTimeout(() => {
                showPushNotification();
                // Set up recurring notifications every 2 hours after the first one
                setupRecurringNotifications();
            }, 21600000); // 6 hours
            
            // Update last activity timestamp
            localStorage.setItem('disciplin_last_activity', Date.now().toString());
        }

        function setupRecurringNotifications() {
            if (!notificationPermission) return;
            
            // Send notification every 2 hours after initial 6-hour period
            const recurringTimer = setInterval(() => {
                const lastActivity = parseInt(localStorage.getItem('disciplin_last_activity') || '0');
                const timeSinceActivity = Date.now() - lastActivity;
                
                // If user has been inactive for more than 6 hours, send notification
                if (timeSinceActivity > 21600000) { // 6 hours
                    showPushNotification();
                } else {
                    // User has been active, clear the recurring timer and reset
                    clearInterval(recurringTimer);
                    setupInactivityTimer();
                }
            }, 7200000); // 2 hours
        }

        function clearInactivityTimer() {
            if (inactivityTimer) {
                clearTimeout(inactivityTimer);
                inactivityTimer = null;
            }
        }

        function resetInactivityTimer() {
            if (notificationPermission) {
                setupInactivityTimer();
            }
        }

        // Track user activity
        function trackActivity() {
            localStorage.setItem('disciplin_last_activity', Date.now().toString());
            resetInactivityTimer();
        }

        // Add activity tracking to various user interactions
        document.addEventListener('click', trackActivity);
        document.addEventListener('scroll', trackActivity);
        document.addEventListener('keypress', trackActivity);
        document.addEventListener('touchstart', trackActivity);

        function initializeApp() {
            // Check if user has already logged today
            const today = new Date().toDateString();
            const todayEntry = getEntryForDate(today);
            
            if (todayEntry) {
                updateStreakNotification();
            }
            
            //initialize goals display
     
            updateGoalsDisplay();
            
            //Initialize Floqtinating Button
            updateFloatingNotificationButton();

            // Initialize submit button state
            updateSubmitButtonState();
            
            // Track app opening
            trackActivity();
        }

        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', function() {
        switchTabWithLoading(this.dataset.tab);
        trackActivity();
    });
});

            // Radio button change listener for masturbation question
            document.querySelectorAll('input[name="masturbated"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const timeQuestion = document.getElementById('timeQuestion');
                    if (this.value === 'yes') {
                        timeQuestion.classList.add('show');
                    } else {
                        timeQuestion.classList.remove('show');
                        // Clear all time checkboxes when hiding
                        document.querySelectorAll('input[name="timeOfDay"]').forEach(checkbox => {
                            checkbox.checked = false;
                            checkbox.closest('.checkbox-option').classList.remove('selected');
                        });
                    }
                });
            });

            // Checkbox styling for time of day
            document.querySelectorAll('input[name="timeOfDay"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const option = this.closest('.checkbox-option');
                    if (this.checked) {
                        option.classList.add('selected');
                    } else {
                        option.classList.remove('selected');
                    }
                });
            });

            // Emoji selection for log form
            document.querySelectorAll('.emoji-btn:not(.journal-mood-btn)').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.emoji-btn:not(.journal-mood-btn)').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    currentMood = this.dataset.mood;
                });
            });

            // Journal mood selection
            document.querySelectorAll('.journal-mood-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.journal-mood-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    currentJournalMood = this.dataset.mood;
                });
            });

            // Form submission - Fix event listener
            const logForm = document.getElementById('logForm');
            if (logForm) {
                logForm.addEventListener('submit', handleFormSubmit);
            }

            // Also add click event listener to the submit button as backup
            const submitBtn = logForm.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    handleFormSubmit(e);
                });
            }

            // Install prompt - Fix visibility
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                const installBtn = document.getElementById('installBtn');
                if (installBtn) {
                    installBtn.style.display = 'block';
                }
            });

            document.getElementById('installBtn').addEventListener('click', () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted the install prompt');
                            // 🔥 Google Analytics install event
                            gtag('event', 'pwa_install', {
                                event_category: 'engagement',
                                event_label: 'User Installed PWA'
                            });
                        } else {
                            console.log('User dismissed the install prompt');
                        }

                        deferredPrompt = null;
                        const installBtn = document.getElementById('installBtn');
                        if (installBtn) {
                            installBtn.style.display = 'none';
                        }
                    });
                }
            });

            // Show install button on supported browsers
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                const installBtn = document.getElementById('installBtn');
                if (installBtn && !window.matchMedia('(display-mode: standalone)').matches) {
                    // Show install button if not already installed
                    setTimeout(() => {
                        installBtn.style.display = 'block';
                    }, 3000);
                }
            }

            // Hide update notification when clicking outside
            document.addEventListener('click', function(e) {
                const updateNotification = document.getElementById('updateNotification');
                if (!updateNotification.contains(e.target) && updateNotification.classList.contains('show')) {
                    // Don't auto-hide, let user decide
                }
            });
        }
        



// Loading configuration
const LOADING_DURATION = 1500; // 1.5 seconds (adjustable)

// Show loading screen
function showLoading() {
    const loadingOverlay = document.getElementById('loadingOverlay');
    loadingOverlay.style.display = 'flex';
    loadingOverlay.classList.remove('hide');
}

// Hide loading screen
function hideLoading() {
    const loadingOverlay = document.getElementById('loadingOverlay');
    loadingOverlay.classList.add('hide');
    
    setTimeout(() => {
        loadingOverlay.style.display = 'none';
    }, 300); // Wait for fade out animation
}

// Modified switchTab function
function switchTabWithLoading(tabName) {
    // Show loading screen first
    showLoading();
    
    
    // Hide all tab content immediately
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // Update tab buttons
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    const mainTab = document.querySelector(`[data-tab="${tabName}"]`);
    if (mainTab) {
        mainTab.classList.add('active');
    }
    
    // Simulate loading time
    setTimeout(() => {
        // Hide loading screen
        hideLoading();
        
        // Show the requested tab content
        setTimeout(() => {
            document.getElementById(tabName).classList.add('active');
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Refresh data when switching to relevant tabs
            if (tabName === 'home') {
                updateStats();
                updateStreakNotification();
                updateAchievements();
                console.log('🔄 HOME TAB: Loading threads using existing function...');
    
    if (forumManager) {
        // Use the existing loadThreads but modify it for home
        loadThreadsForHome();
    }
            } else if (tabName === 'history') {
                loadHistory();
            } else if (tabName === 'insights') {
                updateWeeklyInsights();
            }
        }, 100); // Small delay to ensure loading screen is hidden
        
    }, LOADING_DURATION);
}

// Add these to your existing setupEventListeners function or create separate handlers
document.addEventListener('click', function(e) {
    // Close modals when clicking outside
    if (e.target.classList.contains('modal')) {
        if (e.target.id === 'createThreadModal') {
            closeCreateThreadModal();
        } else if (e.target.id === 'threadDetailModal') {
            closeThreadDetailModal();
        }
    }
});

// Handle escape key for modals
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const createModal = document.getElementById('createThreadModal');
        const detailModal = document.getElementById('threadDetailModal');
        
        if (createModal.classList.contains('show')) {
            closeCreateThreadModal();
        }
        if (detailModal.classList.contains('show')) {
            closeThreadDetailModal();
        }
    }
});

       // Thread search
document.getElementById('threadSearch').addEventListener('input', (e) => {
    const searchTerm = e.target.value.trim();
    this.currentPage = 1; // reset pagination
    this.loadThreads(searchTerm);
});
 

       function switchTab(tabName) {
             
    // Scroll to top of the page
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
  



    
    function isNewSession() {
    if (!sessionStorage.getItem('disciplin_session_started')) {
        sessionStorage.setItem('disciplin_session_started', 'true');
        return true; // NEW session
    }
    return false; // EXISTING session
}

function initializeApp() {
    if (isNewSession()) {
        localStorage.removeItem('disciplin_active_tab');
        switchTab('home');
        console.log('New session - switched to home');
    } else {
        const savedTab = localStorage.getItem('disciplin_active_tab') || 'home';
        switchTab(savedTab);
        console.log('Continuing session - loaded:', savedTab);
    }
}

document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        const lastActivity = sessionStorage.getItem('disciplin_last_activity');
        const now = Date.now();
        
        if (lastActivity) {
            const timeDiff = now - parseInt(lastActivity);
            // If away for 5+ minutes, treat as new session
            if (timeDiff > 5 * 60 * 1000) {
                sessionStorage.removeItem('disciplin_session_started');
                initializeApp();
            }
        }
        sessionStorage.setItem('disciplin_last_activity', now.toString());
    }
});

    
    // Update page title
    updatePageTitle(tabName);

    // Update tab buttons (only for main tabs)
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Only highlight main tab if it exists
    const mainTab = document.querySelector(`[data-tab="${tabName}"]`);
    if (mainTab) {
        mainTab.classList.add('active');
    }

    // Update tab content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(tabName).classList.add('active');
    
    // Save the current active tab to localStorage
    // BUT only if this is not a forced home tab switch for new sessions
    if (!isNewSession() || tabName !== 'home') {
        localStorage.setItem('disciplin_active_tab', tabName);
    }

    // Update submit button state when switching to log tab
    if (tabName === 'log') {
        updateSubmitButtonState();
    }

    // Refresh data when switching to relevant tabs
    if (tabName === 'home') {
        console.log('🔄 HOME TAB: Loading threads using existing function...');
    
    if (forumManager) {
        // Use the existing loadThreads but modify it for home
        loadThreadsForHome();
    }
        updateStatsWithTimer();
        updateStreakNotification();
        updateAchievements();
        updateLevelSystem();
        updateGoalsDisplay();
        updateFloatingNotificationButton();
        updateSOSButtonVisibility(tabName);

    

    



    } else if (tabName === 'history') {
        loadHistory();
    } else if (tabName === 'insights') {
        updateWeeklyInsights();
        updatePersonalizedInsights();
    } else if (tabName === 'journal') {
        loadJournalEntries();
    }
        

        
     else if (tabName === 'forum') {
        // Load forum threads when switching to forum tab
        if (forumManager) {
            forumManager.loadThreads();
        }
    }
    
    
    // Update URL hash (optional - for shareable URLs)
    if (tabName !== 'home') {
        window.history.replaceState(null, null, '#' + tabName);
    } else {
        window.history.replaceState(null, null, window.location.pathname);
    }
        
    // Add this to your switchTab function
    if (tabName === 'chat') {
        // Initialize chat if not already done
        if (!disciplinChat) {
            disciplinChat = new DisciplinChat();
        }
    }
    
    // Update last activity timestamp
    sessionStorage.setItem('disciplin_last_activity', Date.now().toString());
}


// Floating Notification Bell Functions - ADD THIS JAVASCRIPT
function updateFloatingNotificationButton() {
    const floatingBtn = document.getElementById('floatingNotificationBtn');
    const currentTab = document.querySelector('.tab.active').dataset.tab;
    
    if (currentTab === 'home') {
        floatingBtn.classList.add('show');
    } else {
        floatingBtn.classList.remove('show');
    }
    
    // Update appearance based on notification status
    const isEnabled = localStorage.getItem('disciplin_notifications') === 'true';
    const permission = 'Notification' in window ? Notification.permission : 'default';
    
    if (isEnabled && permission === 'granted') {
        floatingBtn.classList.add('enabled');
        floatingBtn.innerHTML = '<i class="fas fa-bell"></i>';
        floatingBtn.title = 'Notifications Enabled - Click to Disable';
    } else {
        floatingBtn.classList.remove('enabled');
        floatingBtn.innerHTML = '<i class="far fa-bell-slash"></i>';
        floatingBtn.title = 'Click to Enable Notifications';
    }
}

       async function handleFormSubmit(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Form submission triggered'); // Debug log

            // Check if user is online first
    if (!navigator.onLine) {
        showNotification('You must be online to log entries. Please check your internet connection.');
        alert('No Internet Connection, You need to be online to log entries as they are counted in our global statistics. Please check your internet connection and try again.');
        return; // Stop execution if offline
    }
            
            const today = new Date().toDateString();
            const existingEntry = getEntryForDate(today);
            
            if (existingEntry) {
                showNotification('You can only log one entry per day!');
                alert('You can only log one entry per day!');
                return;
            }

            // Get form data directly from elements
            const masturbatedYes = document.getElementById('yes').checked;
            const masturbatedNo = document.getElementById('no').checked;
            const notes = document.getElementById('notes').value;

            const energyLevel = document.querySelector('input[name="energyLevel"]:checked');
            if (!energyLevel) {
                showNotification('Please select your energy level');
                alert('Please select your energy level');
                return;
            }
            const sleepTime = document.querySelector('input[name="sleepTime"]:checked');
            if (!sleepTime) {
                showNotification('Please select your sleep time');
                alert('Please select your sleep time');
                return;
            }

            if (!masturbatedYes && !masturbatedNo) {
                showNotification('Please answer if you masturbated yesterday');
                alert('Please answer if you masturbated yesterday');
                return;
            }

            const masturbated = masturbatedYes;

            // Get selected times of day
            const timeOfDay = [];
            document.querySelectorAll('input[name="timeOfDay"]:checked').forEach(checkbox => {
                timeOfDay.push(checkbox.value);
            });

            const entry = {
                id: Date.now(),
                date: today,
                masturbated: masturbated,
                timeOfDay: timeOfDay,
                mood: currentMood,
                notes: notes,
                energy: energyLevel.value,
                sleepTime: sleepTime.value,
                timestamp: new Date().toISOString()
            };

            console.log('Entry to save:', entry); // Debug log

            try {
                await saveEntryEnhanced(entry);
               
                updateStatsWithTimer();
                updateStreakNotification();
                updateAchievements();
                updateWeeklyInsights();
                updateLevelSystem();
                updatePersonalizedInsights();
                resetForm();
                trackActivity(); // Track this as user activity
                
                // Track form submission with analytics
                trackFormSubmission(entry);
                
                // Show success notification and alert
                showNotification('Entry logged successfully!', 'success');
                alert('✅ Entry saved successfully!');
                
                // Switch to home tab after a brief delay
                setTimeout(() => {
                    switchTab('home');
                }, 500);
            } catch (error) {
                console.error('Error saving entry:', error); // Debug log
                showNotification('Error saving entry. Please try again.');
                alert('❌ Error saving entry. Please try again.');
            }
        }

        function saveEntry(entry) {
            const entries = getEntries();
            entries.push(entry);
            localStorage.setItem('disciplin_entries', JSON.stringify(entries));
        }

        function getEntries() {
            const entries = localStorage.getItem('disciplin_entries');
            return entries ? JSON.parse(entries) : [];
        }

        function getEntryForDate(dateString) {
            const entries = getEntries();
            return entries.find(entry => entry.date === dateString);
        }

        function updateStats() {
            const entries = getEntries().sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            let currentStreak = 0;
            let longestStreak = 0;
            let tempStreak = 0;

            // Calculate streaks
            for (let i = 0; i < entries.length; i++) {
                if (!entries[i].masturbated) {
                    tempStreak++;
                    longestStreak = Math.max(longestStreak, tempStreak);
                } else {
                    tempStreak = 0;
                }
            }

            // Calculate current streak (from most recent entries)
            for (let i = entries.length - 1; i >= 0; i--) {
                if (!entries[i].masturbated) {
                    currentStreak++;
                } else {
                    break;
                }
            }

            document.getElementById('currentStreak').textContent = currentStreak;
            document.getElementById('longestStreak').textContent = longestStreak;
        }

        function updateAchievements() {
            const entries = getEntries().sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            let longestStreak = 0;
            let tempStreak = 0;

            // Calculate longest streak
            for (let i = 0; i < entries.length; i++) {
                if (!entries[i].masturbated) {
                    tempStreak++;
                    longestStreak = Math.max(longestStreak, tempStreak);
                } else {
                    tempStreak = 0;
                }
            }

            const achievementsGrid = document.getElementById('achievementsGrid');
            achievementsGrid.innerHTML = achievements.map(achievement => {
                const earned = achievement.condition(longestStreak);
                return `
                    <div class="achievement-badge ${earned ? 'earned' : ''}">
                        <div class="achievement-emoji">${achievement.icon}</div>
                        <div class="achievement-text">${achievement.text}</div>
                    </div>
                `;
            }).join('');
        }

        // Updated function to show both weekly and monthly insights
        function updateWeeklyInsights() {
            const entries = getEntries();
            if (entries.length === 0) {
                document.getElementById('weeklyInsights').innerHTML = `
                    <div class="empty-state">
                        <h3>No data yet</h3>
                        <p>Start logging entries to see your insights.</p>
                    </div>
                `;
                return;
            }

            // Get entries from the last 7 days (weekly)
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            const weeklyEntries = entries.filter(entry => 
                new Date(entry.timestamp) > oneWeekAgo
            );

            // Get entries from the last 30 days (monthly)
            const oneMonthAgo = new Date();
            oneMonthAgo.setDate(oneMonthAgo.getDate() - 30);
            
            const monthlyEntries = entries.filter(entry => 
                new Date(entry.timestamp) > oneMonthAgo
            );

            // Calculate weekly stats
            const weeklyStats = calculateInsightStats(weeklyEntries);
            
            // Calculate monthly stats
            const monthlyStats = calculateInsightStats(monthlyEntries);

            document.getElementById('weeklyInsights').innerHTML = `
                <!-- Weekly Insights Section -->
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #4F46E5; font-weight: 600; margin-bottom: 15px; text-align: center;">Weekly Stats (7 Days)</h3>
                    <div style="background: var(--card-bg); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                        ${generateInsightHTML(weeklyStats, 7)}
                    </div>
                </div>

                <!-- Monthly Insights Section -->
                <div>
                    <h3 style="color: #4F46E5; font-weight: 600; margin-bottom: 15px; text-align: center;"> Monthly Stats (30 Days)</h3>
                    <div style="background: var(--card-bg); border-radius: 10px; padding: 15px;">
                        ${generateInsightHTML(monthlyStats, 30)}
                    </div>
                </div>
            `;
        }

        // Helper function to calculate stats for any given period
        function calculateInsightStats(entries) {
            const totalEntries = entries.length;
            const cleanDays = entries.filter(entry => !entry.masturbated).length;
            const relapseDays = entries.filter(entry => entry.masturbated).length;
            const successRate = totalEntries > 0 ? Math.round((cleanDays / totalEntries) * 100) : 0;

            // Most common time of day for relapses
            const timeData = {};
            entries.forEach(entry => {
                if (entry.masturbated && entry.timeOfDay) {
                    entry.timeOfDay.forEach(time => {
                        timeData[time] = (timeData[time] || 0) + 1;
                    });
                }
            });

            const mostCommonTime = Object.keys(timeData).length > 0 
                ? Object.keys(timeData).reduce((a, b) => timeData[a] > timeData[b] ? a : b)
                : 'None';

            // Most common energy level
            const energyData = {};
            entries.forEach(entry => {
                if (entry.energy) {
                    energyData[entry.energy] = (energyData[entry.energy] || 0) + 1;
                }
            });
            const mostCommonEnergy = Object.keys(energyData).length > 0 
                ? Object.keys(energyData).reduce((a, b) => energyData[a] > energyData[b] ? a : b)
                : 'Not tracked';
            
            // Most common sleep time
            const sleepData = {};
            entries.forEach(entry => {
                if (entry.sleepTime) {
                    sleepData[entry.sleepTime] = (sleepData[entry.sleepTime] || 0) + 1;
                }
            });
            const mostCommonSleepTime = Object.keys(sleepData).length > 0 
                ? Object.keys(sleepData).reduce((a, b) => sleepData[a] > sleepData[b] ? a : b)
                : 'Not tracked';
            
            // Most common mood
            const moodData = {};
            entries.forEach(entry => {
                if (entry.mood) {
                    moodData[entry.mood] = (moodData[entry.mood] || 0) + 1;
                }
            });

            const mostCommonMood = Object.keys(moodData).length > 0 
                ? Object.keys(moodData).reduce((a, b) => moodData[a] > moodData[b] ? a : b)
                : 'Not tracked';

            return {
                totalEntries,
                cleanDays,
                relapseDays,
                successRate,
                mostCommonTime,
                mostCommonEnergy,
                mostCommonSleepTime,
                mostCommonMood
            };
        }

        // Helper function to generate HTML for insights
        function generateInsightHTML(stats, days) {
            return `
                <div class="insight-item">
                    <div class="insight-label">Total Entries (${days} days)</div>
                    <div class="insight-value">${stats.totalEntries}</div>
                </div>
                <div class="insight-item">
                    <div class="insight-label">Clean Days</div>
                    <div class="insight-value">${stats.cleanDays}</div>
                </div>
                <div class="insight-item">
                    <div class="insight-label">Relapse Days</div>       
                    <div class="insight-value">${stats.relapseDays}</div>
                </div>
                <div class="insight-item">
                    <div class="insight-label">Success Rate</div>
                    <div class="insight-value">${stats.successRate}%</div>
                </div>
                <div class="insight-item">
                    <div class="insight-label">Most Common Relapse Time</div>
                    <div class="insight-value">${stats.mostCommonTime}</div>
                </div>
                <div class="insight-item">
                    <div class="insight-label">Most Common Sleep Time</div>
                    <div class="insight-value">${stats.mostCommonSleepTime}</div>
                </div>
                <div class="insight-item">
                    <div class="insight-label">Most Common Energy Level</div>
                    <div class="insight-value">${stats.mostCommonEnergy}</div>
                </div>
                <div class="insight-item">
                    <div class="insight-label">Most Common Mood</div>
                    <div class="insight-value">${stats.mostCommonMood}</div>
                </div>
            `;
        }

        function exportData() {
            const entries = getEntries();
            const journalEntries = getJournalEntries();
            const data = {
                entries: entries,
                journalEntries: journalEntries,
                exportDate: new Date().toISOString(),
                version: APP_VERSION
            };

            try {
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `disciplin_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                // Track data export
                trackDataExport();
                
                showNotification('Data exported successfully!', 'success');
                alert('✅ Data exported successfully!');
            } catch (error) {
                showNotification('Error exporting data');
                alert('❌ Error exporting data');
            }
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validate the data structure
                    if (!data.entries || !Array.isArray(data.entries)) {
                        throw new Error('Invalid backup file format');
                    }

                    // Ask for confirmation before importing
                    if (confirm('This will replace all your current data. Are you sure you want to import?')) {
                        localStorage.setItem('disciplin_entries', JSON.stringify(data.entries));
                        
                        // Import journal entries if they exist
                        if (data.journalEntries && Array.isArray(data.journalEntries)) {
                            localStorage.setItem('disciplin_journal', JSON.stringify(data.journalEntries));
                        }
                        
                        // Refresh all views
                        updateStatsWithTimer();
                        updateAchievements();
                        updateWeeklyInsights();
                        updatePersonalizedInsights();
                        updateLevelSystem();
                        loadHistory();
                        loadJournalEntries();
                        updateStreakNotification();
                        updateGoalsDisplay()
                        trackActivity(); // Track this as user activity
                        
                        // Track data import
                        trackDataImport();
                        
                        showNotification('Data imported successfully!', 'success');
                        alert('Data imported successfully!');
                    }
                } catch (error) {
                    showNotification('Error importing data: Invalid file format');
                    alert('Error importing data: Invalid file format');
                }
            };
            
            reader.readAsText(file);
            // Reset the file input
            event.target.value = '';
        }

        function updateStreakNotification() {
            const entries = getEntries().sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            let currentStreak = 0;

            // Calculate current streak
            for (let i = entries.length - 1; i >= 0; i--) {
                if (!entries[i].masturbated) {
                    currentStreak++;
                } else {
                    break;
                }
            }

            const notification = document.getElementById('streakNotification');
            if (currentStreak > 0) {
                notification.style.display = 'block';
                notification.textContent = ` You've gone ${currentStreak} day${currentStreak !== 1 ? 's' : ''} without relapsing`;
            } else {
                notification.style.display = 'none';
            }
        }

        function showDeleteModal(entryId) {
            deleteEntryId = entryId;
            document.getElementById('deleteModal').classList.add('show');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
            deleteEntryId = null;
        }

        function confirmDelete() {
            if (deleteEntryId) {
                const entries = getEntries().filter(entry => entry.id !== deleteEntryId);
                localStorage.setItem('disciplin_entries', JSON.stringify(entries));
                loadHistory();
                updateStatsWithTimer();
                updateAchievements();
                updateWeeklyInsights();
                updatePersonalizedInsights();
                updateLevelSystem();
                updateStreakNotification();
                closeDeleteModal();
                trackActivity(); // Track this as user activity
                showNotification('Entry deleted successfully!', 'success');
                alert('✅ Entry deleted successfully!');
            }
        }

        function showWelcomeModal() {
            const hasVisited = localStorage.getItem('disciplin_visited');
            if (!hasVisited) {
                document.getElementById('welcomeModal').classList.add('show');
            }
        }

        function closeWelcomeModal() {
            document.getElementById('welcomeModal').classList.remove('show');
            localStorage.setItem('disciplin_visited', 'true');
            trackActivity();
        }

        function resetForm() {
            document.getElementById('logForm').reset();
            document.querySelectorAll('.emoji-btn:not(.journal-mood-btn)').forEach(btn => btn.classList.remove('selected'));
            document.querySelectorAll('.checkbox-option').forEach(option => option.classList.remove('selected'));
            document.getElementById('timeQuestion').classList.remove('show');
            currentMood = '';
        }

        function showNotification(message, type = 'error') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.background = type === 'success' ? '#10b981' : '#ef4444';
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function rotateMotiationTexts() {
            let currentIndex = 0;
            
            function updateText() {
                document.getElementById('motivationalText').textContent = motivationalTexts[currentIndex];
                document.getElementById('logMotivationalText').textContent = motivationalTexts[currentIndex];
                document.getElementById('insightsMotivationalText').textContent = motivationalTexts[currentIndex];
                document.getElementById('howtoMotivationalText').textContent = motivationalTexts[currentIndex];
                
                // Add this line for resources tab
                const resourcesText = document.getElementById('resourcesMotivationalText');
                if (resourcesText) {
                    resourcesText.textContent = motivationalTexts[currentIndex];
                }
                
                currentIndex = (currentIndex + 1) % motivationalTexts.length;
            }
            
            updateText();
            setInterval(updateText, 5000);
        }

        // Check if user returns to app and reset activity timer
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                trackActivity();
            }
        });

        // Check for missed check-ins on app start
        window.addEventListener('load', function() {
            const lastActivity = parseInt(localStorage.getItem('disciplin_last_activity') || '0');
            const timeSinceActivity = Date.now() - lastActivity;
            
            // If it's been more than 24 hours since last activity, show a gentle reminder
            if (timeSinceActivity > 86400000 && notificationPermission) { // 24 hours
                setTimeout(() => {
                    showNotification('Welcome back! Don\'t forget to log your daily progress.', 'success');
                }, 2000);
            }
        });

        // Back button handler with custom confirmation modal
        let popstateHandler;

        // Define the popstate handler function
        popstateHandler = function(e) {
            // Push current state back to prevent immediate navigation
            history.pushState(null, null, window.location.pathname);
            
            // Show custom modal
            showExitConfirmationModal();
        };

        // Add the event listener
        window.addEventListener('popstate', popstateHandler);

        // Initialize history state on page load
        window.addEventListener('load', function() {
            // Push initial state to enable popstate handling
            history.pushState(null, null, window.location.pathname);
        });



        // Custom exit confirmation modal functions
        function showExitConfirmationModal() {
            // Create modal HTML that matches your app's styling
            const modalHTML = `
                <div id="exitModal" class="modal show" style="z-index: 9999;">
                    <div class="modal-content">
                        <h2>Leave Disciplin?</h2>
                        <p>Are you sure you want to leave the app? Your progress is saved locally and will be here when you return.</p>
                        <div class="modal-buttons">
                            <button class="modal-btn secondary" onclick="cancelExit()">Stay in App</button>
                            <button class="modal-btn primary" onclick="confirmExit()">Leave App</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Track this interaction
            trackActivity();
        }

        function cancelExit() {
            const exitModal = document.getElementById('exitModal');
            if (exitModal) {
                exitModal.remove();
            }
            // Track that user chose to stay
            trackActivity();
        }

        function confirmExit() {
    const exitModal = document.getElementById('exitModal');
    if (exitModal) {
        exitModal.remove();
    }
    
    // IMPORTANT: Remove the popstate listener to allow navigation
    window.removeEventListener('popstate', popstateHandler);
    
    // Try different methods to close the app in order of preference
    
    // Method 1: For PWA (installed app) - try to close immediately
    if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
        // For PWA, try window.close() first
        if (window.close) {
            window.close();
            return;
        }
        
        // Android PWA - minimize to home screen
        if (navigator.userAgent.toLowerCase().indexOf('android') > -1) {
            try {
                window.location.href = 'intent:///#Intent;action=android.intent.action.MAIN;category=android.intent.category.HOME;end';
                return;
            } catch (e) {
                // Fall through to next method
            }
        }
        
        // iOS PWA - try to minimize
        if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
            try {
                window.close();
                return;
            } catch (e) {
                // Fall through to next method
            }
        }
    }
    
    // Method 2: For regular browser - try to close tab
    try {
        window.close();
        return;
    } catch (e) {
        // Most browsers prevent window.close() for security reasons
    }
    
    // Method 3: Try to navigate back in browser history
    try {
        if (window.history.length > 1) {
            window.history.back();
            return;
        }
    } catch (e) {
        // Fall through to next method
    }
    
    // Method 4: Try to navigate to a blank page
    try {
        window.location.href = 'about:blank';
        return;
    } catch (e) {
        // Fall through to final method
    }
    
    // Method 5: Final fallback - redirect to a goodbye message
    // This will only execute if all other methods fail
    window.location.href = 'data:text/html,<html><body style="font-family:Arial;text-align:center;margin-top:50px;"><h1>Thank you for using Disciplin!</h1><p>You can now close this tab manually.</p><button onclick="window.close()">Try to Close Tab</button></body></html>';
}

// SOS Button functionality
function activateSOS() {
    // Switch to resources tab
    switchTab('resources');
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // Show notification
    showNotification('Redirected to Anti-Relapse Resources', 'success');
    
    // Optional: Add a visual indication
    const resourcesTab = document.getElementById('resources');
    if (resourcesTab) {
        resourcesTab.style.animation = 'fadeIn 0.5s ease';
    }
    
    // Track this as important user activity
    trackActivity();
    
    // Optional: Show encouraging message
    setTimeout(() => {
        showNotification('You\'re stronger than your urges! 💪', 'success');
    }, 1500);
}

// Function to show/hide SOS button based on current tab
function updateSOSButtonVisibility(currentTab) {
    const sosButton = document.getElementById('sosButton');
    if (sosButton) {
        if (currentTab === 'resources') {
            sosButton.style.display = 'none';
        } else {
            sosButton.style.display = 'flex';
        }
    }
}

// Update the existing switchTab function to control SOS button visibility
// Find the switchTab function and add this line at the end of it:
// updateSOSButtonVisibility(tabName);




        // Connection status functions
        function updateConnectionStatusAnimated() {
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');

            if (navigator.onLine) {
                statusIcon.style.background = 'limegreen';
                statusText.textContent = 'Online';
            } else {
                statusIcon.style.background = 'red';
                statusText.textContent = 'Offline';
            }

            const statusContainer = document.getElementById('connectionStatus');
            statusContainer.classList.remove('status-container');
            void statusContainer.offsetWidth;
            statusContainer.classList.add('status-container');
        }

        window.addEventListener('online', updateConnectionStatusAnimated);
        window.addEventListener('offline', updateConnectionStatusAnimated);
        document.addEventListener('DOMContentLoaded', updateConnectionStatusAnimated);

        // Connection status functions
function updateConnectionStatusAnimated() {
    const statusIcon = document.getElementById('statusIcon');
    const statusText = document.getElementById('statusText');

    if (navigator.onLine) {
        statusIcon.style.background = 'limegreen';
        statusText.textContent = 'You are online(All features of Disciplin enabled)';
    } else {
        statusIcon.style.background = 'red';
        statusText.textContent = 'You are offline(You cant log new entries, use forum and chat tab when offline!) ';
    }

    const statusContainer = document.getElementById('connectionStatus');
    statusContainer.classList.remove('status-container');
    void statusContainer.offsetWidth;
    statusContainer.classList.add('status-container');
}

window.addEventListener('online', updateConnectionStatusAnimated);
window.addEventListener('offline', updateConnectionStatusAnimated);
document.addEventListener('DOMContentLoaded', updateConnectionStatusAnimated);

// ADD THE NEW FUNCTION HERE:
function updateSubmitButtonState() {
    const submitBtn = document.getElementById('logSubmitBtn');
    if (!submitBtn) return;
    
    if (navigator.onLine) {
        submitBtn.classList.remove('offline');
        submitBtn.textContent = 'Log Entry';
        submitBtn.disabled = false;
    } else {
        submitBtn.classList.add('offline');
        submitBtn.textContent = 'Offline - Cannot Log Entry';
        submitBtn.disabled = true;
    }
}

// Update the existing event listeners to also call the new function
window.addEventListener('online', function() {
    updateConnectionStatusAnimated();
    updateSubmitButtonState();
});

window.addEventListener('offline', function() {
    updateConnectionStatusAnimated();
    updateSubmitButtonState();
});
    </script>

    <!-- Service Worker Script (inline) -->
    <script>
        // Service Worker code as a string to be registered
        const serviceWorkerCode = `
            const CACHE_NAME = 'disciplin-v${APP_VERSION}';
            const urlsToCache = [
                './',
                './index.html'
            ];

            self.addEventListener('install', function(event) {
                event.waitUntil(
                    caches.open(CACHE_NAME)
                        .then(function(cache) {
                            return cache.addAll(urlsToCache);
                        })
                );
                // Force the waiting service worker to become active
                self.skipWaiting();
            });

            self.addEventListener('activate', function(event) {
                event.waitUntil(
                    caches.keys().then(function(cacheNames) {
                        return Promise.all(
                            cacheNames.map(function(cacheName) {
                                if (cacheName !== CACHE_NAME) {
                                    return caches.delete(cacheName);
                                }
                            })
                        );
                    })
                );
                // Claim control of all clients
                return self.clients.claim();
            });

            self.addEventListener('fetch', function(event) {
                event.respondWith(
                    caches.match(event.request)
                        .then(function(response) {
                            // Return cached version or fetch from network
                            return response || fetch(event.request);
                        }
                    )
                );
            });

            // Background sync for notifications (if supported)
            self.addEventListener('sync', function(event) {
                if (event.tag === 'disciplin-reminder') {
                    event.waitUntil(sendReminderNotification());
                }
            });

            function sendReminderNotification() {
                const notificationOptions = {
                    body: 'Time to check in with your progress! 💪',
                    icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiM0RjQ2RTUiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiPgo8cGF0aCBkPSJtOSAxMiAyIDIgNC00Ii8+CjxwYXRoIGQ9Im0yMSAyMS0xLTFhNy43NCA3Ljc0IDAgMCAwIDAtMTBsMS0xYTEgMSAwIDAgMCAwLTEuNDFsLTUtNWExIDEgMCAwIDAtMS40MSAwbC0xIDFhNy43NCA3Ljc0IDAgMCAwLTEwIDBsLTEtMWExIDEgMCAwIDAtMS40MSAwbC01IDVhMSAxIDAgMCAwIDAgMS40MWwxIDFhNy43NCA3Ljc0IDAgMCAwIDAgMTBsLTEgMWExIDEgMCAwIDAgMCAxLjQxbDUgNWExIDEgMCAwIDAgMS40MSAwbDEtMWE3Ljc0IDcuNzQgMCAwIDAgMTAgMGwxIDFhMSAxIDAgMCAwIDEuNDEgMGw1LTVhMSAxIDAgMCAwIDAtMS40MVoiLz4KPC9zdmc+Cjwvc3ZnPg==',
                    badge: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzIiIGhlaWdodD0iNzIiIHZpZXdCb3g9IjAgMCA3MiA3MiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjcyIiBoZWlnaHQ9IjcyIiByeD0iMTIiIGZpbGw9IiM0RjQ2RTUiLz4KPHN2ZyB4PSIxOCIgeT0iMTgiIHdpZHRoPSIzNiIgaGVpZ2h0PSIzNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiPgo8cGF0aCBkPSJtOSAxMiAyIDIgNC00Ii8+CjxwYXRoIGQ9Im0yMSAyMS0xLTFhNy43NCA3Ljc0IDAgMCAwIDAtMTBsMS0xYTEgMSAwIDAgMCAwLTEuNDFsLTUtNWExIDEgMCAwIDAtMS40MSAwbC0xIDFhNy43NCA3Ljc0IDAgMCAwLTEwIDBsLTEtMWExIDEgMCAwIDAtMS40MSAwbC01IDVhMSAxIDAgMCAwIDAgMS40MWwxIDFhNy43NCA3Ljc0IDAgMCAwIDAgMTBsLTEgMWExIDEgMCAwIDAgMCAxLjQxbDUgNWExIDEgMCAwIDAgMS40MSAwbDEtMWE3Ljc0IDcuNzQgMCAwIDAgMTAgMGwxIDFhMSAxIDAgMCAwIDEuNDEgMGw1LTVhMSAxIDAgMCAwIDAtMS40MVoiLz4KPC9zdmc+Cjwvc3ZnPg==',
                    tag: 'disciplin-reminder',
                    requireInteraction: false
                };

                return self.registration.showNotification('Disciplin', notificationOptions);
            }
        `;

        // Create and register the service worker
        if ('serviceWorker' in navigator) {
            const blob = new Blob([serviceWorkerCode.replace('${APP_VERSION}', APP_VERSION)], {
                type: 'application/javascript'
            });
            const serviceWorkerUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(serviceWorkerUrl)
    .then(registration => {
        console.log('Service Worker registered successfully');
        
        registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    // Show mandatory update modal instead of notification
                    showMandatoryUpdateModal(registration);
                }
            });
        });
    })
                .catch(error => {
                    console.log('Service Worker registration failed:', error);
                });
        }
    </script>

    <!-- Manifest JSON (inline for single file) -->
    <script>
        // Create and inject manifest
        const manifest = {
            "id": "https://ifexxy.github.io/disciplin/",
            "dir": "ltr",
            "lang": "en-US",
            "name": "Disciplin",
            "scope": "https://ifexxy.github.io/disciplin/",
            "display": "standalone",
            "start_url": "https://ifexxy.github.io/disciplin/",
            "short_name": "Disciplin",
            "theme_color": "#000000",
            "description": "Personal habit tracking app with enhanced features",
            "orientation": "portrait",
            "background_color": "#000000",
            "prefer_related_applications": false,
            "display_override": [
                "window-controls-overlay"
            ],
            "screenshots": [
                {
                    "src": "https://ifexxy.github.io/disciplin/assets/screen.png"
                },
                {
                    "src": "https://ifexxy.github.io/disciplin/assets/screen.png"
                },
                {
                    "src": "https://ifexxy.github.io/disciplin/assets/screen.png"
                }
            ],
            "features": [
                "Level System",
                "Streak Flames",
                "Personal Journal",
                "AI Insights",
                "Habit Tracking",
                "Push Notifications",
                "Progress Analytics",
                "Goal Setting"
            ],
            "icons": [
                {
                    "src": "https://ifexxy.github.io/disciplin/icons/icon-192.png",
                    "sizes": "192x192",
                    "type": "image/png",
                    "purpose": "any"
                },
                {
                    "src": "https://ifexxy.github.io/disciplin/icons/icon-192-maskable.png",
                    "sizes": "192x192",
                    "type": "image/png",
                    "purpose": "maskable"
                },
                {
                    "src": "https://ifexxy.github.io/disciplin/icons/icon-512.png",
                    "sizes": "512x512",
                    "type": "image/png",
                    "purpose": "any"
                },
                {
                    "src": "https://ifexxy.github.io/disciplin/icons/icon-512-maskable.png",
                    "sizes": "512x512",
                    "type": "image/png",
                    "purpose": "maskable"
                }
            ],
            "categories": [
                "productivity",
                "health",
                "lifestyle"
            ],
            "launch_handler": {
                "client_mode": "navigate-existing"
            },
            "shortcuts": [
                {
                    "name": "Log Entry",
                    "short_name": "Log",
                    "description": "Quickly log your daily progress",
                    "url": "https://ifexxy.github.io/disciplin/#log",
                    "icons": [
                        {
                            "src": "https://ifexxy.github.io/disciplin/icons/icon-192.png",
                            "sizes": "192x192"
                        }
                    ]
                },
                {
                    "name": "Write Journal",
                    "short_name": "Journal",
                    "description": "Write in your personal journal",
                    "url": "https://ifexxy.github.io/disciplin/#journal",
                    "icons": [
                        {
                            "src": "https://ifexxy.github.io/disciplin/icons/icon-192.png",
                            "sizes": "192x192"
                        }
                    ]
                },
                {
                    "name": "View Progress",
                    "short_name": "Progress",
                    "description": "Check your progress and level",
                    "url": "https://ifexxy.github.io/disciplin/#insights",
                    "icons": [
                        {
                            "src": "https://ifexxy.github.io/disciplin/icons/icon-192.png",
                            "sizes": "192x192"
                        }
                    ]
                }
            ]
        }
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.querySelector('link[rel="manifest"]').href = manifestURL;
    </script>
    
    <script>
        if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').then(reg => {
        reg.onupdatefound = () => {
            const installingWorker = reg.installing;
            installingWorker.onstatechange = () => {
                if (installingWorker.state === 'installed') {
                    if (navigator.serviceWorker.controller) {
                        // Show custom update modal instead of browser confirm
                        showMandatoryUpdateModal(reg);
                    }
                }
            };
        };
    }).catch(err => {
        console.log('External Service Worker registration failed, inline version will be used:', err);
    });
}
    </script>
    <script>


class FirebaseManager {
    constructor() {
        this.isInitialized = false;
        this.currentUser = null;
        this.syncEnabled = false;
        this.db = null;
        this.auth = null;
        this.unsubscribeAuth = null;
        this.unsubscribeEntries = null;
        this.isSyncing = false;
        
        this.init();
    }

    async init() {
        try {
            // Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyDdZV7b_23WAuu6kiKfpLxdL-v9zpgWjBM",
                authDomain: "disciplin-chat.firebaseapp.com",
                projectId: "disciplin-chat",
                storageBucket: "disciplin-chat.firebasestorage.app",
                messagingSenderId: "595537471459",
                appId: "1:595537471459:web:4c6c35e907c947a8d222d6"
            };

            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            this.auth = firebase.auth();
            this.db = firebase.firestore();
            
            // Set up auth state listener
            this.unsubscribeAuth = this.auth.onAuthStateChanged((user) => {
                this.handleAuthStateChange(user);
            });

            this.isInitialized = true;
            console.log('🔥 Firebase initialized successfully');
            
            // Update UI to show Firebase features
            this.updateFirebaseUI();
            
        } catch (error) {
            console.error('Failed to initialize Firebase:', error);
            this.showError('Failed to connect to cloud sync service');
        }
    }

    handleAuthStateChange(user) {
        this.currentUser = user;
        
        if (user) {
            console.log('User signed in:', user.email);
            this.syncEnabled = true;
            this.startRealTimeSync();
            this.updateFirebaseUI();
            this.showSuccess(`Signed in as ${user.email} - Cloud sync enabled!`);
        } else {
            console.log('User signed out');
            this.syncEnabled = false;
            this.stopRealTimeSync();
            this.updateFirebaseUI();
        }
    }

    async signInWithGoogle() {
        if (!this.isInitialized) {
            this.showError('Firebase not initialized');
            return false;
        }

        try {
            this.showLoading('Signing in with Google...');
            
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.addScope('email');
            provider.addScope('profile');
            
            const result = await this.auth.signInWithPopup(provider);
            const user = result.user;
            
            console.log('Google sign-in successful:', user.email);
            
            // Optionally sync local data to cloud on first sign-in
            await this.syncLocalToCloud();
            
            this.hideLoading();
            return true;
            
        } catch (error) {
            console.error('Google sign-in failed:', error);
            this.hideLoading();
            
            if (error.code === 'auth/popup-closed-by-user') {
                this.showError('Sign-in cancelled');
            } else if (error.code === 'auth/popup-blocked') {
                this.showError('Popup blocked. Please allow popups and try again.');
            } else {
                this.showError('Sign-in failed. Please try again.');
            }
            return false;
        }
    }

    async signOut() {
        try {
            await this.auth.signOut();
            this.showSuccess('Signed out successfully');
        } catch (error) {
            console.error('Sign out failed:', error);
            this.showError('Failed to sign out');
        }
    }

    async syncLocalToCloud() {
        if (!this.currentUser || this.isSyncing) return;

        try {
            this.isSyncing = true;
            this.showLoading('Syncing local data to cloud...');
            
            const localEntries = getEntries(); // Your existing function
            
            if (localEntries.length === 0) {
                console.log('No local entries to sync');
                this.hideLoading();
                this.isSyncing = false;
                return;
            }

            const userDocRef = this.db.collection('users').doc(this.currentUser.uid);
            
            // Get existing cloud entries
            const doc = await userDocRef.get();
            const cloudEntries = doc.exists ? (doc.data().entries || []) : [];
            
            // Merge entries (avoid duplicates based on ID and timestamp)
            const allEntries = [...cloudEntries];
            
            localEntries.forEach(localEntry => {
                const exists = cloudEntries.find(cloudEntry => 
                    cloudEntry.id === localEntry.id || 
                    (cloudEntry.timestamp === localEntry.timestamp && cloudEntry.date === localEntry.date)
                );
                
                if (!exists) {
                    allEntries.push(localEntry);
                }
            });

            // Update cloud with merged data
            await userDocRef.set({
                entries: allEntries,
                lastSync: firebase.firestore.FieldValue.serverTimestamp(),
                email: this.currentUser.email
            }, { merge: true });

            // Update local storage with merged data
            localStorage.setItem('disciplin_entries', JSON.stringify(allEntries));
            
            console.log(`Synced ${allEntries.length} total entries to cloud`);
            this.showSuccess(`Synced ${localEntries.length} local entries to cloud`);
            
            // Refresh UI
            this.refreshAppData();
            
        } catch (error) {
            console.error('Failed to sync local data to cloud:', error);
            this.showError('Failed to sync data to cloud');
        } finally {
            this.hideLoading();
            this.isSyncing = false;
        }
    }

    async syncCloudToLocal() {
        if (!this.currentUser || this.isSyncing) return;

        try {
            this.isSyncing = true;
            this.showLoading('Syncing cloud data to local...');
            
            const userDocRef = this.db.collection('users').doc(this.currentUser.uid);
            const doc = await userDocRef.get();
            
            if (!doc.exists) {
                console.log('No cloud data found');
                this.hideLoading();
                this.isSyncing = false;
                return;
            }

            const cloudData = doc.data();
            const cloudEntries = cloudData.entries || [];
            
            if (cloudEntries.length === 0) {
                console.log('No cloud entries found');
                this.hideLoading();
                this.isSyncing = false;
                return;
            }

            // Update local storage
            localStorage.setItem('disciplin_entries', JSON.stringify(cloudEntries));
            
            console.log(`Synced ${cloudEntries.length} entries from cloud`);
            this.showSuccess(`Synced ${cloudEntries.length} entries from cloud`);
            
            // Refresh UI
            this.refreshAppData();
            
        } catch (error) {
            console.error('Failed to sync cloud data to local:', error);
            this.showError('Failed to sync data from cloud');
        } finally {
            this.hideLoading();
            this.isSyncing = false;
        }
    }

    async saveEntryToCloud(entry) {
        if (!this.currentUser) return;

        try {
            const userDocRef = this.db.collection('users').doc(this.currentUser.uid);
            
            // Add the new entry to the array
            await userDocRef.update({
                entries: firebase.firestore.FieldValue.arrayUnion(entry),
                lastSync: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            console.log('Entry saved to cloud:', entry.id);
            
        } catch (error) {
            // If document doesn't exist, create it
            if (error.code === 'not-found') {
                await userDocRef.set({
                    entries: [entry],
                    lastSync: firebase.firestore.FieldValue.serverTimestamp(),
                    email: this.currentUser.email
                });
                console.log('Created new user document and saved entry');
            } else {
                console.error('Failed to save entry to cloud:', error);
                throw error;
            }
        }
    }

    async deleteEntryFromCloud(entryId) {
        if (!this.currentUser) return;

        try {
            const userDocRef = this.db.collection('users').doc(this.currentUser.uid);
            const doc = await userDocRef.get();
            
            if (doc.exists) {
                const data = doc.data();
                const entries = data.entries || [];
                const updatedEntries = entries.filter(entry => entry.id !== entryId);
                
                await userDocRef.update({
                    entries: updatedEntries,
                    lastSync: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('Entry deleted from cloud:', entryId);
            }
        } catch (error) {
            console.error('Failed to delete entry from cloud:', error);
            throw error;
        }
    }

    startRealTimeSync() {
        if (!this.currentUser) return;

        const userDocRef = this.db.collection('users').doc(this.currentUser.uid);
        
        this.unsubscribeEntries = userDocRef.onSnapshot((doc) => {
            if (doc.exists && !this.isSyncing) {
                const cloudData = doc.data();
                const cloudEntries = cloudData.entries || [];
                const localEntries = getEntries();
                
                // Only update if cloud has more recent data
                if (cloudData.lastSync && cloudEntries.length !== localEntries.length) {
                    console.log('Cloud data changed, updating local data');
                    localStorage.setItem('disciplin_entries', JSON.stringify(cloudEntries));
                    this.refreshAppData();
                }
            }
        }, (error) => {
            console.error('Real-time sync error:', error);
        });
    }

    stopRealTimeSync() {
        if (this.unsubscribeEntries) {
            this.unsubscribeEntries();
            this.unsubscribeEntries = null;
        }
    }

    // UI Helper Methods
    updateFirebaseUI() {
        // Update existing backup section
        const backupSection = document.querySelector('.backup-section');
        if (!backupSection) return;

        // Add Firebase sync buttons to existing backup section
        const firebaseButtons = document.createElement('div');
        firebaseButtons.innerHTML = `
            <div style="border-top: 1px solid var(--border-color); margin: 20px 0; padding-top: 20px;">
                <h3 style="text-align: center; margin-bottom: 15px; color: var(--text-primary);"> Cloud Sync</h3>
                <div id="firebaseAuthSection">
                    ${this.currentUser ? `
                        <div style="text-align: center; margin-bottom: 15px;">
                            <p style="color: var(--text-secondary); font-size: 14px;">
                                Signed in as: <strong>${this.currentUser.email}</strong>
                            </p>
                            <p style="color: var(--success-text); font-size: 12px;">
                                ✅ Cloud sync enabled - Your data is automatically backed up
                            </p>
                        </div>
                        <div class="backup-buttons">
                            <button class="backup-btn" style="background: #4285f4; color: white;" onclick="firebaseManager.syncLocalToCloud()">
                                 Upload to Cloud
                            </button>
                            <button class="backup-btn" style="background: #34a853; color: white;" onclick="firebaseManager.syncCloudToLocal()">
                                 Download from Cloud
                            </button>
                        </div>
                        <div style="text-align: center; margin-top: 10px;">
                            <button class="backup-btn" style="background: #ea4335; color: white; width: 100%;" onclick="firebaseManager.signOut()">
                                Sign Out
                            </button>
                        </div>
                    ` : `
                        <div style="text-align: center; margin-bottom: 15px;">
                            <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 10px;">
                                Sign in with Google to sync your data across devices
                            </p>
                            <button class="backup-btn" style="background: #4285f4; color: white; width: 100%;" onclick="firebaseManager.signInWithGoogle()">
                                <span style="margin-right: 8px;"></span> Sign in with Google
                            </button>
                        </div>
                        <div style="background: var(--card-bg); border-radius: 8px; padding: 15px; margin-top: 15px;">
                            <h4 style="color: var(--text-primary); margin-bottom: 8px; font-size: 14px;">Benefits of Cloud Sync:</h4>
                            <ul style="color: var(--text-secondary); font-size: 12px; margin-left: 15px;">
                                <li>Access your data on any device</li>
                                <li>Automatic backup to Google's servers</li>
                                <li>Never lose your progress again</li>
                                <li>Real-time synchronization</li>
                            </ul>
                        </div>
                    `}
                </div>
                <div id="firebaseLoading" style="display: none; text-align: center; color: var(--text-secondary); font-size: 14px;">
                    <span>⏳ Loading...</span>
                </div>
            </div>
        `;

        // Remove existing Firebase section if it exists
        const existingSection = backupSection.querySelector('#firebaseAuthSection')?.parentElement;
        if (existingSection) {
            existingSection.remove();
        }

        // Add new Firebase section
        backupSection.appendChild(firebaseButtons);
    }

    refreshAppData() {
        // Refresh all app data displays
        if (typeof updateStats === 'function') updateStats();
        if (typeof loadHistory === 'function') loadHistory();
        if (typeof updateAchievements === 'function') updateAchievements();
        if (typeof updateWeeklyInsights === 'function') updateWeeklyInsights();
        if (typeof updateStreakNotification === 'function') updateStreakNotification();
    }

    showLoading(message) {
        const loadingElement = document.getElementById('firebaseLoading');
        if (loadingElement) {
            loadingElement.style.display = 'block';
            loadingElement.innerHTML = `<span>⏳ ${message}</span>`;
        }
    }

    hideLoading() {
        const loadingElement = document.getElementById('firebaseLoading');
        if (loadingElement) {
            loadingElement.style.display = 'none';
        }
    }

    showSuccess(message) {
        if (typeof showNotification === 'function') {
            showNotification(message, 'success');
        }
        console.log('✅', message);
    }

    showError(message) {
        if (typeof showNotification === 'function') {
            showNotification(message, 'error');
        }
        console.error('❌', message);
    }

    // Cleanup method
    destroy() {
        if (this.unsubscribeAuth) {
            this.unsubscribeAuth();
        }
        if (this.unsubscribeEntries) {
            this.unsubscribeEntries();
        }
    }
}

// Initialize Firebase Manager
let firebaseManager = null;

// Enhanced saveEntry function that also saves to cloud
async function saveEntryEnhanced(entry) {
    // Save to local storage (existing functionality)
    const entries = getEntries();
    entries.push(entry);
    localStorage.setItem('disciplin_entries', JSON.stringify(entries));
    
    // Also save to cloud if user is signed in
    if (firebaseManager && firebaseManager.syncEnabled) {
        try {
            await firebaseManager.saveEntryToCloud(entry);
        } catch (error) {
            console.error('Failed to save to cloud, but local save succeeded:', error);
            firebaseManager.showError('Failed to sync to cloud, but entry saved locally');
        }
    }
}

// Enhanced delete entry function
async function deleteEntryEnhanced(entryId) {
    // Delete from local storage (existing functionality)
    const entries = getEntries().filter(entry => entry.id !== entryId);
    localStorage.setItem('disciplin_entries', JSON.stringify(entries));
    
    // Also delete from cloud if user is signed in
    if (firebaseManager && firebaseManager.syncEnabled) {
        try {
            await firebaseManager.deleteEntryFromCloud(entryId);
        } catch (error) {
            console.error('Failed to delete from cloud, but local delete succeeded:', error);
            firebaseManager.showError('Failed to sync deletion to cloud, but entry deleted locally');
        }
    }
}

// Initialize Firebase when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Firebase Manager after a short delay to ensure other scripts are loaded
    setTimeout(() => {
        firebaseManager = new FirebaseManager();
    }, 1000);
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (firebaseManager) {
        firebaseManager.destroy();
    }
});

</script>
<script>


// Moving Text Banner JavaScript Controls

// Initialize the moving text banner
function initMovingTextBanner() {
    const container = document.querySelector('.moving-text-container');
    if (!container) return;

    // Add control buttons (optional)
    addControlButtons();
    
    // Add touch/click interaction
    addInteractionHandlers();
    
    // Add visibility observer for performance
    addVisibilityObserver();
}

// Add control buttons for speed adjustment
function addControlButtons() {
    const controlsHTML = `
        <div class="moving-text-controls" style="
            display: none;
            position: absolute;
            top: -35px;
            right: 0;
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 5px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 10;
        ">
            <button onclick="changeSpeed('slow')" style="
                background: #4CAF50;
                color: white;
                border: none;
                padding: 4px 8px;
                margin: 2px;
                border-radius: 8px;
                font-size: 10px;
                cursor: pointer;
            ">Slow</button>
            <button onclick="changeSpeed('normal')" style="
                background: #2196F3;
                color: white;
                border: none;
                padding: 4px 8px;
                margin: 2px;
                border-radius: 8px;
                font-size: 10px;
                cursor: pointer;
            ">Normal</button>
            <button onclick="changeSpeed('fast')" style="
                background: #FF9800;
                color: white;
                border: none;
                padding: 4px 8px;
                margin: 2px;
                border-radius: 8px;
                font-size: 10px;
                cursor: pointer;
            ">Fast</button>
            <button onclick="togglePause()" style="
                background: #f44336;
                color: white;
                border: none;
                padding: 4px 8px;
                margin: 2px;
                border-radius: 8px;
                font-size: 10px;
                cursor: pointer;
            " id="pauseBtn">Pause</button>
        </div>
    `;
    
    const container = document.querySelector('.moving-text-container');
    container.style.position = 'relative';
    container.insertAdjacentHTML('afterbegin', controlsHTML);
}

// Speed control functions
function changeSpeed(speed) {
    const container = document.querySelector('.moving-text-container');
    
    // Remove existing speed classes
    container.classList.remove('moving-text-slow', 'moving-text-fast');
    
    // Add new speed class
    if (speed === 'slow') {
        container.classList.add('moving-text-slow');
    } else if (speed === 'fast') {
        container.classList.add('moving-text-fast');
    }
    // 'normal' speed is the default, no class needed
}

// Pause/Resume functionality
let isPaused = false;
function togglePause() {
    const container = document.querySelector('.moving-text-container');
    const pauseBtn = document.getElementById('pauseBtn');
    
    if (isPaused) {
        container.classList.remove('moving-text-pause');
        pauseBtn.textContent = 'Pause';
        isPaused = false;
    } else {
        container.classList.add('moving-text-pause');
        pauseBtn.textContent = 'Play';
        isPaused = true;
    }
}

// Add interaction handlers
function addInteractionHandlers() {
    const container = document.querySelector('.moving-text-container');
    
    // Show controls on hover
    container.addEventListener('mouseenter', function() {
        const controls = this.querySelector('.moving-text-controls');
        if (controls) {
            controls.style.display = 'block';
        }
    });
    
    container.addEventListener('mouseleave', function() {
        const controls = this.querySelector('.moving-text-controls');
        if (controls) {
            setTimeout(() => {
                if (!controls.matches(':hover')) {
                    controls.style.display = 'none';
                }
            }, 500);
        }
    });
    
    // Double-click to pause/resume
    container.addEventListener('dblclick', function() {
        togglePause();
    });
}

// Visibility observer for performance optimization
function addVisibilityObserver() {
    const container = document.querySelector('.moving-text-container');
    
    if ('IntersectionObserver' in window) {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const content = entry.target.querySelector('.moving-text-content');
                if (entry.isIntersecting) {
                    content.style.animationPlayState = 'running';
                } else {
                    content.style.animationPlayState = 'paused';
                }
            });
        }, {
            threshold: 0.1
        });
        
        observer.observe(container);
    }
}

// Auto-initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Small delay to ensure all styles are loaded
    setTimeout(initMovingTextBanner, 500);
});

// Update messages dynamically (optional feature)
function updateMovingTexts(newTexts) {
    const content = document.querySelector('.moving-text-content');
    if (!content || !Array.isArray(newTexts)) return;
    
    const icons = [
        'fas fa-wifi',
        'fas fa-download', 
        'fas fa-cloud',
        'fas fa-lightbulb',
        'fas fa-exclamation-triangle',
        'fas fa-comments'
    ];
    
    // Create new HTML
    let newHTML = '';
    newTexts.forEach((text, index) => {
        const iconClass = icons[index % icons.length];
        newHTML += `
            <div class="moving-text-item">
                <i class="${iconClass}"></i>
                <span>${text}</span>
            </div>
        `;
    });
    
    // Duplicate for seamless loop
    newHTML += newHTML;
    
    content.innerHTML = newHTML;
}

// Example usage of updateMovingTexts:
// updateMovingTexts([
//     "New message 1",
//     "New message 2",
//     "New message 3"
// ]);
</script>




</body>
</html>
                
